<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Claw ğŸ¦</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
    *::-webkit-scrollbar { display: none; }
    html, body {
        width: 100%;
        height: 100%;
        background: transparent;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
    }
    .container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    /* ===== æµä½“çƒ 67px ===== */
    .pet-wrapper {
        width: 67px;
        height: 67px;
        position: relative;
        cursor: grab;
        will-change: transform;
    }
    .pet-wrapper:active { cursor: grabbing; }

    .inner-fluid {
        position: absolute;
        top: 3px; left: 3px; right: 3px; bottom: 3px;
        border-radius: 50%;
        overflow: hidden;
        z-index: 1;
        background: linear-gradient(135deg, #ffb3b3, #fed6e3);
        transition: filter 0.4s ease;
    }
    .fluid-blob {
        position: absolute;
        width: 130%; height: 130%; top: -15%; left: -15%;
        background:
            radial-gradient(circle at 30% 30%, rgba(235,87,87,0.85), transparent 40%),
            radial-gradient(circle at 70% 65%, rgba(255,154,108,0.8), transparent 40%);
        animation: fluid-spin 8s linear infinite;
    }
    .fluid-blob-2 {
        position: absolute;
        width: 110%; height: 110%; top: -5%; left: -5%;
        background:
            radial-gradient(circle at 60% 30%, rgba(255,200,150,0.4), transparent 35%),
            radial-gradient(circle at 35% 70%, rgba(220,60,60,0.3), transparent 35%);
        animation: fluid-spin-r 12s linear infinite;
    }

    .glass-shell {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        border-radius: 50%; z-index: 2;
        /* ğŸ”® å‡çº§ç‰ç’ƒæ„Ÿï¼šæ›´å¼ºçš„æ¸å˜é«˜å…‰ */
        background: 
            radial-gradient(circle at 25% 25%, rgba(255,255,255,0.35), transparent 30%),
            radial-gradient(circle at 80% 80%, rgba(255,255,255,0.08), transparent 40%),
            radial-gradient(circle at 50% 50%, rgba(255,255,255,0.03), transparent);
        box-shadow:
            /* å†…éƒ¨é«˜å…‰æ›´å¼º */
            inset -3px -3px 12px rgba(255,255,255,0.15),
            inset 3px 3px 12px rgba(255,255,255,0.45),
            /* å¤–éƒ¨å…‰æ™• */
            0px 4px 12px rgba(220,80,80,0.15),
            0px 0px 20px rgba(255,255,255,0.1);
        backdrop-filter: blur(2px);
        border: 1.5px solid rgba(255,255,255,0.4);
        /* ğŸ¨ è¿‡æ¸¡ä¹Ÿè¦å¹³æ»‘ï¼ˆ1ç§’ï¼‰ */
        transition: box-shadow 1.0s cubic-bezier(0.4, 0.0, 0.2, 1), border 1.0s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    .glass-shell::before {
        content: '';
        /* ğŸŒŸ ä¸»é«˜å…‰æ›´å¤§æ›´äº® */
        position: absolute; top: 10%; left: 15%; width: 35%; height: 18%;
        border-radius: 50%; 
        background: 
            radial-gradient(ellipse at center, rgba(255,255,255,0.8), rgba(255,255,255,0.3) 60%, transparent);
        filter: blur(2px); 
        transform: rotate(-40deg);
        /* é«˜å…‰ä¹Ÿè¦è¿‡æ¸¡ï¼ˆ1ç§’ï¼‰ */
        transition: opacity 1.0s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    /* ğŸ”® æ–°å¢ï¿½ï¿½ï¿½ç¬¬äºŒé«˜å…‰ */
    .glass-shell::after {
        content: '';
        position: absolute; bottom: 20%; right: 18%; width: 20%; height: 12%;
        border-radius: 50%;
        background: radial-gradient(ellipse at center, rgba(255,255,255,0.4), transparent 70%);
        filter: blur(2px);
        transform: rotate(25deg);
        /* é«˜å…‰ä¹Ÿè¦è¿‡æ¸¡ï¼ˆ1ç§’ï¼‰ */
        transition: opacity 1.0s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    /* èƒ¶å›Šçœ¼ç› â€” å¤§å æ¯” */
    .eyes-container {
        position: absolute; z-index: 3;
        top: 16%; left: 10%; width: 80%; height: 50%;
        display: flex; justify-content: center; align-items: center;
        gap: 12px;
        pointer-events: none;
        overflow: visible;
    }
    .eye {
        width: 11px; height: 19px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 0 8px rgba(255,255,255,0.9), 0 0 16px rgba(255,255,255,0.4);
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform-origin: center center;
    }

    /* è…®çº¢ */
    .blush {
        position: absolute; z-index: 3;
        width: 14px; height: 8px; border-radius: 50%;
        background: rgba(255,130,130,0.25); filter: blur(3px);
        pointer-events: none; 
        /* ğŸ¨ 2ç§’å¹³æ»‘è¿‡æ¸¡ */
        transition: background 2.0s cubic-bezier(0.33, 0.0, 0.2, 1), opacity 0.6s ease; 
        opacity: 0.8;
    }
    .blush-l { top: 58%; left: 8%; }
    .blush-r { top: 58%; right: 8%; }

    /* æ°”æ³¡è£…é¥° */
    .bub {
        position: absolute; border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), rgba(255,255,255,0.06));
        border: 1px solid rgba(255,255,255,0.12);
        z-index: 0; opacity: 0; pointer-events: none;
    }
    .bub-1 { width: 5px; height: 5px; left: -5px; top: 60%; animation: bub 5s ease-in infinite 0s; }
    .bub-2 { width: 3px; height: 3px; right: -4px; top: 40%; animation: bub 6.5s ease-in infinite 2s; }

    .particles {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 10;
    }

    /* ===== å›¾æ ‡å·¥å…·æ  ===== */
    .toolbar {
        position: absolute;
        top: calc(50% + 46px);
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
        z-index: 20;
    }
    .container:hover .toolbar {
        opacity: 1;
        pointer-events: auto;
    }

    .tool-icon {
        width: 26px; height: 26px;
        border-radius: 50%;
        background: rgba(255,255,255,0.85);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .tool-icon svg {
        width: 13px; height: 13px;
        stroke: #666; fill: none;
        stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
    }
    .tool-icon:hover {
        transform: scale(1.2);
        box-shadow: 0 3px 12px rgba(0,0,0,0.2);
    }
    .tool-icon:active { transform: scale(0.9); }

    /* æ¨¡å‹åˆ‡æ¢æŒ‰é’® */
    .model-switch-btn {
        min-width: 26px;
        padding: 0 4px;
        border-radius: 13px;
    }
    .model-switch-btn:hover {
        background: rgba(255,255,255,0.95);
    }
    .tool-icon.active {
        background: rgba(255,255,255,1);
        box-shadow: 0 0 8px rgba(255,255,255,0.5), 0 2px 8px rgba(0,0,0,0.15);
    }

    /* è¾“å…¥æ¡ */
    .input-bar {
        position: absolute;
        top: calc(50% + 78px);
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 4px;
        opacity: 0;
        pointer-events: none;
        transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        z-index: 20;
    }
    .input-bar.show {
        opacity: 1;
        pointer-events: auto;
    }
    .input-bar input {
        width: 160px;
        padding: 4px 10px;
        border: none;
        border-radius: 12px;
        background: rgba(255,255,255,0.85);
        font-size: 11px;
        outline: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .input-bar button {
        padding: 4px 8px;
        border: none;
        border-radius: 12px;
        background: rgba(255,255,255,0.85);
        font-size: 11px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    @keyframes fluid-spin {
        0% { transform: rotate(0deg) scale(1); }
        50% { transform: rotate(180deg) scale(1.08); }
        100% { transform: rotate(360deg) scale(1); }
    }
    @keyframes fluid-spin-r {
        0% { transform: rotate(360deg) scale(1.05); }
        50% { transform: rotate(180deg) scale(0.95); }
        100% { transform: rotate(0deg) scale(1.05); }
    }
    @keyframes bub {
        0% { opacity: 0; transform: translateY(0) scale(0.3); }
        15% { opacity: 0.5; }
        100% { opacity: 0; transform: translateY(-30px) translateX(5px) scale(1); }
    }
    @keyframes squish {
        0% { transform: scale(1, 1); }
        25% { transform: scale(1.15, 0.85); }
        50% { transform: scale(0.9, 1.1); }
        75% { transform: scale(1.05, 0.95); }
        100% { transform: scale(1, 1); }
    }
</style>
</head>
<body>
<div class="container">
    <div class="pet-wrapper" id="pet">
        <div class="inner-fluid" id="fluid">
            <div class="fluid-blob" id="blob1"></div>
            <div class="fluid-blob-2" id="blob2"></div>
        </div>
        <div class="glass-shell"></div>
        <div class="eyes-container" id="eyes">
            <div class="eye" id="eyeL"></div>
            <div class="eye" id="eyeR"></div>
        </div>
        <div class="blush blush-l" id="blushL"></div>
        <div class="blush blush-r" id="blushR"></div>
        <div class="bub bub-1"></div>
        <div class="bub bub-2"></div>
        <div class="particles" id="particles"></div>
    </div>

    <!-- å›¾æ ‡å·¥å…·æ  -->
    <div class="toolbar" id="toolbar">
        <div class="tool-icon" id="btnChat" title="å‘æ¶ˆæ¯" onclick="toggleInput()">
            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        </div>
        <div class="tool-icon" id="btnVoice" title="è¯­éŸ³" onclick="toggleVoice()">
            <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
        </div>
        <div class="tool-icon" id="btnScreenshot" title="æˆªå›¾" onclick="screenshot()">
            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/></svg>
        </div>
        <div class="tool-icon model-switch-btn" id="btnModelSwitch" title="åˆ‡æ¢æ¨¡å‹" onclick="cycleModel()">
            <span id="modelBadge" style="font-size:9px;font-weight:700;color:#666;user-select:none;">OP</span>
        </div>
    </div>

    <!-- è¾“å…¥æ¡ -->
    <div class="input-bar" id="inputBar">
        <input type="text" id="input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." onkeypress="if(event.key==='Enter')send()">
        <button onclick="send()">â†‘</button>
    </div>
</div>

<script>
let ipcRenderer;
try { ipcRenderer = require('electron').ipcRenderer; } catch(e) {}

const pet = document.getElementById('pet');
const eyeL = document.getElementById('eyeL');
const eyeR = document.getElementById('eyeR');
const fluid = document.getElementById('fluid');
const blob1 = document.getElementById('blob1');
const blob2 = document.getElementById('blob2');
let _moodTimer = null;
const blushL = document.getElementById('blushL');
const blushR = document.getElementById('blushR');
const particlesEl = document.getElementById('particles');
const inputBar = document.getElementById('inputBar');
const inputEl = document.getElementById('input');
const btnVoice = document.getElementById('btnVoice');

let voiceOn = true;
let isConnected = false;

// ===== 60fps åŠ¨ç”» =====
let t = 0, squishing = false, targetScale = 1, curScale = 1, breathExtra = 0;

function loop() {
    t += 0.016;
    curScale += (targetScale - curScale) * 0.08;
    const floatY = Math.sin(t * 1.3) * 5;
    const floatR = Math.sin(t * 0.9) * 0.4;
    const breathScale = 1 + Math.sin(t * 2) * 0.012;
    const bounce = breathExtra > 0 ? Math.sin(t * 12) * breathExtra : 0;
    if (!squishing) {
        pet.style.transform = `translateY(${floatY + bounce}px) rotate(${floatR}deg) scale(${curScale * breathScale})`;
    }
    requestAnimationFrame(loop);
}
loop();

// ===== çœ¼ç›è¡¨æƒ… =====
function setEyes(L, R) {
    const d = { w:11, h:19, br:'6px', tx:0, ty:0, sx:1, sy:1, rot:0 };
    const l = { ...d, ...L };
    const r = R ? { ...d, ...R } : { ...l };
    eyeL.style.width = l.w+'px'; eyeL.style.height = l.h+'px'; eyeL.style.borderRadius = l.br;
    eyeL.style.transform = `translate(${l.tx}px,${l.ty}px) scale(${l.sx},${l.sy}) rotate(${l.rot}deg)`;
    eyeR.style.width = r.w+'px'; eyeR.style.height = r.h+'px'; eyeR.style.borderRadius = r.br;
    eyeR.style.transform = `translate(${r.tx}px,${r.ty}px) scale(${r.sx},${r.sy}) rotate(${r.rot}deg)`;
}

const EXPR = {
    normal:     () => setEyes({ w:11, h:19, br:'6px' }),
    blink:      () => setEyes({ w:12, h:3, br:'3px' }),
    halfBlink:  () => setEyes({ w:11, h:10, br:'5px' }),
    happy:      () => setEyes({ w:13, h:7, br:'7px 7px 3px 3px', ty:1 }),
    superHappy: () => setEyes({ w:15, h:5, br:'8px 8px 3px 3px', ty:1, sx:1.1 }),
    giggle:     () => setEyes(
        { w:13, h:7, br:'7px 7px 3px 3px', ty:1, rot:-8 },
        { w:13, h:7, br:'7px 7px 3px 3px', ty:1, rot:8 }
    ),
    surprised:  () => setEyes({ w:13, h:21, br:'7px' }),
    curious:    () => setEyes(
        { w:9, h:16, br:'5px', ty:-1 },
        { w:13, h:21, br:'7px', ty:-1 }
    ),
    wow:        () => setEyes({ w:16, h:16, br:'8px' }),
    thinking:   () => setEyes({ w:10, h:17, br:'5px', ty:-3 }),
    lookLeft:   () => setEyes({ w:11, h:19, br:'6px', tx:-4 }),
    lookRight:  () => setEyes({ w:11, h:19, br:'6px', tx:4 }),
    hmm:        () => setEyes(
        { w:11, h:16, br:'5px', ty:-1, rot:8 },
        { w:9, h:13, br:'5px', ty:0, rot:-8 }
    ),
    sleepy:     () => setEyes({ w:12, h:4, br:'4px', ty:2 }),
    drowsy:     () => setEyes({ w:11, h:10, br:'5px', ty:1 }),
    sparkle:    () => setEyes({ w:12, h:12, br:'3px', rot:45 }),
    sad:        () => setEyes({ w:10, h:16, br:'5px', ty:3, sy:0.9 }),
    wink:       () => setEyes(
        { w:13, h:7, br:'7px 7px 3px 3px', ty:1 },
        { w:11, h:19, br:'6px' }
    ),
    winkR:      () => setEyes(
        { w:11, h:19, br:'6px' },
        { w:13, h:7, br:'7px 7px 3px 3px', ty:1 }
    ),
    talking:    () => setEyes({ w:10, h:17, br:'5px' }),
    talkBig:    () => setEyes({ w:12, h:20, br:'6px' }),
};

// ===== é¼ æ ‡è·Ÿéš =====
let mouseTracking = true;
document.addEventListener('mousemove', (e) => {
    if (!mouseTracking) return;
    const rect = pet.getBoundingClientRect();
    const cx = rect.left + rect.width / 2, cy = rect.top + rect.height / 2;
    const dx = Math.max(-2, Math.min(2, (e.clientX - cx) / window.innerWidth * 6));
    const dy = Math.max(-2, Math.min(2, (e.clientY - cy) / window.innerHeight * 6));
    eyeL.style.transform = `translate(${dx}px,${dy}px)`;
    eyeR.style.transform = `translate(${dx}px,${dy}px)`;
});

// ===== çœ¨çœ¼ =====
function doBlink() {
    if (currentMood === 'sleepy' || currentMood === 'happy') { schedBlink(); return; }
    mouseTracking = false;
    EXPR.blink();
    setTimeout(() => {
        if (Math.random() < 0.2) {
            EXPR.halfBlink();
            setTimeout(() => { EXPR.blink(); setTimeout(() => { applyMoodEyes(); mouseTracking = true; }, 80); }, 120);
        } else { applyMoodEyes(); mouseTracking = true; }
    }, 70 + Math.random() * 40);
    schedBlink();
}
function schedBlink() { setTimeout(doBlink, 2000 + Math.random() * 4000); }
schedBlink();

// ===== ç‚¹å‡» =====
let isDrag = false, startX, startY, dragOffsetX, dragOffsetY, clickCount = 0, clickTimer = null;

pet.addEventListener('mousedown', e => { 
    isDrag = false; 
    startX = e.screenX; 
    startY = e.screenY; 
    // è®°å½•é¼ æ ‡åœ¨çª—å£å†…çš„ç›¸å¯¹ä½ç½®ï¼Œé¿å…æ‹–åŠ¨æ—¶è·³è·ƒ
    dragOffsetX = e.clientX;
    dragOffsetY = e.clientY;
});
document.addEventListener('mousemove', e => {
    if (startX !== undefined) {
        if (Math.abs(e.screenX - startX) > 3 || Math.abs(e.screenY - startY) > 3) isDrag = true;
    }
    if (isDrag && ipcRenderer) {
        // ç”¨é¼ æ ‡ä½ç½®å‡å»ç›¸å¯¹åç§»ï¼Œç²¾ç¡®å®šä½çª—å£
        ipcRenderer.send('drag-pet', { 
            x: e.screenX, 
            y: e.screenY,
            offsetX: dragOffsetX,
            offsetY: dragOffsetY
        });
    }
});
document.addEventListener('mouseup', () => { setTimeout(() => { isDrag = false; startX = undefined; }, 30); });

pet.addEventListener('click', () => {
    if (isDrag) return;
    clickCount++;
    clearTimeout(clickTimer);
    squishing = true;
    
    // ğŸ¨ å¢å¼ºç‚¹å‡»åŠ¨ç”»ï¼šå¸¦é¢œè‰²è„‰å†²
    pet.style.animation = 'squish 0.35s cubic-bezier(0.34, 1.56, 0.64, 1)';
    // ç‚¹å‡»æ—¶çƒä½“ç¨å¾®å˜äº®
    pet.style.filter = 'brightness(1.15)';
    
    setTimeout(() => { 
        pet.style.animation = ''; 
        pet.style.filter = '';
        squishing = false; 
    }, 350);
    
    spawnParticles();
    mouseTracking = false;

    if (clickCount >= 3) {
        // ğŸ’– ä¸‰å‡»è¶…å¼€å¿ƒæ¨¡å¼
        EXPR.superHappy();
        blushL.style.background = 'rgba(255,100,100,0.6)';
        blushR.style.background = 'rgba(255,100,100,0.6)';
        targetScale = 1.1;
        // çœ¼ç›ä¹Ÿè¦è·Ÿç€æ”¾å¤§
        eyeL.style.transform = 'scale(1.15)';
        eyeR.style.transform = 'scale(1.15)';
        
        // ä¸‰å‡»æ‰“å¼€å†å²æ¶ˆæ¯
        if (ipcRenderer) ipcRenderer.invoke('show-history');
        setTimeout(() => { 
            resetClick(); 
            clickCount = 0;
            eyeL.style.transform = '';
            eyeR.style.transform = '';
        }, 1200);
    } else {
        // éšæœºè¡¨æƒ… + çœ¼ç›åŠ¨ç”»
        const rr = ['happy','wink','winkR','surprised','curious','giggle','sparkle','wow'];
        EXPR[rr[Math.floor(Math.random()*rr.length)]]();
        clickTimer = setTimeout(() => { resetClick(); clickCount = 0; }, 800);
    }
});

function resetClick() {
    applyMoodEyes();
    blushL.style.background = ''; blushR.style.background = '';
    targetScale = MOODS[currentMood]?.scale || 1;
    mouseTracking = true;
}

// ğŸ¨ Hover äº¤äº’åŠ¨ç”»
pet.addEventListener('mouseenter', () => {
    if (currentMood === 'sleepy' || currentMood === 'offline') return;
    // é¼ æ ‡è¿›å…¥æ—¶çœ¼ç›å¾®å¾®çå¤§
    eyeL.style.transform = 'scale(1.08)';
    eyeR.style.transform = 'scale(1.08)';
    // çƒä½“å¾®å¾®å˜äº®
    pet.style.filter = 'brightness(1.05)';
});

pet.addEventListener('mouseleave', () => {
    eyeL.style.transform = '';
    eyeR.style.transform = '';
    pet.style.filter = '';
});

function spawnParticles() {
    const colors = ['#ff6b6b','#ffa07a','#ffb347','#ff69b4','#fff','#ffd700'];
    for (let i = 0; i < 8; i++) {
        const p = document.createElement('div');
        const sz = 2 + Math.random() * 3;
        const a = (Math.PI * 2 / 8) * i + Math.random() * 0.4;
        const dist = 15 + Math.random() * 25;
        p.style.cssText = `position:absolute;border-radius:50%;pointer-events:none;
            width:${sz}px;height:${sz}px;
            background:${colors[Math.floor(Math.random()*colors.length)]};
            left:50%;top:50%;opacity:1;
            transition:transform 0.4s ease-out,opacity 0.4s ease-out;`;
        particlesEl.appendChild(p);
        requestAnimationFrame(() => {
            p.style.transform = `translate(${Math.cos(a)*dist}px,${Math.sin(a)*dist}px)`;
            p.style.opacity = '0';
        });
        setTimeout(() => p.remove(), 450);
    }
}

// ===== æƒ…ç»ª =====
const MOODS = {
    // ğŸ”® å‡çº§é…è‰²ï¼šæ›´é²œæ˜çš„å¯¹æ¯”ã€æ›´ä¸°å¯Œçš„ç‰ç’ƒæ¸å˜
    offline:   { 
        fluid:'linear-gradient(135deg,#a8a8a8,#c5c5c5)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(120,120,120,0.7),transparent 45%),radial-gradient(circle at 70% 65%,rgba(145,145,145,0.6),transparent 45%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(160,160,160,0.35),transparent 40%),radial-gradient(circle at 35% 70%,rgba(110,110,110,0.25),transparent 40%)', 
        eyes:'sleepy', scale:0.93, bounce:0, speed:'20s' 
    },
    idle:      { 
        fluid:'linear-gradient(135deg,#ffb3ba,#ffe5e9)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(255,90,90,0.9),transparent 45%),radial-gradient(circle at 70% 65%,rgba(255,140,100,0.85),transparent 45%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(255,190,140,0.45),transparent 40%),radial-gradient(circle at 35% 70%,rgba(235,70,70,0.35),transparent 40%)', 
        eyes:'normal', scale:1, bounce:0, speed:'8s' 
    },
    happy:     { 
        fluid:'linear-gradient(135deg,#ffdd99,#ffe0cc)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(255,180,50,0.95),transparent 45%),radial-gradient(circle at 70% 65%,rgba(255,110,110,0.9),transparent 45%)', 
        b2:'radial-gradient(circle at 50% 50%,rgba(255,220,0,0.5),transparent 45%),radial-gradient(circle at 35% 70%,rgba(255,130,0,0.4),transparent 40%)', 
        eyes:'happy', scale:1.05, bounce:0.02, speed:'5s' 
    },
    talking:   { 
        fluid:'linear-gradient(135deg,#ffaab3,#ffd5e0)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(255,95,95,0.95),transparent 45%),radial-gradient(circle at 70% 65%,rgba(255,125,85,0.9),transparent 45%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(255,170,120,0.55),transparent 40%),radial-gradient(circle at 35% 70%,rgba(240,80,80,0.4),transparent 40%)', 
        eyes:'talking', scale:1, bounce:0.015, speed:'4s' 
    },
    thinking:  { 
        fluid:'linear-gradient(135deg,#b8d8ff,#e8ddff)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(90,140,245,0.9),transparent 45%),radial-gradient(circle at 70% 65%,rgba(140,90,230,0.85),transparent 45%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(170,190,255,0.5),transparent 40%),radial-gradient(circle at 35% 70%,rgba(110,70,210,0.4),transparent 40%)', 
        eyes:'thinking', scale:1, bounce:0, speed:'12s' 
    },
    sleepy:    { 
        fluid:'linear-gradient(135deg,#d0bebe,#e5d8d8)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(170,130,130,0.7),transparent 45%),radial-gradient(circle at 70% 65%,rgba(190,150,130,0.6),transparent 45%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(195,170,160,0.4),transparent 40%),radial-gradient(circle at 35% 70%,rgba(160,120,120,0.3),transparent 40%)', 
        eyes:'sleepy', scale:0.97, bounce:0, speed:'16s' 
    },
    surprised: { 
        fluid:'linear-gradient(135deg,#ffe8b0,#ffddc8)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(255,195,40,0.95),transparent 45%),radial-gradient(circle at 70% 65%,rgba(255,115,75,0.9),transparent 45%)', 
        b2:'radial-gradient(circle at 50% 50%,rgba(255,225,90,0.5),transparent 45%),radial-gradient(circle at 35% 70%,rgba(255,145,45,0.4),transparent 40%)', 
        eyes:'surprised', scale:1.06, bounce:0, speed:'6s' 
    },
};

let currentMood = 'idle', talkInterval = null;

function applyMoodEyes() {
    const m = MOODS[currentMood];
    if (m && EXPR[m.eyes]) EXPR[m.eyes]();
}

function setMood(mood) {
    const map = { normal:'idle', busy:'talking', excited:'happy' };
    mood = map[mood] || mood;
    if (!MOODS[mood]) mood = 'idle';
    const m = MOODS[mood];

    if (mood !== currentMood) {
        // æ‰“æ–­ä¸Šä¸€æ¬¡æœªå®Œæˆçš„è¿‡æ¸¡
        if (_moodTimer) { clearTimeout(_moodTimer); _moodTimer = null; }

        // filter æŸ”å…‰è¿‡æ¸¡ï¼šäº®èµ· â†’ æ¢è‰² â†’ æ·¡å‡ºï¼Œé®æ© gradient è·³å˜
        fluid.style.transition = 'filter 0.35s ease-in';
        fluid.style.filter = 'brightness(1.6) blur(2px)';

        _moodTimer = setTimeout(() => {
            // å³°å€¼æ—¶ç¬é—´æ¢è‰²ï¼ˆäººçœ¼åœ¨é«˜äº®åº¦ä¸‹æ„ŸçŸ¥ä¸åˆ°è·³å˜ï¼‰
            fluid.style.background = m.fluid;
            blob1.style.background = m.b1;
            blob2.style.background = m.b2;
            blob1.style.animation = 'fluid-spin ' + m.speed + ' linear infinite';

            // æ·¡å‡ºå›æ­£å¸¸
            fluid.style.transition = 'filter 0.5s ease-out';
            fluid.style.filter = 'brightness(1) blur(0px)';

            _moodTimer = setTimeout(() => {
                fluid.style.transition = '';
                fluid.style.filter = '';
                _moodTimer = null;
            }, 550);
        }, 350);
    }

    currentMood = mood;
    blob1.style.animationDuration = m.speed;

    if (mood === 'sleepy') {
        blob1.style.transition = 'opacity 1.5s ease';
        blob1.style.opacity = '0.6';
    } else {
        blob1.style.transition = 'opacity 1.0s ease';
        blob1.style.opacity = '1';
    }

    targetScale = m.scale; breathExtra = m.bounce;
    mouseTracking = (mood !== 'sleepy' && mood !== 'happy');
    if (talkInterval) { clearInterval(talkInterval); talkInterval = null; }
    if (mood === 'talking') {
        let tog = false;
        talkInterval = setInterval(() => { tog=!tog; tog ? EXPR.talkBig() : EXPR.talking(); }, 250);
    } else { applyMoodEyes(); }

    if (mood === 'happy') {
        blushL.style.transition = 'background 0.8s ease, opacity 0.6s ease';
        blushR.style.transition = 'background 0.8s ease, opacity 0.6s ease';
        blushL.style.background = 'rgba(255,120,120,0.4)';
        blushR.style.background = 'rgba(255,120,120,0.4)';
    } else {
        blushL.style.transition = 'background 0.6s ease, opacity 0.4s ease';
        blushR.style.transition = 'background 0.6s ease, opacity 0.4s ease';
        blushL.style.background = '';
        blushR.style.background = '';
    }
}

// ===== å¾…æœºå¾®è¡¨æƒ… =====
const idleActs = [
    // å·¦å³å¼ æœ›
    () => { EXPR.lookLeft(); setTimeout(() => { EXPR.lookRight(); setTimeout(() => EXPR.normal(), 500); }, 500); },
    // å¥½å¥‡æ­ªå¤´
    () => { EXPR.curious(); setTimeout(() => EXPR.normal(), 800); },
    // å¼€å¿ƒå¼¯çœ¼
    () => { EXPR.happy(); setTimeout(() => EXPR.normal(), 1000); },
    // æ‰“ç›¹ â†’ æƒŠé†’
    () => { EXPR.drowsy(); setTimeout(() => { EXPR.sleepy(); setTimeout(() => { EXPR.surprised(); setTimeout(() => EXPR.normal(), 300); }, 600); }, 400); },
    // å·¦çœ¼çœ¨
    () => { EXPR.wink(); setTimeout(() => EXPR.normal(), 700); },
    // è‹¥æœ‰æ‰€æ€
    () => { EXPR.hmm(); setTimeout(() => EXPR.normal(), 800); },
    // æ˜Ÿæ˜Ÿçœ¼
    () => { EXPR.sparkle(); setTimeout(() => EXPR.normal(), 500); },
    // å³çœ¼çœ¨
    () => { EXPR.winkR(); setTimeout(() => EXPR.normal(), 700); },
    // å¤§æƒŠ â†’ å¥½å¥‡ â†’ æ­£å¸¸
    () => { EXPR.wow(); setTimeout(() => { EXPR.curious(); setTimeout(() => EXPR.normal(), 600); }, 500); },
    // æŠ–ä¸€æŠ–ï¼ˆç¼©æ”¾æŠ–åŠ¨ï¼‰
    () => {
        const origScale = targetScale;
        targetScale = 0.92; setTimeout(() => { targetScale = 1.06; setTimeout(() => { targetScale = origScale; }, 150); }, 150);
    },
    // å®³ç¾è„¸çº¢
    () => {
        EXPR.happy();
        blushL.style.transition = 'background 0.3s ease'; blushR.style.transition = 'background 0.3s ease';
        blushL.style.background = 'rgba(255,100,100,0.5)'; blushR.style.background = 'rgba(255,100,100,0.5)';
        setTimeout(() => {
            EXPR.normal();
            blushL.style.transition = 'background 0.8s ease'; blushR.style.transition = 'background 0.8s ease';
            blushL.style.background = ''; blushR.style.background = '';
        }, 1200);
    },
    // å·¦å³å¿«é€Ÿçœ‹
    () => {
        EXPR.lookLeft();
        setTimeout(() => EXPR.lookRight(), 200);
        setTimeout(() => EXPR.lookLeft(), 400);
        setTimeout(() => EXPR.lookRight(), 600);
        setTimeout(() => EXPR.normal(), 800);
    },
    // å‚²å¨‡é—­çœ¼
    () => { EXPR.blink(); setTimeout(() => { EXPR.hmm(); setTimeout(() => EXPR.normal(), 600); }, 300); },
    // ä¼¸æ‡’è…°ï¼ˆæ…¢æ…¢æ”¾å¤§å†ç¼©å›ï¼‰
    () => {
        const origScale = targetScale;
        targetScale = 1.08;
        EXPR.sleepy();
        setTimeout(() => { targetScale = origScale; EXPR.drowsy(); setTimeout(() => { EXPR.surprised(); setTimeout(() => EXPR.normal(), 300); }, 400); }, 1000);
    },
    // æ€è€ƒ â†’ é—ªäº® â†’ å¼€å¿ƒï¼ˆçµæ„Ÿï¼ï¼‰
    () => {
        EXPR.thinking();
        setTimeout(() => { EXPR.sparkle(); setTimeout(() => { EXPR.giggle(); setTimeout(() => EXPR.normal(), 500); }, 400); }, 800);
    },
    // å¾®å¾®æ­ªå¤´
    () => {
        EXPR.curious();
        setTimeout(() => { EXPR.hmm(); setTimeout(() => EXPR.normal(), 600); }, 500);
    },
    // è¿ç»­çœ¨çœ¼
    () => {
        EXPR.blink();
        setTimeout(() => EXPR.normal(), 80);
        setTimeout(() => EXPR.blink(), 250);
        setTimeout(() => EXPR.normal(), 330);
        setTimeout(() => EXPR.blink(), 500);
        setTimeout(() => EXPR.normal(), 580);
    },
    // éš¾è¿‡ â†’ æŒ¯ä½œ
    () => {
        EXPR.sad();
        setTimeout(() => { EXPR.drowsy(); setTimeout(() => { EXPR.normal(); setTimeout(() => EXPR.happy(), 200); setTimeout(() => EXPR.normal(), 700); }, 400); }, 600);
    },
];
setInterval(() => {
    if (currentMood !== 'idle' || !mouseTracking) return;
    if (Math.random() < 0.3) {
        mouseTracking = false;
        idleActs[Math.floor(Math.random() * idleActs.length)]();
        setTimeout(() => { mouseTracking = true; }, 1500);
    }
}, 4000);

// ===== å·¥å…·æ  =====
function toggleInput() {
    inputBar.classList.toggle('show');
    if (inputBar.classList.contains('show')) inputEl.focus();
}

function toggleVoice() {
    voiceOn = !voiceOn;
    btnVoice.innerHTML = voiceOn
        ? '<svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>'
        : '<svg viewBox="0 0 24 24"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2c0 .76-.12 1.5-.35 2.18"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';
    btnVoice.classList.toggle('active', voiceOn);
    if (ipcRenderer) ipcRenderer.invoke('set-voice-enabled', voiceOn);
    setMood('happy');
    setTimeout(() => setMood('idle'), 1500);
}

// ===== æ¨¡å‹åˆ‡æ¢ (CC Switché£æ ¼) =====
const modelBadge = document.getElementById('modelBadge');
let currentModelColor = '#E8A838';

async function cycleModel() {
    if (!ipcRenderer) return;
    setMood('thinking');
    const model = await ipcRenderer.invoke('model-next');
    if (model) {
        updateModelBadge(model);
        // çƒä½“é—ªå˜åŠ¨ç”»
        flashModelSwitch(model.color);
        setMood('happy');
        setTimeout(() => setMood('idle'), 2000);
    } else {
        setMood('idle');
    }
}

function updateModelBadge(model) {
    if (!modelBadge || !model) return;
    modelBadge.textContent = model.icon;
    modelBadge.style.color = model.color;
    currentModelColor = model.color;
}

function flashModelSwitch(color) {
    // çƒä½“å¿«é€Ÿé—ªå˜æ•ˆæœ
    const pet = document.getElementById('pet');
    pet.style.transition = 'filter 0.15s';
    pet.style.filter = `brightness(1.5) drop-shadow(0 0 15px ${color})`;
    setTimeout(() => {
        pet.style.filter = '';
        pet.style.transition = '';
    }, 400);
}

// åˆå§‹åŒ–æ—¶è·å–å½“å‰æ¨¡å‹
if (ipcRenderer) {
    ipcRenderer.invoke('model-current').then(model => {
        if (model) updateModelBadge(model);
    });
    
    // ç›‘å¬æ¨¡å‹å˜æ›´äº‹ä»¶ï¼ˆæ¥è‡ªæ‰˜ç›˜èœå•åˆ‡æ¢ï¼‰
    ipcRenderer.on('model-changed', (e, model) => {
        updateModelBadge(model);
        flashModelSwitch(model.color);
    });
}

async function screenshot() {
    if (!ipcRenderer) return;
    setMood('thinking');
    const result = await ipcRenderer.invoke('take-screenshot', 'manual');
    if (result.success) {
        setMood('happy');
        setTimeout(() => setMood('idle'), 2000);
    } else { setMood('idle'); }
}

async function send() {
    const msg = inputEl.value.trim();
    if (!msg || !ipcRenderer) return;
    inputEl.value = '';
    inputBar.classList.remove('show');
    setMood('thinking');
    const reply = await ipcRenderer.invoke('openclaw-send', msg);
    if (reply) { setMood('happy'); setTimeout(() => setMood('idle'), 3000); }
}

// ===== IPC =====
if (ipcRenderer) {
    ipcRenderer.on('new-message', (e, msg) => {
        setMood('talking');
        setTimeout(() => setMood('idle'), 3000);
    });
    ipcRenderer.on('agent-response', (e, res) => {
        setMood('happy');
        setTimeout(() => setMood('idle'), 5000);
    });
    ipcRenderer.on('status-update', (e, s) => {
        const wasConnected = isConnected;
        isConnected = s.connected;
        if (!wasConnected && isConnected) {
            // å¤æ´»åŠ¨ç”»ï¼ä»ç°è‰²â†’å½©è‰²
            setMood('happy');
            squishing = true;
            pet.style.animation = 'squish 0.5s ease';
            setTimeout(() => { pet.style.animation = ''; squishing = false; }, 500);
            spawnParticles();
            spawnParticles(); // åŒå€ç²’å­åº†ç¥
            setTimeout(() => setMood('idle'), 3000);
        } else if (wasConnected && !isConnected) {
            setMood('offline');
        }
    });
}

// çŠ¶æ€æ£€æŸ¥
if (ipcRenderer) {
    setInterval(async () => {
        const s = await ipcRenderer.invoke('openclaw-status');
        const wasConnected = isConnected;
        isConnected = s.connected;
        if (!wasConnected && isConnected && currentMood === 'offline') {
            // å¤æ´»ï¼
            setMood('happy');
            squishing = true;
            pet.style.animation = 'squish 0.5s ease';
            setTimeout(() => { pet.style.animation = ''; squishing = false; }, 500);
            spawnParticles();
            spawnParticles();
            setTimeout(() => setMood('idle'), 3000);
        } else if (!isConnected && currentMood !== 'offline') {
            setMood('offline');
        }
    }, 10000);
}

// åˆå§‹åŒ– â€” å…ˆæ˜¾ç¤ºç¦»çº¿ï¼Œç­‰è¿æ¥æˆåŠŸåå¤æ´»
setMood('offline');
if (ipcRenderer) {
    setTimeout(async () => {
        const s = await ipcRenderer.invoke('openclaw-status');
        isConnected = s.connected;
        if (isConnected) {
            setMood('happy');
            squishing = true;
            pet.style.animation = 'squish 0.5s ease';
            setTimeout(() => { pet.style.animation = ''; squishing = false; }, 500);
            spawnParticles();
            setTimeout(() => setMood('idle'), 2000);
        }
    }, 1500);
}
</script>
</body>
</html>
