<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Claw ğŸ¦</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
    *::-webkit-scrollbar { display: none; }
    html, body {
        width: 100%;
        height: 100%;
        background: transparent;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
    }
    .container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    /* ===== æµä½“çƒ 67px ===== */
    .pet-wrapper {
        width: 67px;
        height: 67px;
        position: relative;
        cursor: grab;
        will-change: transform;
    }
    .pet-wrapper:active { cursor: grabbing; }

    .inner-fluid {
        position: absolute;
        top: 3px; left: 3px; right: 3px; bottom: 3px;
        border-radius: 50%;
        overflow: hidden;
        z-index: 1;
        background: linear-gradient(135deg, #ffb3b3, #fed6e3);
        transition: filter 0.4s ease;
    }
    .fluid-blob {
        position: absolute;
        width: 130%; height: 130%; top: -15%; left: -15%;
        background:
            radial-gradient(circle at 30% 30%, rgba(235,87,87,0.85), transparent 40%),
            radial-gradient(circle at 70% 65%, rgba(255,154,108,0.8), transparent 40%);
        animation: fluid-spin 8s linear infinite;
    }
    .fluid-blob-2 {
        position: absolute;
        width: 110%; height: 110%; top: -5%; left: -5%;
        background:
            radial-gradient(circle at 60% 30%, rgba(255,200,150,0.4), transparent 35%),
            radial-gradient(circle at 35% 70%, rgba(220,60,60,0.3), transparent 35%);
        animation: fluid-spin-r 12s linear infinite;
    }

    .glass-shell {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        border-radius: 50%; z-index: 2;
        /* ğŸ”® ç‰ç’ƒæ„Ÿï¼šåŒ¹é…Landing Pageé€šé€æ•ˆæœ */
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.12), rgba(255,255,255,0.03));
        box-shadow:
            inset -2px -2px 8px rgba(255,255,255,0.08),
            inset 2px 2px 8px rgba(255,255,255,0.35),
            0px 2px 6px rgba(220,80,80,0.08);
        border: 1px solid rgba(255,255,255,0.25);
        transition: box-shadow 1.0s cubic-bezier(0.4, 0.0, 0.2, 1), border 1.0s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    .glass-shell::before {
        content: '';
        position: absolute; top: 12%; left: 18%; width: 28%; height: 14%;
        border-radius: 50%; 
        background: rgba(255,255,255,0.55);
        filter: blur(1px); 
        transform: rotate(-40deg);
        transition: opacity 1.0s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    .glass-shell::after {
        content: '';
        position: absolute; bottom: 22%; right: 20%; width: 16%; height: 10%;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        filter: blur(1px);
        transform: rotate(25deg);
        transition: opacity 1.0s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    /* èƒ¶å›Šçœ¼ç› â€” å¤§å æ¯” */
    .eyes-container {
        position: absolute; z-index: 3;
        top: 16%; left: 10%; width: 80%; height: 50%;
        display: flex; justify-content: center; align-items: center;
        gap: 12px;
        pointer-events: none;
        overflow: visible;
    }
    .eye {
        width: 11px; height: 19px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 0 8px rgba(255,255,255,0.9), 0 0 16px rgba(255,255,255,0.4);
        transition: width 0.18s, height 0.18s, border-radius 0.18s, transform 0.18s cubic-bezier(0.25, 1, 0.5, 1);
        transform-origin: center center;
    }

    /* è…®çº¢ */
    .blush {
        position: absolute; z-index: 3;
        width: 14px; height: 8px; border-radius: 50%;
        background: rgba(255,130,130,0.25); filter: blur(3px);
        pointer-events: none; 
        /* ğŸ¨ 2ç§’å¹³æ»‘è¿‡æ¸¡ */
        transition: background 2.0s cubic-bezier(0.33, 0.0, 0.2, 1), opacity 0.6s ease; 
        opacity: 0.8;
    }
    .blush-l { top: 58%; left: 8%; }
    .blush-r { top: 58%; right: 8%; }

    /* æ°”æ³¡è£…é¥° */
    .bub {
        position: absolute; border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), rgba(255,255,255,0.06));
        border: 1px solid rgba(255,255,255,0.12);
        z-index: 0; opacity: 0; pointer-events: none;
    }
    .bub-1 { width: 5px; height: 5px; left: -5px; top: 60%; animation: bub 5s ease-in infinite 0s; }
    .bub-2 { width: 3px; height: 3px; right: -4px; top: 40%; animation: bub 6.5s ease-in infinite 2s; }

    .particles {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 10;
    }

    /* ===== å›¾æ ‡å·¥å…·æ  ===== */
    .toolbar {
        position: absolute;
        top: calc(50% + 46px);
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
        z-index: 20;
    }
    .container:hover .toolbar {
        opacity: 1;
        pointer-events: auto;
    }

    .tool-icon {
        width: 26px; height: 26px;
        border-radius: 50%;
        background: rgba(255,255,255,0.85);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .tool-icon svg {
        width: 13px; height: 13px;
        stroke: #666; fill: none;
        stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
    }
    .tool-icon:hover {
        transform: scale(1.2);
        box-shadow: 0 3px 12px rgba(0,0,0,0.2);
    }
    .tool-icon:active { transform: scale(0.9); }

    /* æ¨¡å‹åˆ‡æ¢æŒ‰é’® */
    .model-switch-btn {
        min-width: 26px;
        padding: 0 4px;
        border-radius: 13px;
    }
    .model-switch-btn:hover {
        background: rgba(255,255,255,0.95);
    }
    .tool-icon.active {
        background: rgba(255,255,255,1);
        box-shadow: 0 0 8px rgba(255,255,255,0.5), 0 2px 8px rgba(0,0,0,0.15);
    }

    /* è¾“å…¥æ¡ */
    .input-bar {
        position: absolute;
        top: calc(50% + 78px);
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 4px;
        opacity: 0;
        pointer-events: none;
        transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        z-index: 20;
    }
    .input-bar.show {
        opacity: 1;
        pointer-events: auto;
    }
    .input-bar input {
        width: 160px;
        padding: 4px 10px;
        border: none;
        border-radius: 12px;
        background: rgba(255,255,255,0.85);
        font-size: 11px;
        outline: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .input-bar button {
        padding: 4px 8px;
        border: none;
        border-radius: 12px;
        background: rgba(255,255,255,0.85);
        font-size: 11px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    @keyframes fluid-spin {
        0% { transform: rotate(0deg) scale(1); }
        50% { transform: rotate(180deg) scale(1.08); }
        100% { transform: rotate(360deg) scale(1); }
    }
    @keyframes fluid-spin-r {
        0% { transform: rotate(360deg) scale(1.05); }
        50% { transform: rotate(180deg) scale(0.95); }
        100% { transform: rotate(0deg) scale(1.05); }
    }
    @keyframes bub {
        0% { opacity: 0; transform: translateY(0) scale(0.3); }
        15% { opacity: 0.5; }
        100% { opacity: 0; transform: translateY(-30px) translateX(5px) scale(1); }
    }
    @keyframes squish {
        0% { transform: scale(1, 1); }
        25% { transform: scale(1.15, 0.85); }
        50% { transform: scale(0.9, 1.1); }
        75% { transform: scale(1.05, 0.95); }
        100% { transform: scale(1, 1); }
    }
</style>
</head>
<body>
<div class="container">
    <div class="pet-wrapper" id="pet">
        <div class="inner-fluid" id="fluid">
            <div class="fluid-blob" id="blob1"></div>
            <div class="fluid-blob-2" id="blob2"></div>
        </div>
        <div class="glass-shell"></div>
        <div class="eyes-container" id="eyes">
            <div class="eye" id="eyeL"></div>
            <div class="eye" id="eyeR"></div>
        </div>
        <div class="blush blush-l" id="blushL"></div>
        <div class="blush blush-r" id="blushR"></div>
        <div class="bub bub-1"></div>
        <div class="bub bub-2"></div>
        <div class="particles" id="particles"></div>
    </div>

    <!-- å›¾æ ‡å·¥å…·æ  -->
    <div class="toolbar" id="toolbar">
        <div class="tool-icon" id="btnChat" title="å‘æ¶ˆæ¯" onclick="toggleInput()">
            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        </div>
        <div class="tool-icon" id="btnVoice" title="è¯­éŸ³" onclick="toggleVoice()">
            <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
        </div>
        <div class="tool-icon" id="btnScreenshot" title="æˆªå›¾" onclick="screenshot()">
            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/></svg>
        </div>
        <div class="tool-icon model-switch-btn" id="btnModelSwitch" title="åˆ‡æ¢æ¨¡å‹" onclick="cycleModel()">
            <span id="modelBadge" style="font-size:9px;font-weight:700;color:#666;user-select:none;">OP</span>
        </div>
    </div>

    <!-- è¾“å…¥æ¡ -->
    <div class="input-bar" id="inputBar">
        <input type="text" id="input" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." onkeypress="if(event.key==='Enter')send()">
        <button onclick="send()">â†‘</button>
    </div>
</div>

<script>
const pet = document.getElementById('pet');
const eyeL = document.getElementById('eyeL');
const eyeR = document.getElementById('eyeR');
const fluid = document.getElementById('fluid');
const blob1 = document.getElementById('blob1');
const blob2 = document.getElementById('blob2');
let _moodTimer = null;
const blushL = document.getElementById('blushL');
const blushR = document.getElementById('blushR');
const particlesEl = document.getElementById('particles');
const glassShell = document.querySelector('.glass-shell');
const inputBar = document.getElementById('inputBar');
const inputEl = document.getElementById('input');
const btnVoice = document.getElementById('btnVoice');

let voiceOn = true;
let isConnected = false;

// ===== 60fps åŠ¨ç”» =====
let t = 0, squishing = false, targetScale = 1, curScale = 1, breathExtra = 0;

// æœ‰æœºè¿åŠ¨å‚æ•°
let deepBreathPhase = 0;       // æ·±å‘¼å¸ç›¸ä½ï¼ˆ0=æ­£å¸¸ï¼Œ>0=æ­£åœ¨æ·±å‘¼å¸ï¼‰
let fidgetSeed = Math.random() * 100;  // å¾®åŠ¨ä½œç§å­
let lastInteraction = Date.now();      // ä¸Šæ¬¡äº’åŠ¨æ—¶é—´

function loop() {
    t += 0.016;
    curScale += (targetScale - curScale) * 0.08;

    // === å¤šé¢‘å åŠ æœ‰æœºæµ®åŠ¨ï¼ˆæ›¿ä»£å•ä¸€æ­£å¼¦æ³¢ï¼‰===
    const floatY = Math.sin(t * 1.3) * 3.5
                 + Math.sin(t * 0.67) * 2
                 + Math.sin(t * 2.3) * 0.6;
    const floatR = Math.sin(t * 0.9) * 0.3
                 + Math.sin(t * 0.37) * 0.2;

    // === å‘¼å¸ï¼šåŸºç¡€ + å¶å°”æ·±å‘¼å¸ ===
    let breathScale = 1 + Math.sin(t * 2) * 0.01
                        + Math.sin(t * 0.8) * 0.005;
    if (deepBreathPhase > 0) {
        // æ·±å‘¼å¸ï¼šå¸æ°”è†¨èƒ€ â†’ å‘¼æ°”æ”¶ç¼©
        breathScale += Math.sin(deepBreathPhase) * 0.025;
        deepBreathPhase += 0.04;
        if (deepBreathPhase > Math.PI) deepBreathPhase = 0;
    }

    // === å¾®åŠ¨ä½œï¼šç»†å¾®çš„é‡å¿ƒç§»åŠ¨ ===
    const fidgetX = Math.sin(t * 0.23 + fidgetSeed) * 0.6;
    const fidgetR = Math.sin(t * 0.17 + fidgetSeed * 2) * 0.12;

    const bounce = breathExtra > 0 ? Math.sin(t * 12) * breathExtra : 0;

    if (!squishing) {
        pet.style.transform = `translateX(${fidgetX}px) translateY(${floatY + bounce}px) rotate(${floatR + fidgetR}deg) scale(${curScale * breathScale})`;
    }
    requestAnimationFrame(loop);
}
loop();

// æ·±å‘¼å¸/å¹æ°”ï¼šæ¯ 20-40 ç§’è§¦å‘ä¸€æ¬¡
setInterval(() => {
    if (currentMood === 'talking' || currentMood === 'thinking') return;
    if (deepBreathPhase === 0 && Math.random() < 0.5) {
        deepBreathPhase = 0.01;
    }
}, 20000 + Math.random() * 20000);

// ===== çœ¼ç›è¡¨æƒ… =====

// è¿‡æ¸¡é€Ÿåº¦é¢„è®¾
const EYE_SPEED = {
    snap:   '0s',                  // ç¬åˆ‡ï¼ˆç”¨äºçœ¨çœ¼é—­åˆç¬é—´ï¼‰
    fast:   '0.08s',               // å¿«é€Ÿï¼ˆçœ¨çœ¼çå¼€ï¼‰
    normal: '0.18s',               // å¸¸è§„
    smooth: '0.3s',                // å¹³æ»‘ï¼ˆæƒ…ç»ªè¿‡æ¸¡ï¼‰
    slow:   '0.45s',               // æ…¢ï¼ˆç™½æ—¥æ¢¦ã€å‘å‘†ï¼‰
    drift:  '0.6s',                // ææ…¢ï¼ˆçœ¼ç¥ç¼“æ…¢é£˜ç§»ï¼‰
};

function _setEyeTransition(speed) {
    const dur = EYE_SPEED[speed] || speed || EYE_SPEED.normal;
    const ease = speed === 'snap' || speed === 'fast'
        ? 'linear'
        : speed === 'slow' || speed === 'drift'
            ? 'cubic-bezier(0.4, 0, 0.2, 1)'
            : 'cubic-bezier(0.25, 1, 0.5, 1)';
    const t = `width ${dur} ${ease}, height ${dur} ${ease}, border-radius ${dur} ${ease}, transform ${dur} ${ease}`;
    eyeL.style.transition = t;
    eyeR.style.transition = t;
}

function setEyes(L, R, speed) {
    if (speed) _setEyeTransition(speed);
    const d = { w:11, h:19, br:'6px', tx:0, ty:0, sx:1, sy:1, rot:0 };
    const l = { ...d, ...L };
    const r = R ? { ...d, ...R } : { ...l };
    eyeL.style.width = l.w+'px'; eyeL.style.height = l.h+'px'; eyeL.style.borderRadius = l.br;
    eyeL.style.transform = `translate(${l.tx}px,${l.ty}px) scale(${l.sx},${l.sy}) rotate(${l.rot}deg)`;
    eyeR.style.width = r.w+'px'; eyeR.style.height = r.h+'px'; eyeR.style.borderRadius = r.br;
    eyeR.style.transform = `translate(${r.tx}px,${r.ty}px) scale(${r.sx},${r.sy}) rotate(${r.rot}deg)`;
    // ç”¨å®Œåæ¢å¤é»˜è®¤é€Ÿåº¦
    if (speed) setTimeout(() => _setEyeTransition('normal'), 20);
}

const EXPR = {
    // --- normal é€Ÿåº¦ (0.18s, é»˜è®¤) ---
    normal:     () => setEyes({ w:11, h:19, br:'6px' }),
    lookLeft:   () => setEyes({ w:11, h:19, br:'6px', tx:-4 }),
    lookRight:  () => setEyes({ w:11, h:19, br:'6px', tx:4 }),
    lookUp:     () => setEyes({ w:11, h:19, br:'6px', ty:-5 }),
    lookDown:   () => setEyes({ w:11, h:15, br:'6px', ty:4 }),
    squint:     () => setEyes({ w:12, h:6, br:'4px', ty:1 }),
    talking:    () => setEyes({ w:10, h:17, br:'5px' }),
    talkBig:    () => setEyes({ w:12, h:20, br:'6px' }),

    // --- snap é€Ÿåº¦ (0s, ç¬é—´) ---
    blink:      () => setEyes({ w:12, h:3, br:'3px' }, null, 'snap'),

    // --- fast é€Ÿåº¦ (0.08s, å¿«é€Ÿååº”) ---
    halfBlink:  () => setEyes({ w:11, h:10, br:'5px' }, null, 'fast'),
    surprised:  () => setEyes({ w:13, h:21, br:'7px' }, null, 'fast'),
    wow:        () => setEyes({ w:16, h:16, br:'8px' }, null, 'fast'),
    sparkle:    () => setEyes({ w:12, h:12, br:'3px', rot:45 }, null, 'fast'),
    wink:       () => setEyes(
        { w:13, h:7, br:'7px 7px 3px 3px', ty:1 },
        { w:11, h:19, br:'6px' }, 'fast'
    ),
    winkR:      () => setEyes(
        { w:11, h:19, br:'6px' },
        { w:13, h:7, br:'7px 7px 3px 3px', ty:1 }, 'fast'
    ),
    dizzy:      () => setEyes(
        { w:10, h:10, br:'5px', rot:25, tx:-2 },
        { w:10, h:10, br:'5px', rot:-25, tx:2 }, 'fast'
    ),
    cross:      () => setEyes(
        { w:10, h:3, br:'2px', rot:30 },
        { w:10, h:3, br:'2px', rot:-30 }, 'fast'
    ),
    flattered:  () => setEyes({ w:14, h:20, br:'7px', sy:1.05 }, null, 'fast'),
    nervous:    () => setEyes({ w:9, h:14, br:'5px', ty:1, sx:0.9 }, null, 'fast'),

    // --- smooth é€Ÿåº¦ (0.3s, æƒ…ç»ªè¿‡æ¸¡) ---
    happy:      () => setEyes({ w:13, h:7, br:'7px 7px 3px 3px', ty:1 }, null, 'smooth'),
    superHappy: () => setEyes({ w:15, h:5, br:'8px 8px 3px 3px', ty:1, sx:1.1 }, null, 'smooth'),
    giggle:     () => setEyes(
        { w:13, h:7, br:'7px 7px 3px 3px', ty:1, rot:-8 },
        { w:13, h:7, br:'7px 7px 3px 3px', ty:1, rot:8 }, 'smooth'
    ),
    curious:    () => setEyes(
        { w:9, h:16, br:'5px', ty:-1 },
        { w:13, h:21, br:'7px', ty:-1 }, 'smooth'
    ),
    thinking:   () => setEyes({ w:10, h:17, br:'5px', ty:-3 }, null, 'smooth'),
    hmm:        () => setEyes(
        { w:11, h:16, br:'5px', ty:-1, rot:8 },
        { w:9, h:13, br:'5px', ty:0, rot:-8 }, 'smooth'
    ),
    sad:        () => setEyes({ w:10, h:16, br:'5px', ty:3, sy:0.9 }, null, 'smooth'),
    angry:      () => setEyes(
        { w:12, h:14, br:'3px 6px 6px 3px', ty:-2, rot:-12 },
        { w:12, h:14, br:'6px 3px 3px 6px', ty:-2, rot:12 }, 'smooth'
    ),
    love:       () => setEyes({ w:14, h:13, br:'7px 1px 7px 1px', rot:45, sx:1.1 }, null, 'smooth'),
    smug:       () => setEyes(
        { w:11, h:7, br:'6px 6px 3px 3px', ty:1 },
        { w:9, h:15, br:'5px', tx:3 }, 'smooth'
    ),
    confused:   () => setEyes(
        { w:11, h:19, br:'6px', ty:-2 },
        { w:9, h:12, br:'5px', ty:2, rot:15 }, 'smooth'
    ),
    softSmile:  () => setEyes({ w:12, h:9, br:'6px 6px 3px 3px', ty:1 }, null, 'smooth'),
    focus:      () => setEyes({ w:9, h:18, br:'4px', ty:-1 }, null, 'smooth'),
    pout:       () => setEyes({ w:10, h:11, br:'5px', ty:2, sy:0.85 }, null, 'smooth'),
    peekL:      () => setEyes(
        { w:11, h:6, br:'4px', ty:1 },
        { w:10, h:17, br:'5px', tx:-3 }, 'smooth'
    ),
    peekR:      () => setEyes(
        { w:10, h:17, br:'5px', tx:3 },
        { w:11, h:6, br:'4px', ty:1 }, 'smooth'
    ),
    mischief:   () => setEyes(
        { w:13, h:14, br:'7px', rot:-5, ty:-1 },
        { w:9, h:10, br:'5px', rot:10, ty:1 }, 'smooth'
    ),
    worried:    () => setEyes(
        { w:11, h:16, br:'5px', ty:1, rot:5 },
        { w:11, h:16, br:'5px', ty:1, rot:-5 }, 'smooth'
    ),
    sly:        () => setEyes(
        { w:10, h:14, br:'5px', tx:3, rot:-6 },
        { w:12, h:8, br:'6px 6px 3px 3px', tx:3, ty:1 }, 'smooth'
    ),

    // --- slow é€Ÿåº¦ (0.45s, æ…µæ‡’æ¸å˜) ---
    sleepy:     () => setEyes({ w:12, h:4, br:'4px', ty:2 }, null, 'slow'),
    drowsy:     () => setEyes({ w:11, h:10, br:'5px', ty:1 }, null, 'slow'),
    dead:       () => setEyes({ w:10, h:3, br:'2px', ty:3 }, null, 'slow'),
    content:    () => setEyes({ w:13, h:8, br:'7px 7px 4px 4px', ty:0, sx:1.05 }, null, 'slow'),
    bliss:      () => setEyes({ w:14, h:5, br:'7px 7px 2px 2px', ty:1, sx:1.1 }, null, 'slow'),

    // --- drift é€Ÿåº¦ (0.6s, ç¼“æ…¢å¤±ç„¦) ---
    daydream:   () => setEyes({ w:13, h:20, br:'7px', ty:-3, sx:0.95 }, null, 'drift'),
    blank:      () => setEyes({ w:8, h:15, br:'4px' }, null, 'drift'),
};

// ===== é¼ æ ‡è·Ÿéš =====
let mouseTracking = true;
document.addEventListener('mousemove', (e) => {
    if (!mouseTracking) return;
    const rect = pet.getBoundingClientRect();
    const cx = rect.left + rect.width / 2, cy = rect.top + rect.height / 2;
    const dx = Math.max(-2, Math.min(2, (e.clientX - cx) / window.innerWidth * 6));
    const dy = Math.max(-2, Math.min(2, (e.clientY - cy) / window.innerHeight * 6));
    eyeL.style.transform = `translate(${dx}px,${dy}px)`;
    eyeR.style.transform = `translate(${dx}px,${dy}px)`;
});

// ===== çœ¨çœ¼ï¼ˆè‡ªç„¶èŠ‚å¥ï¼‰=====
function doBlink() {
    if (currentMood === 'sleepy' || currentMood === 'happy') { schedBlink(); return; }
    mouseTracking = false;
    EXPR.blink();
    const r = Math.random();
    if (r < 0.15) {
        // 15% è¿çœ¨ä¸¤ä¸‹
        setTimeout(() => {
            EXPR.normal(); setTimeout(() => {
                EXPR.blink(); setTimeout(() => { applyMoodEyes(); mouseTracking = true; }, 70);
            }, 100);
        }, 70);
    } else if (r < 0.3) {
        // 15% åŠçœ¨ â†’ å…¨çœ¨
        setTimeout(() => {
            EXPR.halfBlink();
            setTimeout(() => { EXPR.blink(); setTimeout(() => { applyMoodEyes(); mouseTracking = true; }, 80); }, 120);
        }, 70 + Math.random() * 40);
    } else if (r < 0.4) {
        // 10% æ…¢çœ¨ï¼ˆåƒåœ¨èµ°ç¥ï¼‰
        setTimeout(() => {
            EXPR.halfBlink();
            setTimeout(() => { applyMoodEyes(); mouseTracking = true; }, 250 + Math.random() * 150);
        }, 120);
    } else {
        // 50% æ­£å¸¸å¿«é€Ÿçœ¨
        setTimeout(() => { applyMoodEyes(); mouseTracking = true; }, 70 + Math.random() * 30);
    }
    schedBlink();
}
function schedBlink() {
    // ä¸å‡åŒ€é—´éš”ï¼šå¶å°”å¿«é€Ÿè¿çœ¨ï¼Œå¶å°”é•¿æ—¶é—´ä¸çœ¨
    const base = Math.random() < 0.2 ? 800 + Math.random() * 1500 : 2500 + Math.random() * 5000;
    setTimeout(doBlink, base);
}
schedBlink();

// ===== ç‚¹å‡» =====
let isDrag = false, startX, startY, dragOffsetX, dragOffsetY, clickCount = 0, clickTimer = null;

pet.addEventListener('mousedown', e => { 
    isDrag = false; 
    startX = e.screenX; 
    startY = e.screenY; 
    // è®°å½•é¼ æ ‡åœ¨çª—å£å†…çš„ç›¸å¯¹ä½ç½®ï¼Œé¿å…æ‹–åŠ¨æ—¶è·³è·ƒ
    dragOffsetX = e.clientX;
    dragOffsetY = e.clientY;
});
document.addEventListener('mousemove', e => {
    if (startX !== undefined) {
        if (Math.abs(e.screenX - startX) > 3 || Math.abs(e.screenY - startY) > 3) isDrag = true;
    }
    if (isDrag && electronAPI) {
        // ç”¨é¼ æ ‡ä½ç½®å‡å»ç›¸å¯¹åç§»ï¼Œç²¾ç¡®å®šä½çª—å£
        electronAPI.send('drag-pet', {
            x: e.screenX, 
            y: e.screenY,
            offsetX: dragOffsetX,
            offsetY: dragOffsetY
        });
    }
});
document.addEventListener('mouseup', () => { setTimeout(() => { isDrag = false; startX = undefined; }, 30); });

pet.addEventListener('click', () => {
    if (isDrag) return;
    clickCount++;
    clearTimeout(clickTimer);
    squishing = true;
    
    // ğŸ¨ å¢å¼ºç‚¹å‡»åŠ¨ç”»ï¼šå¸¦é¢œè‰²è„‰å†²
    pet.style.animation = 'squish 0.35s cubic-bezier(0.34, 1.56, 0.64, 1)';
    // ç‚¹å‡»æ—¶çƒä½“ç¨å¾®å˜äº®
    pet.style.filter = 'brightness(1.15)';
    
    setTimeout(() => { 
        pet.style.animation = ''; 
        pet.style.filter = '';
        squishing = false; 
    }, 350);
    
    spawnParticles();
    mouseTracking = false;

    if (clickCount >= 3) {
        // ğŸ’– ä¸‰å‡»è¶…å¼€å¿ƒæ¨¡å¼
        EXPR.superHappy();
        blushL.style.background = 'rgba(255,100,100,0.6)';
        blushR.style.background = 'rgba(255,100,100,0.6)';
        targetScale = 1.1;
        // çœ¼ç›ä¹Ÿè¦è·Ÿç€æ”¾å¤§
        eyeL.style.transform = 'scale(1.15)';
        eyeR.style.transform = 'scale(1.15)';
        
        // ä¸‰å‡»æ‰“å¼€å†å²æ¶ˆæ¯
        if (electronAPI) electronAPI.invoke('show-history');
        setTimeout(() => { 
            resetClick(); 
            clickCount = 0;
            eyeL.style.transform = '';
            eyeR.style.transform = '';
        }, 1200);
    } else {
        // éšæœºè¡¨æƒ… + çœ¼ç›åŠ¨ç”»
        const rr = ['happy','wink','winkR','surprised','curious','giggle','sparkle','wow'];
        EXPR[rr[Math.floor(Math.random()*rr.length)]]();
        clickTimer = setTimeout(() => { resetClick(); clickCount = 0; }, 800);
    }
});

function resetClick() {
    applyMoodEyes();
    blushL.style.background = ''; blushR.style.background = '';
    targetScale = MOODS[currentMood]?.scale || 1;
    mouseTracking = true;
}

// ğŸ¨ Hover äº¤äº’åŠ¨ç”»
pet.addEventListener('mouseenter', () => {
    if (currentMood === 'sleepy' || currentMood === 'offline') return;
    // é¼ æ ‡è¿›å…¥æ—¶çœ¼ç›å¾®å¾®çå¤§
    eyeL.style.transform = 'scale(1.08)';
    eyeR.style.transform = 'scale(1.08)';
    // çƒä½“å¾®å¾®å˜äº®
    pet.style.filter = 'brightness(1.05)';
});

pet.addEventListener('mouseleave', () => {
    eyeL.style.transform = '';
    eyeR.style.transform = '';
    pet.style.filter = '';
});

function spawnParticles() {
    const colors = ['#ff6b6b','#ffa07a','#ffb347','#ff69b4','#fff','#ffd700'];
    for (let i = 0; i < 8; i++) {
        const p = document.createElement('div');
        const sz = 2 + Math.random() * 3;
        const a = (Math.PI * 2 / 8) * i + Math.random() * 0.4;
        const dist = 15 + Math.random() * 25;
        p.style.cssText = `position:absolute;border-radius:50%;pointer-events:none;
            width:${sz}px;height:${sz}px;
            background:${colors[Math.floor(Math.random()*colors.length)]};
            left:50%;top:50%;opacity:1;
            transition:transform 0.4s ease-out,opacity 0.4s ease-out;`;
        particlesEl.appendChild(p);
        requestAnimationFrame(() => {
            p.style.transform = `translate(${Math.cos(a)*dist}px,${Math.sin(a)*dist}px)`;
            p.style.opacity = '0';
        });
        setTimeout(() => p.remove(), 450);
    }
}

// ===== æƒ…ç»ª =====
const MOODS = {
    // ğŸ”® é…è‰²æ¥è‡ª Landing Page é£æ ¼ + æ‰©å±•æƒ…ç»ªè‰²ç³»
    offline:   { 
        fluid:'linear-gradient(135deg,#ccc,#ddd)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(160,160,160,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(180,180,180,0.8),transparent 40%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(200,200,200,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(140,140,140,0.3),transparent 35%)', 
        glow:'0 0 20px rgba(160,160,160,0.15), 0 0 40px rgba(160,160,160,0.05)',
        eyes:'sleepy', scale:0.93, bounce:0, speed:'20s' 
    },
    idle:      { 
        fluid:'linear-gradient(135deg,#ffb3b3,#fed6e3)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(235,87,87,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(255,154,108,0.8),transparent 40%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(255,200,150,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(220,60,60,0.3),transparent 35%)', 
        glow:'0 0 40px rgba(255,107,74,0.25), 0 0 80px rgba(255,107,74,0.1)',
        eyes:'normal', scale:1, bounce:0, speed:'8s' 
    },
    happy:     { 
        fluid:'linear-gradient(135deg,#ffe0b2,#fff3e0)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(255,193,7,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(255,152,0,0.8),transparent 40%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(255,235,59,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(255,183,77,0.3),transparent 35%)', 
        glow:'0 0 40px rgba(255,193,7,0.3), 0 0 80px rgba(255,152,0,0.15)',
        eyes:'happy', scale:1.05, bounce:0.02, speed:'5s' 
    },
    talking:   { 
        fluid:'linear-gradient(135deg,#f8bbd0,#fce4ec)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(233,30,99,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(255,105,180,0.8),transparent 40%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(255,182,193,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(219,68,85,0.3),transparent 35%)', 
        glow:'0 0 40px rgba(255,105,180,0.3), 0 0 80px rgba(233,30,99,0.15)',
        eyes:'talking', scale:1, bounce:0.015, speed:'4s' 
    },
    thinking:  { 
        fluid:'linear-gradient(135deg,#d1c4e9,#ede7f6)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(103,58,183,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(123,104,238,0.8),transparent 40%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(179,157,219,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(94,53,177,0.3),transparent 35%)', 
        glow:'0 0 40px rgba(123,104,238,0.3), 0 0 80px rgba(103,58,183,0.15)',
        eyes:'thinking', scale:1, bounce:0, speed:'12s' 
    },
    sleepy:    { 
        fluid:'linear-gradient(135deg,#e8d5e0,#f0e6ef)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(186,147,170,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(200,170,190,0.8),transparent 40%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(220,200,215,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(170,130,160,0.3),transparent 35%)', 
        glow:'0 0 30px rgba(186,147,170,0.2), 0 0 60px rgba(186,147,170,0.08)',
        eyes:'sleepy', scale:0.97, bounce:0, speed:'16s' 
    },
    surprised: { 
        fluid:'linear-gradient(135deg,#fff9c4,#fff3e0)', 
        b1:'radial-gradient(circle at 30% 30%,rgba(255,215,0,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(255,165,0,0.8),transparent 40%)', 
        b2:'radial-gradient(circle at 60% 30%,rgba(255,235,59,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(255,87,34,0.3),transparent 35%)', 
        glow:'0 0 50px rgba(255,215,0,0.35), 0 0 100px rgba(255,165,0,0.15)',
        eyes:'surprised', scale:1.06, bounce:0, speed:'6s' 
    },
    // ğŸ†• æ–°å¢æƒ…ç»ª â€” åŒæ ·é²œè‰³çš„é…è‰²
    sad:       {
        fluid:'linear-gradient(135deg,#90caf9,#bbdefb)',
        b1:'radial-gradient(circle at 30% 30%,rgba(30,136,229,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(66,165,245,0.8),transparent 40%)',
        b2:'radial-gradient(circle at 60% 30%,rgba(144,202,249,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(21,101,192,0.3),transparent 35%)',
        glow:'0 0 40px rgba(66,165,245,0.3), 0 0 80px rgba(30,136,229,0.15)',
        eyes:'sad', scale:0.96, bounce:0, speed:'14s'
    },
    angry:     {
        fluid:'linear-gradient(135deg,#ef5350,#e53935)',
        b1:'radial-gradient(circle at 30% 30%,rgba(211,47,47,0.9),transparent 40%),radial-gradient(circle at 70% 65%,rgba(244,67,54,0.85),transparent 40%)',
        b2:'radial-gradient(circle at 50% 50%,rgba(255,82,82,0.45),transparent 35%),radial-gradient(circle at 35% 70%,rgba(183,28,28,0.35),transparent 35%)',
        glow:'0 0 50px rgba(244,67,54,0.4), 0 0 100px rgba(211,47,47,0.2)',
        eyes:'angry', scale:1.04, bounce:0.01, speed:'3s'
    },
    fearful:   {
        fluid:'linear-gradient(135deg,#ce93d8,#e1bee7)',
        b1:'radial-gradient(circle at 30% 30%,rgba(156,39,176,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(186,104,200,0.8),transparent 40%)',
        b2:'radial-gradient(circle at 60% 30%,rgba(206,147,216,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(123,31,162,0.3),transparent 35%)',
        glow:'0 0 40px rgba(156,39,176,0.3), 0 0 80px rgba(123,31,162,0.15)',
        eyes:'nervous', scale:0.97, bounce:0, speed:'5s'
    },
    calm:      {
        fluid:'linear-gradient(135deg,#b2dfdb,#e0f2f1)',
        b1:'radial-gradient(circle at 30% 30%,rgba(77,182,172,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(128,203,196,0.8),transparent 40%)',
        b2:'radial-gradient(circle at 60% 30%,rgba(178,223,219,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(0,137,123,0.3),transparent 35%)',
        glow:'0 0 40px rgba(77,182,172,0.25), 0 0 80px rgba(0,137,123,0.1)',
        eyes:'softSmile', scale:1, bounce:0, speed:'10s'
    },
    excited:   {
        fluid:'linear-gradient(135deg,#f48fb1,#f8bbd0)',
        b1:'radial-gradient(circle at 30% 30%,rgba(233,30,99,0.9),transparent 40%),radial-gradient(circle at 70% 65%,rgba(255,64,129,0.85),transparent 40%)',
        b2:'radial-gradient(circle at 50% 50%,rgba(248,187,208,0.45),transparent 35%),radial-gradient(circle at 35% 70%,rgba(194,24,91,0.35),transparent 35%)',
        glow:'0 0 55px rgba(233,30,99,0.4), 0 0 110px rgba(255,64,129,0.2)',
        eyes:'superHappy', scale:1.08, bounce:0.025, speed:'3s'
    },
    love:      {
        fluid:'linear-gradient(135deg,#ff8a80,#ffcdd2)',
        b1:'radial-gradient(circle at 30% 30%,rgba(229,57,53,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(255,82,82,0.8),transparent 40%)',
        b2:'radial-gradient(circle at 50% 50%,rgba(255,138,128,0.45),transparent 35%),radial-gradient(circle at 35% 70%,rgba(198,40,40,0.3),transparent 35%)',
        glow:'0 0 45px rgba(229,57,53,0.35), 0 0 90px rgba(255,82,82,0.15)',
        eyes:'love', scale:1.05, bounce:0.015, speed:'6s'
    },
    focused:   {
        fluid:'linear-gradient(135deg,#80deea,#b2ebf2)',
        b1:'radial-gradient(circle at 30% 30%,rgba(0,151,167,0.85),transparent 40%),radial-gradient(circle at 70% 65%,rgba(38,166,154,0.8),transparent 40%)',
        b2:'radial-gradient(circle at 60% 30%,rgba(128,222,234,0.4),transparent 35%),radial-gradient(circle at 35% 70%,rgba(0,131,143,0.3),transparent 35%)',
        glow:'0 0 40px rgba(0,151,167,0.3), 0 0 80px rgba(38,166,154,0.15)',
        eyes:'focus', scale:1.02, bounce:0, speed:'10s'
    },
};
let currentMood = 'idle', talkInterval = null;

function applyMoodEyes() {
    const m = MOODS[currentMood];
    if (m && EXPR[m.eyes]) EXPR[m.eyes]();
}

function setMood(mood) {
    const map = { normal:'idle', busy:'talking', excited:'happy' };
    mood = map[mood] || mood;
    if (!MOODS[mood]) mood = 'idle';
    const m = MOODS[mood];

    // ä»»ä½•æƒ…ç»ªå˜åŒ–éƒ½ç®—äº’åŠ¨
    lastInteraction = Date.now();

    if (mood !== currentMood) {
        // æ‰“æ–­ä¸Šä¸€æ¬¡æœªå®Œæˆçš„è¿‡æ¸¡
        if (_moodTimer) { clearTimeout(_moodTimer); _moodTimer = null; }

        // filter æŸ”å…‰è¿‡æ¸¡ï¼šäº®èµ· â†’ æ¢è‰² â†’ æ·¡å‡ºï¼Œé®æ© gradient è·³å˜
        fluid.style.transition = 'filter 0.35s ease-in';
        fluid.style.filter = 'brightness(1.6) blur(2px)';

        _moodTimer = setTimeout(() => {
            // å³°å€¼æ—¶ç¬é—´æ¢è‰²ï¼ˆäººçœ¼åœ¨é«˜äº®åº¦ä¸‹æ„ŸçŸ¥ä¸åˆ°è·³å˜ï¼‰
            fluid.style.background = m.fluid;
            blob1.style.background = m.b1;
            blob2.style.background = m.b2;
            // ğŸ”® åº”ç”¨æƒ…ç»ªå‘å…‰æ•ˆæœ
            if (m.glow && glassShell) {
                glassShell.style.boxShadow = 'inset -2px -2px 8px rgba(255,255,255,0.08), inset 2px 2px 8px rgba(255,255,255,0.35), ' + m.glow;
            }
            blob1.style.animation = 'fluid-spin ' + m.speed + ' linear infinite';

            // æ·¡å‡ºå›æ­£å¸¸
            fluid.style.transition = 'filter 0.5s ease-out';
            fluid.style.filter = 'brightness(1) blur(0px)';

            _moodTimer = setTimeout(() => {
                fluid.style.transition = '';
                fluid.style.filter = '';
                _moodTimer = null;
            }, 550);
        }, 350);
    }

    currentMood = mood;
    blob1.style.animationDuration = m.speed;

    if (mood === 'sleepy' || mood === 'sad') {
        blob1.style.transition = 'opacity 1.5s ease';
        blob1.style.opacity = '0.6';
    } else {
        blob1.style.transition = 'opacity 1.0s ease';
        blob1.style.opacity = '1';
    }

    targetScale = m.scale; breathExtra = m.bounce;
    mouseTracking = (mood !== 'sleepy' && mood !== 'happy' && mood !== 'sad');
    if (talkInterval) { clearInterval(talkInterval); talkInterval = null; }
    if (mood === 'talking') {
        let tog = false;
        talkInterval = setInterval(() => { tog=!tog; tog ? EXPR.talkBig() : EXPR.talking(); }, 250);
    } else { applyMoodEyes(); }

    if (mood === 'happy' || mood === 'excited' || mood === 'love') {
        blushL.style.transition = 'background 0.8s ease, opacity 0.6s ease';
        blushR.style.transition = 'background 0.8s ease, opacity 0.6s ease';
        blushL.style.background = mood === 'love' ? 'rgba(255,90,120,0.5)' : 'rgba(255,120,120,0.4)';
        blushR.style.background = mood === 'love' ? 'rgba(255,90,120,0.5)' : 'rgba(255,120,120,0.4)';
    } else {
        blushL.style.transition = 'background 0.6s ease, opacity 0.4s ease';
        blushR.style.transition = 'background 0.6s ease, opacity 0.4s ease';
        blushL.style.background = '';
        blushR.style.background = '';
    }
}

// ===== å¾…æœºå¾®è¡¨æƒ…ï¼ˆå¿ƒæƒ… + åœºæ™¯ + è¯­æ°” ä¸‰ç»´è§¦å‘ï¼‰=====

// æ—¶é—´åœºæ™¯åˆ¤å®š
function getTimeScene() {
    const h = new Date().getHours();
    if (h >= 6 && h < 11)  return 'morning';
    if (h >= 11 && h < 14) return 'noon';
    if (h >= 14 && h < 18) return 'afternoon';
    if (h >= 18 && h < 22) return 'evening';
    return 'latenight';
}

// è¯­æ°”çŠ¶æ€ï¼ˆä» AI å›å¤æ–‡æœ¬ä¸­æå–ï¼‰
let lastTone = 'neutral';
function detectTone(text) {
    if (!text) return 'neutral';
    if (/å“ˆå“ˆ|å˜»å˜»|ğŸ˜„|ğŸ˜†|ç¬‘|å¼€å¿ƒ|å¤ªå¥½äº†|æ£’|å‰å®³|ä¸é”™|å¥½è€¶/.test(text)) return 'cheerful';
    if (/å®³ç¾|è„¸çº¢|å˜¿å˜¿|ğŸ˜³|ğŸ˜Š|äººå®¶/.test(text)) return 'shy';
    if (/ç”Ÿæ°”|å¯æ¶|æ°”æ­»|å“¼|ğŸ˜ |ğŸ˜¤|è®¨åŒ/.test(text)) return 'annoyed';
    if (/éš¾è¿‡|ä¼¤å¿ƒ|å”‰|ğŸ˜¢|ğŸ˜­|å‘œå‘œ|æŠ±æ­‰|å¯¹ä¸èµ·/.test(text)) return 'sad';
    if (/å¥½å¥‡|ä¸ºä»€ä¹ˆ|æ€ä¹ˆ|å—ï¼Ÿ|å‘¢ï¼Ÿ|ğŸ¤”|æƒ³æƒ³/.test(text)) return 'curious';
    if (/åŠ æ²¹|å†²|ğŸ’ª|åŠªåŠ›|ä¸€å®šå¯ä»¥|ç›¸ä¿¡/.test(text)) return 'encourage';
    if (/å›°|ç´¯|ğŸ˜´|å“ˆæ¬ |æƒ³ç¡|å¥½å›°/.test(text)) return 'tired';
    if (/æƒŠ|å¤©å“ª|ä»€ä¹ˆ|ğŸ˜±|ğŸ˜®|ä¸ä¼šå§|å“‡/.test(text)) return 'surprised';
    if (/å—¯|å¥½çš„|äº†è§£|æ˜ç™½|çŸ¥é“äº†|æ”¶åˆ°/.test(text)) return 'calm';
    return 'neutral';
}

// === æŒ‰å¿ƒæƒ…åˆ†ç»„çš„åŠ¨ä½œæ±  ===
const ACT = {
    daily: [
    // å·¦å³å¼ æœ›
    () => { EXPR.lookLeft(); setTimeout(() => { EXPR.lookRight(); setTimeout(() => EXPR.normal(), 500); }, 500); },
    // å¥½å¥‡æ­ªå¤´
    () => { EXPR.curious(); setTimeout(() => EXPR.normal(), 800); },
    // å·¦çœ¼çœ¨
    () => { EXPR.wink(); setTimeout(() => EXPR.normal(), 700); },
    // å³çœ¼çœ¨
    () => { EXPR.winkR(); setTimeout(() => EXPR.normal(), 700); },
    // è‹¥æœ‰æ‰€æ€
    () => { EXPR.hmm(); setTimeout(() => EXPR.normal(), 800); },
    // æ˜Ÿæ˜Ÿçœ¼
    () => { EXPR.sparkle(); setTimeout(() => EXPR.normal(), 500); },
    // è¿ç»­çœ¨çœ¼
    () => { EXPR.blink(); setTimeout(() => EXPR.normal(), 80); setTimeout(() => EXPR.blink(), 250); setTimeout(() => EXPR.normal(), 330); },
    // å·¦å³å¿«é€Ÿçœ‹
    () => { EXPR.lookLeft(); setTimeout(() => EXPR.lookRight(), 200); setTimeout(() => EXPR.lookLeft(), 400); setTimeout(() => EXPR.lookRight(), 600); setTimeout(() => EXPR.normal(), 800); },
    // åŒçœ¨ç¡®è®¤
    () => { EXPR.blink(); setTimeout(() => EXPR.normal(), 80); setTimeout(() => EXPR.blink(), 400); setTimeout(() => EXPR.normal(), 480); },
    // ç¯é¡¾å››å‘¨
    () => { EXPR.lookLeft(); setTimeout(() => EXPR.lookUp(), 350); setTimeout(() => EXPR.lookRight(), 700); setTimeout(() => EXPR.lookDown(), 1050); setTimeout(() => EXPR.normal(), 1400); },
    // çœ¯çœ¼å·çœ‹
    () => { EXPR.squint(); setTimeout(() => { EXPR.lookLeft(); setTimeout(() => { EXPR.squint(); setTimeout(() => EXPR.normal(), 300); }, 400); }, 500); },
    // æŠ–ä¸€æŠ–
    () => { const s = targetScale; targetScale = 0.92; setTimeout(() => { targetScale = 1.06; setTimeout(() => { targetScale = s; }, 150); }, 150); },
    // å·ç„å·¦è¾¹ â†’ å‡è£…æ²¡äº‹
    () => { EXPR.peekL(); setTimeout(() => { EXPR.blink(); setTimeout(() => EXPR.normal(), 100); }, 700); },
    // å·ç„å³è¾¹ â†’ å¿ƒè™š
    () => { EXPR.peekR(); setTimeout(() => { EXPR.nervous(); setTimeout(() => EXPR.normal(), 400); }, 600); },
    // å‘å‘† â†’ å›ç¥
    () => { EXPR.blank(); setTimeout(() => { EXPR.blink(); setTimeout(() => { EXPR.surprised(); setTimeout(() => EXPR.normal(), 300); }, 100); }, 1200); },
    // æ¸©æŸ”å¾®ç¬‘
    () => { EXPR.softSmile(); setTimeout(() => EXPR.normal(), 1000); },
    // ä¸“æ³¨çœ‹ä»€ä¹ˆ â†’ å¥½å¥‡
    () => { EXPR.focus(); setTimeout(() => { EXPR.curious(); setTimeout(() => EXPR.normal(), 500); }, 800); },
    ],

    happy: [
    // å¼€å¿ƒå¼¯çœ¼
    () => { EXPR.happy(); setTimeout(() => EXPR.normal(), 1000); },
    // å¼€å¿ƒè¹¦è·¶
    () => { EXPR.superHappy(); const s = targetScale; targetScale = 1.1; setTimeout(() => { targetScale = 0.93; }, 200); setTimeout(() => { targetScale = 1.08; EXPR.giggle(); }, 400); setTimeout(() => { targetScale = 0.95; }, 600); setTimeout(() => { targetScale = s; EXPR.happy(); }, 800); setTimeout(() => EXPR.normal(), 1200); },
    // å’¯å’¯ç¬‘
    () => { EXPR.giggle(); setTimeout(() => EXPR.normal(), 800); },
    // å¼¹è·³
    () => { const s = targetScale; EXPR.happy(); targetScale = 0.9; setTimeout(() => { targetScale = 1.12; }, 150); setTimeout(() => { targetScale = 0.93; }, 350); setTimeout(() => { targetScale = 1.05; EXPR.giggle(); }, 500); setTimeout(() => { targetScale = s; EXPR.normal(); }, 700); },
    // å¾—æ„è„¸
    () => { EXPR.smug(); setTimeout(() => { EXPR.giggle(); setTimeout(() => EXPR.normal(), 600); }, 700); },
    // çˆ±å¿ƒçœ¼
    () => { EXPR.love(); blushL.style.transition = 'background 0.3s'; blushR.style.transition = 'background 0.3s'; blushL.style.background = 'rgba(255,80,120,0.5)'; blushR.style.background = 'rgba(255,80,120,0.5)'; setTimeout(() => { EXPR.superHappy(); blushL.style.transition = 'background 0.8s'; blushR.style.transition = 'background 0.8s'; blushL.style.background = ''; blushR.style.background = ''; }, 1000); setTimeout(() => EXPR.normal(), 1500); },
    // æ»¡è¶³å¹æ°”
    () => { EXPR.content(); deepBreathPhase = 0.01; setTimeout(() => { EXPR.softSmile(); setTimeout(() => EXPR.normal(), 800); }, 600); },
    // é™¶é†‰
    () => { EXPR.bliss(); blushL.style.transition = 'background 0.4s'; blushR.style.transition = 'background 0.4s'; blushL.style.background = 'rgba(255,100,120,0.3)'; blushR.style.background = 'rgba(255,100,120,0.3)'; setTimeout(() => { EXPR.content(); blushL.style.transition = 'background 0.8s'; blushR.style.transition = 'background 0.8s'; blushL.style.background = ''; blushR.style.background = ''; }, 1200); setTimeout(() => EXPR.normal(), 1800); },
    // å—å® è‹¥æƒŠ â†’ å¼€å¿ƒ
    () => { EXPR.flattered(); setTimeout(() => { EXPR.happy(); blushL.style.transition = 'background 0.3s'; blushR.style.transition = 'background 0.3s'; blushL.style.background = 'rgba(255,90,110,0.35)'; blushR.style.background = 'rgba(255,90,110,0.35)'; }, 500); setTimeout(() => { EXPR.normal(); blushL.style.transition = 'background 0.6s'; blushR.style.transition = 'background 0.6s'; blushL.style.background = ''; blushR.style.background = ''; }, 1200); },
    ],

    shy: [
    // å®³ç¾è„¸çº¢
    () => { EXPR.happy(); blushL.style.transition = 'background 0.3s'; blushR.style.transition = 'background 0.3s'; blushL.style.background = 'rgba(255,100,100,0.5)'; blushR.style.background = 'rgba(255,100,100,0.5)'; setTimeout(() => { EXPR.normal(); blushL.style.transition = 'background 0.8s'; blushR.style.transition = 'background 0.8s'; blushL.style.background = ''; blushR.style.background = ''; }, 1200); },
    // çœ¯çœ¼å®³ç¾
    () => { EXPR.squint(); blushL.style.transition = 'background 0.3s'; blushR.style.transition = 'background 0.3s'; blushL.style.background = 'rgba(255,100,100,0.4)'; blushR.style.background = 'rgba(255,100,100,0.4)'; setTimeout(() => EXPR.lookDown(), 400); setTimeout(() => { EXPR.normal(); blushL.style.transition = 'background 0.8s'; blushR.style.transition = 'background 0.8s'; blushL.style.background = ''; blushR.style.background = ''; }, 1000); },
    // åŠçœ¨ä½å¤´
    () => { EXPR.halfBlink(); setTimeout(() => { EXPR.lookDown(); blushL.style.transition = 'background 0.4s'; blushR.style.transition = 'background 0.4s'; blushL.style.background = 'rgba(255,120,100,0.35)'; blushR.style.background = 'rgba(255,120,100,0.35)'; }, 300); setTimeout(() => { EXPR.normal(); blushL.style.background = ''; blushR.style.background = ''; }, 1000); },
    // å¿ƒè™šå·çœ‹ â†’ è„¸çº¢
    () => { EXPR.nervous(); setTimeout(() => { EXPR.peekR(); blushL.style.transition = 'background 0.3s'; blushR.style.transition = 'background 0.3s'; blushL.style.background = 'rgba(255,110,100,0.4)'; blushR.style.background = 'rgba(255,110,100,0.4)'; }, 400); setTimeout(() => { EXPR.blink(); }, 900); setTimeout(() => { EXPR.softSmile(); blushL.style.transition = 'background 0.8s'; blushR.style.transition = 'background 0.8s'; blushL.style.background = ''; blushR.style.background = ''; }, 1100); setTimeout(() => EXPR.normal(), 1600); },
    // å—å® è‹¥æƒŠ â†’ å®³ç¾ä½å¤´
    () => { EXPR.flattered(); blushL.style.transition = 'background 0.2s'; blushR.style.transition = 'background 0.2s'; blushL.style.background = 'rgba(255,90,100,0.5)'; blushR.style.background = 'rgba(255,90,100,0.5)'; setTimeout(() => EXPR.lookDown(), 500); setTimeout(() => { EXPR.softSmile(); }, 1000); setTimeout(() => { EXPR.normal(); blushL.style.transition = 'background 0.8s'; blushR.style.transition = 'background 0.8s'; blushL.style.background = ''; blushR.style.background = ''; }, 1600); },
    ],

    thinking: [
    // è‹¥æœ‰æ‰€æ€
    () => { EXPR.thinking(); setTimeout(() => EXPR.normal(), 800); },
    // æ²‰æ€é“¾
    () => { EXPR.hmm(); setTimeout(() => { EXPR.thinking(); setTimeout(() => EXPR.normal(), 600); }, 500); },
    // å¥½å¥‡æ­ªå¤´
    () => { EXPR.curious(); setTimeout(() => { EXPR.hmm(); setTimeout(() => EXPR.normal(), 600); }, 500); },
    // ä»°æœ›æ€è€ƒ
    () => { EXPR.lookUp(); setTimeout(() => { EXPR.thinking(); setTimeout(() => EXPR.normal(), 700); }, 500); },
    // å›°æƒ‘çµæ„Ÿ
    () => { EXPR.confused(); setTimeout(() => { EXPR.thinking(); setTimeout(() => { EXPR.sparkle(); setTimeout(() => EXPR.normal(), 400); }, 500); }, 600); },
    // æ€è€ƒé¡¿æ‚Ÿ
    () => { EXPR.thinking(); setTimeout(() => { EXPR.sparkle(); setTimeout(() => { EXPR.giggle(); setTimeout(() => EXPR.normal(), 500); }, 400); }, 800); },
    // ä¸“æ³¨ â†’ å›°æƒ‘ â†’ é¡¿æ‚Ÿ
    () => { EXPR.focus(); setTimeout(() => { EXPR.confused(); setTimeout(() => { EXPR.sparkle(); setTimeout(() => { EXPR.happy(); setTimeout(() => EXPR.normal(), 400); }, 400); }, 500); }, 800); },
    // å‘å‘†ç™½æ—¥æ¢¦ â†’ è¢«æ‹‰å›æ¥
    () => { EXPR.daydream(); setTimeout(() => { EXPR.blink(); setTimeout(() => { EXPR.surprised(); setTimeout(() => EXPR.normal(), 300); }, 100); }, 1500); },
    // æ‹…å¿§ â†’ æ€è€ƒ â†’ é‡Šç„¶
    () => { EXPR.worried(); setTimeout(() => { EXPR.thinking(); setTimeout(() => { EXPR.softSmile(); setTimeout(() => EXPR.normal(), 600); }, 600); }, 600); },
    ],

    surprised: [
    // å¤§æƒŠ
    () => { EXPR.surprised(); setTimeout(() => EXPR.normal(), 600); },
    // å¤§æƒŠå¥½å¥‡
    () => { EXPR.wow(); setTimeout(() => { EXPR.curious(); setTimeout(() => EXPR.normal(), 600); }, 500); },
    // çœ‹åˆ°å¥½åƒçš„
    () => { EXPR.wow(); setTimeout(() => EXPR.love(), 400); setTimeout(() => { EXPR.superHappy(); blushL.style.transition = 'background 0.2s'; blushR.style.transition = 'background 0.2s'; blushL.style.background = 'rgba(255,100,100,0.4)'; blushR.style.background = 'rgba(255,100,100,0.4)'; }, 800); setTimeout(() => { EXPR.normal(); blushL.style.transition = 'background 0.6s'; blushR.style.transition = 'background 0.6s'; blushL.style.background = ''; blushR.style.background = ''; }, 1400); },
    // å—å® è‹¥æƒŠ â†’ é™¶é†‰
    () => { EXPR.flattered(); const s = targetScale; targetScale = 1.05; setTimeout(() => { EXPR.bliss(); targetScale = s; }, 600); setTimeout(() => { EXPR.happy(); }, 1200); setTimeout(() => EXPR.normal(), 1700); },
    // æƒŠè®¶ â†’ æ‹…å¿§ â†’ é‡Šç„¶
    () => { EXPR.surprised(); setTimeout(() => { EXPR.worried(); setTimeout(() => { EXPR.softSmile(); setTimeout(() => EXPR.normal(), 500); }, 600); }, 400); },
    ],

    sleepy: [
    // æ‰“ç›¹æƒŠé†’
    () => { EXPR.drowsy(); setTimeout(() => { EXPR.sleepy(); setTimeout(() => { EXPR.surprised(); setTimeout(() => EXPR.normal(), 300); }, 600); }, 400); },
    // æ‡’æ´‹æ´‹æ…¢çœ¨
    () => { EXPR.halfBlink(); setTimeout(() => EXPR.sleepy(), 500); setTimeout(() => EXPR.halfBlink(), 1200); setTimeout(() => EXPR.drowsy(), 1700); setTimeout(() => EXPR.normal(), 2200); },
    // ä¼¸æ‡’è…°
    () => { const s = targetScale; targetScale = 1.08; EXPR.sleepy(); setTimeout(() => { targetScale = s; EXPR.drowsy(); setTimeout(() => { EXPR.surprised(); setTimeout(() => EXPR.normal(), 300); }, 400); }, 1000); },
    // çŠ¯å›°çœ¨çœ¼
    () => { EXPR.sleepy(); setTimeout(() => { EXPR.blink(); setTimeout(() => EXPR.sleepy(), 400); setTimeout(() => EXPR.normal(), 1200); }, 800); },
    // çŠ¯å›°ç™½æ—¥æ¢¦
    () => { EXPR.drowsy(); setTimeout(() => { EXPR.daydream(); setTimeout(() => { EXPR.sleepy(); setTimeout(() => { EXPR.blink(); setTimeout(() => EXPR.normal(), 100); }, 800); }, 1000); }, 600); },
    // çŒç¡ç‚¹å¤´ï¼ˆèº«ä½“æ™ƒï¼‰
    () => { EXPR.sleepy(); const s = targetScale; targetScale = 0.95; setTimeout(() => { targetScale = 1.02; EXPR.blink(); }, 600); setTimeout(() => { targetScale = 0.93; EXPR.sleepy(); }, 1000); setTimeout(() => { targetScale = s; EXPR.drowsy(); }, 1500); setTimeout(() => EXPR.normal(), 2000); },
    ],

    sad: [
    // éš¾è¿‡æŒ¯ä½œ
    () => { EXPR.sad(); setTimeout(() => { EXPR.drowsy(); setTimeout(() => { EXPR.normal(); setTimeout(() => EXPR.happy(), 200); setTimeout(() => EXPR.normal(), 700); }, 400); }, 600); },
    // ä½å¤´æ²‰æ€
    () => { EXPR.sad(); setTimeout(() => { EXPR.lookDown(); setTimeout(() => EXPR.normal(), 600); }, 500); },
    // å›°æƒ‘éš¾è¿‡
    () => { EXPR.confused(); setTimeout(() => { EXPR.sad(); setTimeout(() => EXPR.normal(), 700); }, 400); },
    // æ‹…å¿§ â†’ å¹æ°” â†’ æŒ¯ä½œ
    () => { EXPR.worried(); deepBreathPhase = 0.01; setTimeout(() => { EXPR.sad(); setTimeout(() => { EXPR.blink(); setTimeout(() => { EXPR.softSmile(); setTimeout(() => EXPR.normal(), 500); }, 100); }, 700); }, 800); },
    // å˜Ÿå˜´ â†’ å¹æ°”
    () => { EXPR.pout(); setTimeout(() => { deepBreathPhase = 0.01; EXPR.lookDown(); setTimeout(() => EXPR.normal(), 800); }, 600); },
    ],

    annoyed: [
    // ç”Ÿæ°”è·ºè„š
    () => { EXPR.angry(); const s = targetScale; targetScale = 1.05; setTimeout(() => { targetScale = 0.95; }, 200); setTimeout(() => { targetScale = 1.05; }, 400); setTimeout(() => { targetScale = s; EXPR.hmm(); }, 600); setTimeout(() => EXPR.normal(), 1000); },
    // æ€’å¿æ·±å‘¼å¸
    () => { EXPR.angry(); setTimeout(() => EXPR.squint(), 500); setTimeout(() => { EXPR.blink(); const s = targetScale; targetScale = 1.06; setTimeout(() => { targetScale = s; }, 400); }, 800); setTimeout(() => EXPR.normal(), 1400); },
    // ç¿»ç™½çœ¼
    () => { EXPR.lookUp(); setTimeout(() => { EXPR.lookDown(); setTimeout(() => { EXPR.blink(); setTimeout(() => EXPR.normal(), 200); }, 300); }, 300); },
    // æ‘‡å¤´
    () => { EXPR.squint(); EXPR.lookLeft(); setTimeout(() => EXPR.lookRight(), 250); setTimeout(() => EXPR.lookLeft(), 500); setTimeout(() => EXPR.normal(), 750); },
    // å˜Ÿå˜´ä¸æ»¡ â†’ æ‘‡å¤´
    () => { EXPR.pout(); setTimeout(() => { EXPR.lookLeft(); setTimeout(() => { EXPR.lookRight(); setTimeout(() => { EXPR.pout(); setTimeout(() => EXPR.normal(), 400); }, 250); }, 250); }, 500); },
    // ç‹¡é» ä¾§ç›® â†’ ç”Ÿæ°”
    () => { EXPR.sly(); setTimeout(() => { EXPR.angry(); const s = targetScale; targetScale = 1.04; setTimeout(() => { targetScale = s; EXPR.squint(); }, 400); setTimeout(() => EXPR.normal(), 800); }, 600); },
    ],

    encourage: [
    // é—ªäº®æ”¾å¤§
    () => { EXPR.sparkle(); const s = targetScale; targetScale = 1.08; setTimeout(() => { targetScale = s; EXPR.superHappy(); }, 400); setTimeout(() => EXPR.normal(), 900); },
    // å¼€å¿ƒé€’è¿›
    () => { EXPR.happy(); setTimeout(() => { EXPR.superHappy(); setTimeout(() => { EXPR.giggle(); setTimeout(() => EXPR.normal(), 500); }, 400); }, 300); },
    // ä¸“æ³¨ â†’ æ˜Ÿæ˜Ÿçœ¼ â†’ æ»¡è¶³
    () => { EXPR.focus(); setTimeout(() => { EXPR.sparkle(); const s = targetScale; targetScale = 1.06; setTimeout(() => { targetScale = s; EXPR.content(); }, 400); setTimeout(() => EXPR.normal(), 900); }, 500); },
    ],

    smug: [
    // å‚²å¨‡é—­çœ¼
    () => { EXPR.blink(); setTimeout(() => { EXPR.hmm(); setTimeout(() => EXPR.normal(), 600); }, 300); },
    // åç¬‘è„¸çº¢
    () => { EXPR.smug(); blushL.style.transition = 'background 0.3s'; blushR.style.transition = 'background 0.3s'; blushL.style.background = 'rgba(255,120,80,0.3)'; blushR.style.background = 'rgba(255,120,80,0.3)'; setTimeout(() => EXPR.giggle(), 600); setTimeout(() => { EXPR.normal(); blushL.style.transition = 'background 0.6s'; blushR.style.transition = 'background 0.6s'; blushL.style.background = ''; blushR.style.background = ''; }, 1200); },
    // è°ƒçš® â†’ ç‹¡é»  â†’ å¾—æ„
    () => { EXPR.mischief(); setTimeout(() => { EXPR.sly(); setTimeout(() => { EXPR.smug(); setTimeout(() => EXPR.normal(), 500); }, 500); }, 500); },
    ],

    dizzy: [
    // å¤´æ™•
    () => { EXPR.dizzy(); const s = targetScale; targetScale = 0.95; setTimeout(() => { targetScale = 1.03; }, 200); setTimeout(() => { targetScale = 0.97; }, 400); setTimeout(() => { targetScale = s; EXPR.halfBlink(); }, 600); setTimeout(() => EXPR.normal(), 900); },
    // è£…æ­»å¤æ´»
    () => { EXPR.dead(); const s = targetScale; targetScale = 0.85; setTimeout(() => { EXPR.blink(); targetScale = 0.9; }, 1500); setTimeout(() => { EXPR.surprised(); targetScale = s; }, 1800); setTimeout(() => EXPR.normal(), 2200); },
    // äº¤å‰çœ¼æ™•
    () => { EXPR.cross(); setTimeout(() => { EXPR.dizzy(); setTimeout(() => { EXPR.halfBlink(); setTimeout(() => EXPR.normal(), 400); }, 500); }, 400); },
    // å‘†æ» â†’ æ™• â†’ æ¢å¤
    () => { EXPR.blank(); setTimeout(() => { EXPR.dizzy(); const s = targetScale; targetScale = 0.96; setTimeout(() => { targetScale = s; EXPR.blink(); setTimeout(() => { EXPR.confused(); setTimeout(() => EXPR.normal(), 400); }, 100); }, 500); }, 800); },
    ],

    // === æ–°å¢åŠ¨ä½œæ±  ===
    playful: [
    // è°ƒçš®æŒ¤çœ‰å¼„çœ¼
    () => { EXPR.mischief(); setTimeout(() => { EXPR.wink(); setTimeout(() => { EXPR.giggle(); setTimeout(() => EXPR.normal(), 500); }, 400); }, 600); },
    // å·ç„ â†’ è¢«å‘ç° â†’ å‡è£…æ²¡äº‹
    () => { EXPR.peekL(); setTimeout(() => { EXPR.surprised(); setTimeout(() => { EXPR.nervous(); setTimeout(() => { EXPR.blink(); setTimeout(() => EXPR.normal(), 100); }, 300); }, 300); }, 800); },
    // ç‹¡é»  â†’ è°ƒçš®å¼¹è·³
    () => { EXPR.sly(); const s = targetScale; setTimeout(() => { EXPR.mischief(); targetScale = 1.08; setTimeout(() => { targetScale = 0.94; }, 200); setTimeout(() => { targetScale = s; EXPR.giggle(); }, 400); setTimeout(() => EXPR.normal(), 800); }, 500); },
    // åšé¬¼è„¸
    () => { EXPR.cross(); const s = targetScale; targetScale = 0.9; setTimeout(() => { EXPR.mischief(); targetScale = 1.05; }, 400); setTimeout(() => { targetScale = s; EXPR.giggle(); }, 700); setTimeout(() => EXPR.normal(), 1100); },
    ],

    dreamy: [
    // ç™½æ—¥æ¢¦ â†’ å¾®ç¬‘
    () => { EXPR.daydream(); setTimeout(() => { EXPR.softSmile(); setTimeout(() => EXPR.normal(), 800); }, 1200); },
    // å‘å‘† â†’ æ·±å‘¼å¸ â†’ æƒ¬æ„
    () => { EXPR.blank(); deepBreathPhase = 0.01; setTimeout(() => { EXPR.daydream(); setTimeout(() => { EXPR.content(); setTimeout(() => EXPR.normal(), 600); }, 1000); }, 800); },
    // é™¶é†‰ â†’ æ»¡è¶³
    () => { EXPR.bliss(); blushL.style.transition = 'background 0.4s'; blushR.style.transition = 'background 0.4s'; blushL.style.background = 'rgba(255,120,130,0.25)'; blushR.style.background = 'rgba(255,120,130,0.25)'; setTimeout(() => { EXPR.content(); blushL.style.transition = 'background 1s'; blushR.style.transition = 'background 1s'; blushL.style.background = ''; blushR.style.background = ''; }, 1500); setTimeout(() => EXPR.normal(), 2200); },
    // ä»°æœ› â†’ ç™½æ—¥æ¢¦ â†’ æ¸©æŸ”å¾®ç¬‘
    () => { EXPR.lookUp(); setTimeout(() => { EXPR.daydream(); setTimeout(() => { EXPR.softSmile(); setTimeout(() => EXPR.normal(), 700); }, 1200); }, 500); },
    ],
};

// æ—¶é—´åœºæ™¯ â†’ åå¥½çš„åŠ¨ä½œæ± æƒé‡
const SCENE_WEIGHTS = {
    morning:   { sleepy: 4, daily: 3, dreamy: 2, shy: 1, thinking: 1 },
    noon:      { daily: 3, happy: 2, playful: 2, thinking: 1, sleepy: 1 },
    afternoon: { daily: 3, thinking: 2, happy: 1, dreamy: 1, playful: 1, encourage: 1 },
    evening:   { daily: 2, happy: 2, dreamy: 2, shy: 1, sleepy: 2 },
    latenight: { sleepy: 5, dreamy: 2, daily: 1, dizzy: 2, sad: 1 },
};

// è¯­æ°” â†’ åå¥½çš„åŠ¨ä½œæ± æ˜ å°„
const TONE_MAP = {
    cheerful: 'happy', shy: 'shy', annoyed: 'annoyed', sad: 'sad',
    curious: 'thinking', encourage: 'encourage', tired: 'sleepy',
    surprised: 'surprised', calm: 'dreamy', neutral: null,
};

// æ™ºèƒ½é€‰æ‹©åŠ¨ä½œ
function pickIdleAction() {
    const scene = getTimeScene();
    const tonePool = TONE_MAP[lastTone];

    // è¯­æ°”ä¼˜å…ˆï¼šæœ€è¿‘æœ‰æ˜ç¡®è¯­æ°”æ—¶ 70% æ¦‚ç‡æŒ‰è¯­æ°”é€‰
    if (tonePool && ACT[tonePool] && Math.random() < 0.7) {
        lastTone = 'neutral';
        const pool = ACT[tonePool];
        return pool[Math.floor(Math.random() * pool.length)];
    }

    // å¦åˆ™æŒ‰æ—¶é—´åœºæ™¯åŠ æƒéšæœº
    const weights = SCENE_WEIGHTS[scene] || SCENE_WEIGHTS.afternoon;
    const entries = [];
    for (const [cat, w] of Object.entries(weights)) {
        if (ACT[cat]) for (let i = 0; i < w; i++) entries.push(cat);
    }
    const cat = entries[Math.floor(Math.random() * entries.length)];
    const pool = ACT[cat];
    return pool[Math.floor(Math.random() * pool.length)];
}

setInterval(() => {
    if (currentMood !== 'idle' || !mouseTracking) return;

    const idleTime = (Date.now() - lastInteraction) / 1000; // ç§’

    // === æ— èŠæ¸è¿›ç³»ç»Ÿ ===
    if (idleTime > 180 && Math.random() < 0.25) {
        // 3 åˆ†é’Ÿæ²¡äº’åŠ¨ï¼šæ‰“å“ˆæ¬  / ä¼¸æ‡’è…°
        mouseTracking = false;
        const r = Math.random();
        if (r < 0.4) {
            // æ‰“å“ˆæ¬ ï¼šå˜´å·´å¼ å¤§ â†’ çœ¯çœ¼ â†’ å‘å‘†
            EXPR.wow();
            const s = targetScale;
            targetScale = 1.06;
            setTimeout(() => { EXPR.sleepy(); targetScale = s; }, 800);
            setTimeout(() => { EXPR.drowsy(); }, 1500);
            setTimeout(() => { EXPR.normal(); mouseTracking = true; }, 2500);
        } else if (r < 0.7) {
            // ä¼¸æ‡’è…° â†’ æŠ–ä¸€æŠ– â†’ ç²¾ç¥
            const s = targetScale;
            EXPR.sleepy();
            targetScale = 1.1;
            setTimeout(() => { targetScale = 0.92; }, 600);
            setTimeout(() => { targetScale = 1.06; EXPR.surprised(); }, 900);
            setTimeout(() => { targetScale = s; EXPR.normal(); mouseTracking = true; }, 1400);
        } else {
            // å‘å‘† â†’ æ…¢æ…¢å›ç¥
            EXPR.drowsy();
            setTimeout(() => EXPR.halfBlink(), 1200);
            setTimeout(() => { EXPR.blink(); }, 2000);
            setTimeout(() => { EXPR.curious(); }, 2200);
            setTimeout(() => { EXPR.normal(); mouseTracking = true; }, 2800);
        }
        return;
    }

    if (idleTime > 60 && Math.random() < 0.3) {
        // 1 åˆ†é’Ÿæ²¡äº’åŠ¨ï¼šæ›´å¤šå¼ æœ› / æ— èŠè¡Œä¸º
        mouseTracking = false;
        const r = Math.random();
        if (r < 0.3) {
            // å¹æ°”ï¼šæ·±å‘¼å¸ + åŠçœ¨çœ¼
            deepBreathPhase = 0.01;
            EXPR.halfBlink();
            setTimeout(() => { EXPR.normal(); mouseTracking = true; }, 1500);
        } else if (r < 0.6) {
            // å·¦å³å¼ æœ›ï¼Œåƒåœ¨æ‰¾äº‹åš
            EXPR.lookLeft();
            setTimeout(() => EXPR.lookUp(), 500);
            setTimeout(() => EXPR.lookRight(), 1000);
            setTimeout(() => { EXPR.hmm(); }, 1500);
            setTimeout(() => { EXPR.normal(); mouseTracking = true; }, 2200);
        } else {
            // æ— èŠæ­ªå¤´
            EXPR.hmm();
            const s = targetScale;
            targetScale = 0.97;
            setTimeout(() => { targetScale = s; EXPR.blink(); }, 1000);
            setTimeout(() => { EXPR.normal(); mouseTracking = true; }, 1300);
        }
        return;
    }

    // === å¸¸è§„å¾…æœºå¾®è¡¨æƒ…ï¼ˆ30% è§¦å‘ç‡ï¼‰===
    if (Math.random() < 0.3) {
        mouseTracking = false;
        pickIdleAction()();
        setTimeout(() => { mouseTracking = true; }, 1500);
    }
}, 4000);

// === å¾…æœºçœ¼ç¥æ¸¸èµ°ï¼ˆç‹¬ç«‹äºå¾®è¡¨æƒ…ï¼‰===
setInterval(() => {
    if (currentMood !== 'idle' || !mouseTracking) return;
    if (Math.random() < 0.35) {
        // çœ¼ç›ç¼“æ…¢é£˜å‘ä¸€ä¸ªéšæœºæ–¹å‘ï¼Œåƒåœ¨"çœ‹"ä»€ä¹ˆ
        const dx = (Math.random() - 0.5) * 4;
        const dy = (Math.random() - 0.5) * 3;
        eyeL.style.transition = 'transform 0.8s ease';
        eyeR.style.transition = 'transform 0.8s ease';
        eyeL.style.transform = `translate(${dx}px,${dy}px)`;
        eyeR.style.transform = `translate(${dx}px,${dy}px)`;
        // åœç•™ä¸€ä¼šå†é£˜å›æ¥
        setTimeout(() => {
            eyeL.style.transition = 'transform 1.2s ease';
            eyeR.style.transition = 'transform 1.2s ease';
            eyeL.style.transform = '';
            eyeR.style.transform = '';
            setTimeout(() => {
                eyeL.style.transition = '';
                eyeR.style.transition = '';
            }, 1200);
        }, 1500 + Math.random() * 2000);
    }
}, 5000);

// è®°å½•äº’åŠ¨æ—¶é—´
pet.addEventListener('mousedown', () => { lastInteraction = Date.now(); });
document.addEventListener('keydown', () => { lastInteraction = Date.now(); });

// ===== å·¥å…·æ  =====
function toggleInput() {
    inputBar.classList.toggle('show');
    if (inputBar.classList.contains('show')) inputEl.focus();
}

function toggleVoice() {
    voiceOn = !voiceOn;
    btnVoice.innerHTML = voiceOn
        ? '<svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>'
        : '<svg viewBox="0 0 24 24"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2c0 .76-.12 1.5-.35 2.18"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';
    btnVoice.classList.toggle('active', voiceOn);
    if (electronAPI) electronAPI.invoke('set-voice-enabled', voiceOn);
    setMood('happy');
    setTimeout(() => setMood('idle'), 1500);
}

// ===== æ¨¡å‹åˆ‡æ¢ (CC Switché£æ ¼) =====
const modelBadge = document.getElementById('modelBadge');
let currentModelColor = '#E8A838';

async function cycleModel() {
    if (!electronAPI) return;
    setMood('thinking');
    const model = await electronAPI.invoke('model-next');
    if (model) {
        updateModelBadge(model);
        // çƒä½“é—ªå˜åŠ¨ç”»
        flashModelSwitch(model.color);
        setMood('happy');
        setTimeout(() => setMood('idle'), 2000);
    } else {
        setMood('idle');
    }
}

function updateModelBadge(model) {
    if (!modelBadge || !model) return;
    modelBadge.textContent = model.icon;
    modelBadge.style.color = model.color;
    currentModelColor = model.color;
}

function flashModelSwitch(color) {
    // çƒä½“å¿«é€Ÿé—ªå˜æ•ˆæœ
    const pet = document.getElementById('pet');
    pet.style.transition = 'filter 0.15s';
    pet.style.filter = `brightness(1.5) drop-shadow(0 0 15px ${color})`;
    setTimeout(() => {
        pet.style.filter = '';
        pet.style.transition = '';
    }, 400);
}

// åˆå§‹åŒ–æ—¶è·å–å½“å‰æ¨¡å‹
if (electronAPI) {
    electronAPI.invoke('model-current').then(model => {
        if (model) updateModelBadge(model);
    });

    // ç›‘å¬æ¨¡å‹å˜æ›´äº‹ä»¶ï¼ˆæ¥è‡ªæ‰˜ç›˜èœå•åˆ‡æ¢ï¼‰
    electronAPI.on('model-changed', (model) => {
        updateModelBadge(model);
        flashModelSwitch(model.color);
    });
}

async function screenshot() {
    if (!electronAPI) return;
    setMood('thinking');
    const result = await electronAPI.invoke('take-screenshot', 'manual');
    if (result.success) {
        setMood('happy');
        setTimeout(() => setMood('idle'), 2000);
    } else { setMood('idle'); }
}

async function send() {
    const msg = inputEl.value.trim();
    if (!msg || !electronAPI) return;
    inputEl.value = '';
    inputBar.classList.remove('show');
    setMood('thinking');
    const reply = await electronAPI.invoke('openclaw-send', msg);
    if (reply) { setMood('happy'); setTimeout(() => setMood('idle'), 3000); }
}

// ===== IPC =====
if (electronAPI) {
    electronAPI.on('new-message', (msg) => {
        setMood('talking');
        setTimeout(() => setMood('idle'), 3000);
    });
    electronAPI.on('agent-response', (res) => {
        lastTone = detectTone(res.content);
        // ğŸ­ æ ¹æ® emotion ç›´æ¥åˆ‡æ¢å¯¹åº”çš„ moodï¼ˆæ¯ç§éƒ½æœ‰ç‹¬ç«‹é…è‰²ï¼‰
        const emotionMoodMap = {
            happy: 'happy',
            surprised: 'surprised',
            sad: 'sad',
            fearful: 'fearful',
            angry: 'angry',
            thinking: 'thinking',
            calm: 'calm',
            disgusted: 'angry',
            excited: 'excited',
            love: 'love',
            focused: 'focused'
        };
        const mood = emotionMoodMap[res.emotion] || 'calm';
        setMood(mood);
        // æ ¹æ®æƒ…ç»ªè°ƒæ•´æ¢å¤æ—¶é—´
        const recoveryTime = (mood === 'thinking') ? 8000 : (mood === 'sad') ? 7000 : (mood === 'fearful') ? 6000 : 5000;
        setTimeout(() => setMood('idle'), recoveryTime);
    });
    electronAPI.on('status-update', (s) => {
        const wasConnected = isConnected;
        isConnected = s.connected;
        if (!wasConnected && isConnected) {
            // å¤æ´»åŠ¨ç”»ï¼ä»ç°è‰²â†’å½©è‰²
            setMood('happy');
            squishing = true;
            pet.style.animation = 'squish 0.5s ease';
            setTimeout(() => { pet.style.animation = ''; squishing = false; }, 500);
            spawnParticles();
            spawnParticles(); // åŒå€ç²’å­åº†ç¥
            setTimeout(() => setMood('idle'), 3000);
        } else if (wasConnected && !isConnected) {
            setMood('offline');
        }
    });
}

// çŠ¶æ€æ£€æŸ¥
if (electronAPI) {
    setInterval(async () => {
        const s = await electronAPI.invoke('openclaw-status');
        const wasConnected = isConnected;
        isConnected = s.connected;
        if (!wasConnected && isConnected && currentMood === 'offline') {
            // å¤æ´»ï¼
            setMood('happy');
            squishing = true;
            pet.style.animation = 'squish 0.5s ease';
            setTimeout(() => { pet.style.animation = ''; squishing = false; }, 500);
            spawnParticles();
            spawnParticles();
            setTimeout(() => setMood('idle'), 3000);
        } else if (!isConnected && currentMood !== 'offline') {
            setMood('offline');
        }
    }, 10000);
}

// åˆå§‹åŒ– â€” å…ˆæ˜¾ç¤ºç¦»çº¿ï¼Œç­‰è¿æ¥æˆåŠŸåå¤æ´»
setMood('offline');
if (electronAPI) {
    setTimeout(async () => {
        const s = await electronAPI.invoke('openclaw-status');
        isConnected = s.connected;
        if (isConnected) {
            setMood('happy');
            squishing = true;
            pet.style.animation = 'squish 0.5s ease';
            setTimeout(() => { pet.style.animation = ''; squishing = false; }, 500);
            spawnParticles();
            setTimeout(() => setMood('idle'), 2000);
        }
    }, 1500);
}
</script>
</body>
</html>
