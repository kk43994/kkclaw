<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>KKClaw Switch</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
  background: linear-gradient(145deg, #0a0a14 0%, #0d1117 40%, #0f1520 100%);
  color: #e0e0e0; user-select: none; overflow-y: auto; overflow-x: hidden;
  min-height: 100vh;
}

/* ËÉåÊôØÂÖâÊôïË£ÖÈ•∞ */
body::before {
  content: ''; position: fixed; top: -120px; right: -80px;
  width: 300px; height: 300px; border-radius: 50%;
  background: radial-gradient(circle, #7C6BF015 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}
body::after {
  content: ''; position: fixed; bottom: -100px; left: -60px;
  width: 250px; height: 250px; border-radius: 50%;
  background: radial-gradient(circle, #4ECDC410 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}

/* ÊªöÂä®Êù° */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #ffffff15; border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: #ffffff30; }

/* ===== ÁêâÁíÉÊ†áÈ¢òÊ†è ===== */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px 12px; position: sticky; top: 0; z-index: 10;
  background: rgba(12, 12, 20, 0.85); backdrop-filter: blur(20px) saturate(1.2);
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.header-left { display: flex; align-items: center; gap: 10px; }
.header-title {
  font-size: 17px; font-weight: 700;
  background: linear-gradient(135deg, #a78bfa, #67e8f9);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: 0.5px;
}
.header-right { display: flex; align-items: center; gap: 5px; }
.header-tab {
  padding: 5px 12px; border-radius: 10px; font-size: 12px; font-weight: 500;
  cursor: pointer; color: #666; transition: all 0.3s; border: 1px solid transparent;
}
.header-tab:hover { color: #bbb; background: rgba(255,255,255,0.04); }
.header-tab.active {
  color: #e0e0e0;
  background: linear-gradient(135deg, rgba(124,107,240,0.12), rgba(78,205,196,0.08));
  border-color: rgba(124,107,240,0.2);
  box-shadow: 0 0 12px rgba(124,107,240,0.08);
}
.header-add {
  width: 28px; height: 28px; border-radius: 10px; border: none;
  background: linear-gradient(135deg, #7C6BF0, #6366F1); color: #fff;
  font-size: 18px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all 0.3s; margin-left: 2px;
  box-shadow: 0 2px 8px rgba(124,107,240,0.3);
}
.header-add:hover { transform: scale(1.08); box-shadow: 0 4px 16px rgba(124,107,240,0.4); }
.lang-toggle {
  font-size: 10px; color: #555; cursor: pointer; padding: 3px 7px;
  border-radius: 6px; border: 1px solid rgba(255,255,255,0.06); transition: all 0.2s;
  margin-right: 4px;
}
.lang-toggle:hover { color: #aaa; background: rgba(255,255,255,0.05); }

/* ===== ÁêâÁíÉÂç°ÁâáÂü∫Á°Ä ===== */
.glass-card {
  background: linear-gradient(135deg, rgba(20,22,36,0.8), rgba(24,28,48,0.6));
  border-radius: 14px; border: 1px solid rgba(255,255,255,0.05);
  backdrop-filter: blur(12px);
  box-shadow: 0 2px 12px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.03);
  transition: all 0.3s;
}
.glass-card:hover {
  border-color: rgba(255,255,255,0.1);
  box-shadow: 0 4px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
}

/* ===== ÂΩìÂâçÊ®°ÂûãÊåáÁ§∫Âô® ===== */
.current-indicator {
  margin: 0 16px 12px; padding: 14px 16px;
  display: flex; align-items: center; gap: 12px;
  position: relative; overflow: hidden;
}
.current-indicator::before {
  content: ''; position: absolute; top: -30px; right: -20px;
  width: 100px; height: 100px; border-radius: 50%;
  background: radial-gradient(circle, rgba(124,107,240,0.15), transparent);
  pointer-events: none;
}
.current-icon {
  width: 44px; height: 44px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 16px; color: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  position: relative; z-index: 1;
}
.current-info { flex: 1; position: relative; z-index: 1; }
.current-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600; }
.current-model-name { font-size: 16px; font-weight: 700; color: #fff; margin-top: 2px; }
.current-provider-name { font-size: 11px; color: #555; margin-top: 1px; }
.current-switch-btn {
  padding: 7px 16px; border-radius: 10px;
  border: 1px solid rgba(124,107,240,0.25);
  background: linear-gradient(135deg, rgba(124,107,240,0.1), rgba(99,102,241,0.05));
  color: #a78bfa; font-size: 12px; font-weight: 500;
  cursor: pointer; transition: all 0.3s; position: relative; z-index: 1;
}
.current-switch-btn:hover {
  background: linear-gradient(135deg, rgba(124,107,240,0.2), rgba(99,102,241,0.1));
  box-shadow: 0 0 16px rgba(124,107,240,0.15);
}

/* ===== Provider Âç°Áâá ===== */
.provider-list { padding: 0 14px 14px; }
.provider-card {
  padding: 14px; margin-bottom: 8px;
  display: flex; align-items: center; gap: 12px;
  cursor: pointer; position: relative; overflow: hidden;
}
.provider-card.current {
  border-color: rgba(78,205,196,0.25);
  background: linear-gradient(135deg, rgba(15,42,40,0.8), rgba(20,50,48,0.5));
  box-shadow: 0 2px 16px rgba(78,205,196,0.08), inset 0 1px 0 rgba(78,205,196,0.05);
}
.provider-card.current::after {
  content: ''; position: absolute; top: -20px; right: -10px;
  width: 60px; height: 60px; border-radius: 50%;
  background: radial-gradient(circle, rgba(78,205,196,0.12), transparent);
}

.drag-handle { display: flex; flex-direction: column; gap: 2px; cursor: grab; opacity: 0.2; padding: 3px; transition: opacity 0.2s; }
.drag-handle:hover { opacity: 0.5; }
.drag-dot { display: flex; gap: 2px; }
.drag-dot span { width: 2px; height: 2px; border-radius: 50%; background: #888; }

.provider-icon {
  width: 38px; height: 38px; border-radius: 10px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 15px; color: #fff;
  box-shadow: 0 3px 10px rgba(0,0,0,0.25);
}
.provider-info { flex: 1; min-width: 0; }
.provider-name-row { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
.provider-name { font-size: 13px; font-weight: 600; color: #eee; }
.provider-badge {
  font-size: 9px; padding: 2px 7px; border-radius: 6px; font-weight: 600;
  background: linear-gradient(135deg, rgba(78,205,196,0.15), rgba(78,205,196,0.08));
  color: #67e8f9; border: 1px solid rgba(78,205,196,0.15);
}
.provider-url { font-size: 10px; color: #444; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; }

.provider-right { text-align: right; flex-shrink: 0; }
.provider-speed { font-size: 11px; color: #555; margin-bottom: 2px; }
.provider-speed.fast { color: #67e8f9; }
.provider-speed.medium { color: #fbbf24; }
.provider-speed.slow { color: #f87171; }
.provider-models-count { font-size: 10px; color: #444; }
.provider-actions-row { display: flex; gap: 3px; margin-top: 4px; justify-content: flex-end; }

/* ===== Ê®°ÂûãÂàóË°® ===== */
.model-panel { padding: 0 14px 14px; }
.model-section-title {
  font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1.5px;
  padding: 8px 0 4px; font-weight: 600;
}
.model-grid { display: flex; flex-direction: column; gap: 3px; margin-bottom: 10px; }
.model-row {
  display: flex; align-items: center; gap: 8px; padding: 8px 10px;
  border-radius: 10px; cursor: pointer; transition: all 0.2s;
}
.model-row:hover { background: rgba(255,255,255,0.03); }
.model-row.active {
  background: linear-gradient(135deg, rgba(124,107,240,0.08), rgba(99,102,241,0.04));
  box-shadow: inset 0 0 0 1px rgba(124,107,240,0.15);
}
.model-icon-sm {
  width: 26px; height: 26px; border-radius: 7px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 10px; color: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.model-name-text { font-size: 12px; flex: 1; color: #ccc; }
.model-tags { display: flex; gap: 3px; align-items: center; }
.model-tag {
  font-size: 9px; padding: 1px 6px; border-radius: 5px;
  background: rgba(255,255,255,0.04); color: #666;
  border: 1px solid rgba(255,255,255,0.04);
}
.model-tag.reasoning { background: rgba(251,191,36,0.08); color: #fbbf24; border-color: rgba(251,191,36,0.1); }
.model-check-mark { font-size: 13px; color: #a78bfa; width: 18px; text-align: center; }

/* ===== Ê∑ªÂä† Provider ===== */
.add-panel { padding: 10px 14px; }
.preset-section-title { font-size: 12px; font-weight: 600; color: #888; margin-bottom: 8px; }
.preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 14px; }
.preset-card {
  background: linear-gradient(135deg, rgba(20,22,36,0.7), rgba(24,28,48,0.5));
  border-radius: 12px; padding: 10px 8px; text-align: center; cursor: pointer;
  border: 1px solid rgba(255,255,255,0.04); transition: all 0.3s; position: relative;
  backdrop-filter: blur(8px);
}
.preset-card:hover {
  border-color: rgba(255,255,255,0.12); transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}
.preset-card.selected {
  border-color: rgba(124,107,240,0.4);
  background: linear-gradient(135deg, rgba(124,107,240,0.1), rgba(99,102,241,0.05));
  box-shadow: 0 0 20px rgba(124,107,240,0.1);
}
.preset-card-icon {
  width: 30px; height: 30px; border-radius: 8px; margin: 0 auto 4px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 13px; color: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}
.preset-card-name { font-size: 10px; font-weight: 600; color: #ccc; }
.preset-card-desc { font-size: 9px; color: #555; margin-top: 1px; }
.preset-card-count {
  position: absolute; top: 4px; right: 4px;
  font-size: 8px; background: rgba(255,255,255,0.06); padding: 1px 4px;
  border-radius: 4px; color: #666;
}

/* ===== ÁêâÁíÉË°®Âçï ===== */
.form-section { margin-top: 12px; }
.form-group { margin-bottom: 10px; }
.form-label { font-size: 11px; color: #666; margin-bottom: 3px; display: block; font-weight: 500; }
.form-input {
  width: 100%; padding: 9px 12px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.06);
  background: rgba(10,10,18,0.6); color: #e0e0e0; font-size: 12px; outline: none;
  transition: all 0.3s; backdrop-filter: blur(4px);
}
.form-input:focus {
  border-color: rgba(124,107,240,0.4);
  box-shadow: 0 0 12px rgba(124,107,240,0.1);
}
.form-input::placeholder { color: #333; }
.form-select {
  width: 100%; padding: 9px 12px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.06);
  background: rgba(10,10,18,0.6); color: #e0e0e0; font-size: 12px;
  outline: none; cursor: pointer;
}
.form-row { display: flex; gap: 8px; }
.form-row > * { flex: 1; }
.form-hint { font-size: 10px; color: #444; margin-top: 3px; }

/* ===== ÁºñËæëÈù¢Êùø ===== */
.edit-panel { padding: 10px 14px; }
.edit-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
.edit-back {
  width: 30px; height: 30px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.06);
  background: rgba(255,255,255,0.02); color: #666; font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.edit-back:hover { background: rgba(255,255,255,0.06); color: #ccc; }
.edit-title { font-size: 15px; font-weight: 600; }
.edit-provider-icon {
  width: 36px; height: 36px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 14px; color: #fff;
}

/* ===== ÁêâÁíÉÊåâÈíÆ ===== */
.btn {
  padding: 7px 14px; border-radius: 10px; border: none;
  font-size: 11px; cursor: pointer; font-weight: 500; transition: all 0.3s;
  display: inline-flex; align-items: center; gap: 4px;
}
.btn-primary {
  background: linear-gradient(135deg, #7C6BF0, #6366F1); color: #fff;
  box-shadow: 0 3px 12px rgba(124,107,240,0.3);
}
.btn-primary:hover { box-shadow: 0 5px 20px rgba(124,107,240,0.4); transform: translateY(-1px); }
.btn-danger {
  background: rgba(248,113,113,0.08); color: #f87171;
  border: 1px solid rgba(248,113,113,0.15);
}
.btn-danger:hover { background: rgba(248,113,113,0.15); }
.btn-ghost {
  background: rgba(255,255,255,0.03); color: #888;
  border: 1px solid rgba(255,255,255,0.06);
}
.btn-ghost:hover { background: rgba(255,255,255,0.06); color: #ccc; }
.btn-speed {
  background: rgba(103,232,249,0.06); color: #67e8f9;
  border: 1px solid rgba(103,232,249,0.15);
}
.btn-speed:hover { background: rgba(103,232,249,0.12); }
.btn-sm { padding: 4px 8px; font-size: 10px; border-radius: 7px; }
.btn-block { width: 100%; justify-content: center; }

.divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); margin: 12px 0; }

/* ===== Toast ===== */
.toast {
  position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
  padding: 8px 20px; border-radius: 12px; font-size: 12px; font-weight: 500;
  opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100;
  backdrop-filter: blur(16px);
}
.toast.show { opacity: 1; }
.toast-success { background: rgba(39,174,96,0.9); color: #fff; box-shadow: 0 4px 16px rgba(39,174,96,0.3); }
.toast-error { background: rgba(231,76,60,0.9); color: #fff; box-shadow: 0 4px 16px rgba(231,76,60,0.3); }
.toast-info { background: rgba(52,152,219,0.9); color: #fff; box-shadow: 0 4px 16px rgba(52,152,219,0.3); }

.panel { display: none; }
.panel.active { display: block; }

.empty-state { text-align: center; padding: 32px 16px; color: #444; }
.empty-icon { font-size: 36px; margin-bottom: 10px; opacity: 0.2; }
.empty-text { font-size: 13px; margin-bottom: 6px; color: #555; }
.empty-hint { font-size: 11px; color: #333; }

@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
.testing { animation: pulse 1s infinite; }

/* ===== ÁõëÊéßÊó•Âøó ===== */
.log-toolbar {
  display: flex; align-items: center; gap: 6px; padding: 8px 14px;
  flex-wrap: wrap;
}
.log-filter {
  padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 500;
  cursor: pointer; color: #666; background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s;
}
.log-filter:hover { color: #bbb; background: rgba(255,255,255,0.06); }
.log-filter.active { color: #a78bfa; border-color: rgba(124,107,240,0.3); background: rgba(124,107,240,0.08); }
.log-container {
  padding: 0 14px 14px; max-height: calc(100vh - 140px);
  overflow-y: auto; font-family: 'Consolas', 'Monaco', monospace;
}
.log-entry {
  display: flex; align-items: flex-start; gap: 8px; padding: 5px 8px;
  border-radius: 6px; margin-bottom: 2px; font-size: 11px; line-height: 1.5;
  transition: background 0.15s;
}
.log-entry:hover { background: rgba(255,255,255,0.02); }
.log-time { color: #444; white-space: nowrap; flex-shrink: 0; font-size: 10px; }
.log-level {
  padding: 1px 5px; border-radius: 4px; font-size: 9px; font-weight: 600;
  flex-shrink: 0; text-transform: uppercase; min-width: 46px; text-align: center;
}
.log-level-info { background: rgba(59,130,246,0.12); color: #60a5fa; }
.log-level-success { background: rgba(34,197,94,0.12); color: #4ade80; }
.log-level-warn { background: rgba(251,191,36,0.12); color: #fbbf24; }
.log-level-error { background: rgba(248,113,113,0.12); color: #f87171; }
.log-action { color: #ccc; flex-shrink: 0; }
.log-detail { color: #666; word-break: break-all; }
.log-empty { text-align: center; padding: 40px 16px; color: #444; font-size: 12px; }

.model-edit-row {
  display: flex; align-items: center; gap: 8px; padding: 5px 0;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.model-edit-row:last-child { border-bottom: none; }
.model-edit-name { flex: 1; font-size: 12px; }
.model-edit-id { font-size: 10px; color: #444; flex: 1; }
</style>
</head>
<body>

<!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
<div class="header">
  <div class="header-left">
    <span class="header-title">KKClaw Switch</span>
  </div>
  <div class="header-right">
    <span class="lang-toggle" onclick="toggleLang()" id="langBtn">‰∏≠/EN</span>
    <div class="header-tab active" data-tab="main" onclick="showTab('main')"><span data-t="providers">ÊúçÂä°ÂïÜ</span></div>
    <div class="header-tab" data-tab="models" onclick="showTab('models')"><span data-t="models">Ê®°Âûã</span></div>
    <div class="header-tab" data-tab="logs" onclick="showTab('logs')"><span data-t="logs">Êó•Âøó</span></div>
    <button class="header-add" onclick="showTab('add')" title="Ê∑ªÂä†">+</button>
  </div>
</div>

<!-- Panel 1: Provider ÂàóË°® -->
<div id="panel-main" class="panel active">
  <div class="current-indicator glass-card" id="currentIndicator"></div>
  <div style="padding: 0 14px 6px; display: flex; gap: 6px; flex-wrap: wrap;">
    <button class="btn btn-speed btn-sm" onclick="speedTestAll()" id="speedTestAllBtn"><span data-t="testAll">‚è± ÂÖ®ÈÉ®ÊµãÈÄü</span></button>
    <button class="btn btn-ghost btn-sm" onclick="refreshAll()"><span data-t="refresh">‚Üª Âà∑Êñ∞</span></button>
  </div>
  <div class="provider-list" id="providerList"></div>
</div>

<!-- Panel 2: Ê®°ÂûãÂàóË°® -->
<div id="panel-models" class="panel">
  <div class="model-panel" id="modelPanel"></div>
</div>

<!-- Panel 3: Ê∑ªÂä† Provider -->
<div id="panel-add" class="panel">
  <div class="add-panel">
    <div class="preset-section-title"><span data-t="presetTitle">ÈÄâÊã©È¢ÑËÆæ</span></div>
    <div class="preset-grid" id="presetGrid"></div>
    
    <div class="form-hint" style="text-align: center; margin-bottom: 12px;">
      <span data-t="presetHint">üí° ÈÄâÊã©È¢ÑËÆæÂêéÂè™ÈúÄÂ°´ÂÜô API Key</span><br>
      <span style="color:#67e8f9; font-size:10px;"><span data-t="relayHint">Ê≤°Êúâ API KeyÔºüËØïËØï</span> <a href="https://api.kk666.online" target="_blank" style="color:#a78bfa;text-decoration:none;">api.kk666.online</a></span>
    </div>
    
    <div class="divider"></div>
    
    <div class="form-section">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label"><span data-t="providerName">ÂêçÁß∞</span> *</label>
          <input class="form-input" id="addName" placeholder="e.g. MyOpenAI">
        </div>
        <div class="form-group">
          <label class="form-label"><span data-t="notes">Â§áÊ≥®</span></label>
          <input class="form-input" id="addNotes" placeholder="e.g. ÂÖ¨Âè∏Ë¥¶Âè∑">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Base URL *</label>
        <input class="form-input" id="addBaseUrl" placeholder="https://api.kk666.online/v1" value="https://api.kk666.online/v1">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">API Key *</label>
          <input class="form-input" id="addApiKey" type="password" placeholder="sk-...">
        </div>
        <div class="form-group">
          <label class="form-label"><span data-t="apiType">Êé•Âè£Á±ªÂûã</span></label>
          <select class="form-select" id="addApiType">
            <option value="anthropic-messages">Anthropic Messages (Claude)</option>
            <option value="openai-completions">OpenAI Completions (GPT/DeepSeek/Gemini/Qwen...)</option>
            <option value="openai-responses">OpenAI Responses (GPT-5/Codex)</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>
      
      <div style="font-size: 11px; color: #666; margin-bottom: 6px;"><span data-t="modelsOptional">Ê®°ÂûãÔºàÂèØÈÄâÔºâ</span></div>
      <div id="addModelRows">
        <div class="form-row" style="margin-bottom: 6px;">
          <input class="form-input" placeholder="Model ID (e.g. gpt-4o)" data-field="id">
          <input class="form-input" placeholder="ÊòæÁ§∫ÂêçÁß∞" data-field="name">
        </div>
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-bottom: 12px;" onclick="addModelRow()"><span data-t="addModel">+ Ê∑ªÂä†Ê®°Âûã</span></button>

      <div style="display: flex; gap: 8px;">
        <button class="btn btn-primary btn-block" onclick="submitProvider()"><span data-t="addBtn">+ Ê∑ªÂä†</span></button>
        <button class="btn btn-ghost" onclick="showTab('main')"><span data-t="cancel">ÂèñÊ∂à</span></button>
      </div>
    </div>
  </div>
</div>

<!-- Panel 4: ÁºñËæë -->
<div id="panel-edit" class="panel">
  <div class="edit-panel" id="editPanel"></div>
</div>

<!-- Panel 5: ÁõëÊéßÊó•Âøó -->
<div id="panel-logs" class="panel">
  <div class="log-toolbar">
    <span class="log-filter active" data-level="all" onclick="filterLogs('all',this)"><span data-t="logAll">ÂÖ®ÈÉ®</span></span>
    <span class="log-filter" data-level="success" onclick="filterLogs('success',this)"><span data-t="logSuccess">ÊàêÂäü</span></span>
    <span class="log-filter" data-level="info" onclick="filterLogs('info',this)"><span data-t="logInfo">‰ø°ÊÅØ</span></span>
    <span class="log-filter" data-level="warn" onclick="filterLogs('warn',this)"><span data-t="logWarn">Ë≠¶Âëä</span></span>
    <span class="log-filter" data-level="error" onclick="filterLogs('error',this)"><span data-t="logError">ÈîôËØØ</span></span>
    <span style="flex:1"></span>
    <button class="btn btn-ghost btn-sm" onclick="refreshLogs()"><span data-t="logRefresh">‚Üª Âà∑Êñ∞</span></button>
    <button class="btn btn-danger btn-sm" onclick="clearLogs()"><span data-t="logClear">Ê∏ÖÈô§</span></button>
  </div>
  <div class="log-container" id="logContainer"></div>
</div>

<div class="toast" id="toast"></div>

<script>
let allModels = [], allProviders = [], currentModel = null, selectedPreset = null, editingProvider = null;

// ===== i18n =====
let currentLang = 'zh';
const i18n = {
  zh: { providers:'ÊúçÂä°ÂïÜ', models:'Ê®°Âûã', testAll:'‚è± ÂÖ®ÈÉ®ÊµãÈÄü', refresh:'‚Üª Âà∑Êñ∞',
    currentlyUsing:'ÂΩìÂâç‰ΩøÁî®', switchBtn:'ÂàáÊç¢', noModel:'Êú™ÈÄâÊã©Ê®°Âûã',
    noProviders:'ÊöÇÊó†ÊúçÂä°ÂïÜ', noProvidersHint:'ÁÇπÂáª + Ê∑ªÂä†', presetTitle:'ÈÄâÊã©È¢ÑËÆæ',
    presetHint:'üí° ÈÄâÊã©È¢ÑËÆæÂêéÂè™ÈúÄÂ°´ÂÜô API Key', relayHint:'Ê≤°Êúâ API KeyÔºüËØïËØï',
    providerName:'ÂêçÁß∞', notes:'Â§áÊ≥®', apiType:'Êé•Âè£Á±ªÂûã', modelsOptional:'Ê®°ÂûãÔºàÂèØÈÄâÔºâ',
    addModel:'+ Ê∑ªÂä†Ê®°Âûã', addBtn:'+ Ê∑ªÂä†', cancel:'ÂèñÊ∂à', displayName:'ÊòæÁ§∫ÂêçÁß∞',
    noModels:'ÊöÇÊó†Ê®°Âûã', noModelsHint:'ËØ∑ÂÖàÊ∑ªÂä†ÊúçÂä°ÂïÜ', saveChanges:'‰øùÂ≠ò', test:'‚è± ÊµãÈÄü',
    delete:'Âà†Èô§', keySet:'‚úÖ Â∑≤ÈÖçÁΩÆ', keyNotSet:'‚ùå Êú™ÈÖçÁΩÆ',
    testing:'‚è± ÊµãÈÄü‰∏≠...', testComplete:'ÊµãÈÄüÂÆåÊàê', refreshed:'Â∑≤Âà∑Êñ∞',
    switched:'Â∑≤ÂàáÊç¢Âà∞', added:'Â∑≤Ê∑ªÂä†', updated:'Â∑≤Êõ¥Êñ∞', deleted:'Â∑≤Âà†Èô§', removed:'Â∑≤ÁßªÈô§',
    enterName:'ËØ∑ËæìÂÖ•ÂêçÁß∞', enterKey:'ËØ∑ËæìÂÖ• API Key', enterModelId:'ËØ∑ËæìÂÖ•Ê®°Âûã ID',
    noChanges:'Êó†Êõ¥Êîπ', confirmDelete:'Á°ÆËÆ§Âà†Èô§', confirmDeleteHint:'ÔºüÊâÄÊúâÊ®°ÂûãÂ∞Ü‰∏çÂèØÁî®',
    confirmRemove:'Á°ÆËÆ§ÁßªÈô§Ê®°Âûã',
    logs:'Êó•Âøó', logAll:'ÂÖ®ÈÉ®', logSuccess:'ÊàêÂäü', logInfo:'‰ø°ÊÅØ', logWarn:'Ë≠¶Âëä', logError:'ÈîôËØØ',
    logRefresh:'‚Üª Âà∑Êñ∞', logClear:'Ê∏ÖÈô§', logEmpty:'ÊöÇÊó†Êó•Âøó', logCleared:'Êó•ÂøóÂ∑≤Ê∏ÖÈô§' },
  en: { providers:'Providers', models:'Models', testAll:'‚è± Test All', refresh:'‚Üª Refresh',
    currentlyUsing:'Currently Using', switchBtn:'Switch', noModel:'No model selected',
    noProviders:'No providers', noProvidersHint:'Click + to add', presetTitle:'Provider Preset',
    presetHint:'üí° Only need API Key', relayHint:"No API Key? Try",
    providerName:'Name', notes:'Notes', apiType:'API Type', modelsOptional:'Models (optional)',
    addModel:'+ Add Model', addBtn:'+ Add', cancel:'Cancel', displayName:'Display Name',
    noModels:'No models', noModelsHint:'Add a provider first', saveChanges:'Save', test:'‚è± Test',
    delete:'Delete', keySet:'‚úÖ Key set', keyNotSet:'‚ùå No key',
    testing:'‚è± Testing...', testComplete:'Done!', refreshed:'Refreshed',
    switched:'Switched to', added:'Added', updated:'Updated', deleted:'Deleted', removed:'Removed',
    enterName:'Enter name', enterKey:'Enter API Key', enterModelId:'Enter model ID',
    noChanges:'No changes', confirmDelete:'Delete', confirmDeleteHint:'? All models unavailable.',
    confirmRemove:'Remove model',
    logs:'Logs', logAll:'All', logSuccess:'Success', logInfo:'Info', logWarn:'Warn', logError:'Error',
    logRefresh:'‚Üª Refresh', logClear:'Clear', logEmpty:'No logs yet', logCleared:'Logs cleared' }
};
function t(k) { return i18n[currentLang][k] || i18n.en[k] || k; }
function toggleLang() { currentLang = currentLang==='zh'?'en':'zh'; document.getElementById('langBtn').textContent = currentLang==='zh'?'‰∏≠/EN':'EN/‰∏≠'; applyLang(); }
function applyLang() {
  document.querySelectorAll('[data-t]').forEach(el => { const k=el.getAttribute('data-t'); if(i18n[currentLang][k]) el.textContent=i18n[currentLang][k]; });
  if(document.getElementById('panel-main').classList.contains('active')){ renderCurrentIndicator(); renderProviderList(); }
  if(document.getElementById('panel-models').classList.contains('active')){ loadModels(); }
}

// ===== XSS Safety Helpers =====
function escHtml(v) {
  return String(v ?? '').replace(/[&<>"']/g, ch => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
  }[ch]));
}
function encArg(v) { return encodeURIComponent(String(v ?? '')); }

// ===== Tab =====
function showTab(name) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.header-tab').forEach(t=>t.classList.remove('active'));
  const panel=document.getElementById(`panel-${name}`); if(panel) panel.classList.add('active');
  const tab=document.querySelector(`.header-tab[data-tab="${name}"]`); if(tab) tab.classList.add('active');
  if(name==='main') loadAll(); if(name==='models') loadModels(); if(name==='add') loadPresets(); if(name==='logs') loadLogs();
}

async function loadAll() {
  if(!electronAPI) return;
  const s=await electronAPI.invoke('model-full-status'); if(!s) return;
  allModels=s.models||[]; allProviders=s.providers||[]; currentModel=s.current;
  renderCurrentIndicator(); renderProviderList();
}

function renderCurrentIndicator() {
  const el=document.getElementById('currentIndicator');
  if(!currentModel){ el.innerHTML=`<div class="empty-state" style="padding:12px;"><div class="empty-text">${t('noModel')}</div></div>`; return; }
  el.innerHTML=`
    <div class="current-icon" style="background:${currentModel.color}">${escHtml(currentModel.icon)}</div>
    <div class="current-info"><div class="current-label">${t('currentlyUsing')}</div>
    <div class="current-model-name">${escHtml(currentModel.shortName)}</div>
    <div class="current-provider-name">${escHtml(currentModel.provider)} ¬∑ ${escHtml(currentModel.modelId)}</div></div>
    <button class="current-switch-btn" onclick="showTab('models')">${t('switchBtn')}</button>`;
}

function renderProviderList() {
  const el=document.getElementById('providerList');
  if(allProviders.length===0){ el.innerHTML=`<div class="empty-state"><div class="empty-icon">‚äï</div><div class="empty-text">${t('noProviders')}</div><div class="empty-hint">${t('noProvidersHint')}</div></div>`; return; }
  el.innerHTML=allProviders.map(p=>{
    const cur=p.isCurrent, spd=renderSpeedBadge(p.speedTest);
    const n=encArg(p.name);
    return `<div class="provider-card glass-card ${cur?'current':''}" onclick="switchProvider(decodeURIComponent('${n}'))" ondblclick="event.stopPropagation();editProvider(decodeURIComponent('${n}'))">
      <div class="drag-handle"><div class="drag-dot"><span></span><span></span></div><div class="drag-dot"><span></span><span></span></div><div class="drag-dot"><span></span><span></span></div></div>
      <div class="provider-icon" style="background:${p.color}">${escHtml(p.icon)}</div>
      <div class="provider-info"><div class="provider-name-row"><span class="provider-name">${escHtml(p.name)}</span>${cur?`<span class="provider-badge">${t('currentlyUsing')}</span>`:''}</div>
      <div class="provider-url">${escHtml(p.website||p.baseUrl||'')}</div></div>
      <div class="provider-right">${spd}<div class="provider-models-count">${p.modelCount} model${p.modelCount!==1?'s':''}</div>
      <div class="provider-actions-row"><button class="btn btn-speed btn-sm" onclick="event.stopPropagation();speedTest(decodeURIComponent('${n}'))">‚è±</button>
      <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();editProvider(decodeURIComponent('${n}'))">‚úé</button></div></div></div>`;
  }).join('');
}

function renderSpeedBadge(s) {
  if(!s) return '<div class="provider-speed">--</div>';
  if(s.status==='error') return '<div class="provider-speed slow">Error</div>';
  const ms=s.latencyMs, cls=ms<1000?'fast':ms<3000?'medium':'slow';
  return `<div class="provider-speed ${cls}">${ms}ms</div>`;
}

async function speedTest(name) { if(!electronAPI) return; showToast(`${t('testing')}`,'info'); const r=await electronAPI.invoke('model-speed-test',name); showToast(r.status==='ok'?`${name}: ${r.latencyMs}ms`:`${name}: Error`,'success'); loadAll(); }
async function speedTestAll() { if(!electronAPI) return; const btn=document.getElementById('speedTestAllBtn'); btn.classList.add('testing'); showToast(t('testing'),'info'); await electronAPI.invoke('model-speed-test-all'); btn.classList.remove('testing'); showToast(t('testComplete'),'success'); loadAll(); }

async function loadModels() {
  if(!electronAPI) return;
  const s=await electronAPI.invoke('model-full-status'); if(!s) return;
  allModels=s.models||[]; currentModel=s.current;
  const panel=document.getElementById('modelPanel'), groups={};
  for(const m of allModels){ if(!groups[m.provider]) groups[m.provider]=[]; groups[m.provider].push(m); }
  let html='';
  for(const [prov,models] of Object.entries(groups)){
    html+=`<div class="model-section-title">${escHtml(prov)}</div><div class="model-grid">`;
    for(const m of models){ const act=currentModel?.id===m.id; const mid=encArg(m.id); html+=`
      <div class="model-row ${act?'active':''}" onclick="switchModel(decodeURIComponent('${mid}'))">
        <div class="model-icon-sm" style="background:${m.color}">${escHtml(m.icon)}</div>
        <div class="model-name-text">${escHtml(m.shortName)}</div>
        <div class="model-tags">${m.reasoning?'<span class="model-tag reasoning">üß†</span>':''}<span class="model-tag">${Math.round(m.contextWindow/1000)}K</span></div>
        <div class="model-check-mark">${act?'‚úì':''}</div></div>`; }
    html+='</div>';
  }
  if(!allModels.length) html=`<div class="empty-state"><div class="empty-icon">‚äò</div><div class="empty-text">${t('noModels')}</div><div class="empty-hint">${t('noModelsHint')}</div></div>`;
  panel.innerHTML=html;
}

async function switchModel(id) { if(!electronAPI) return; const r=await electronAPI.invoke('model-switch',id); if(r){ showToast(`${t('switched')} ${r.shortName}`,'success'); loadModels(); } }

async function switchProvider(name) {
  if(!electronAPI) return;
  showToast(`ÂàáÊç¢Âà∞ ${name}...`,'info');
  const r=await electronAPI.invoke('model-switch-provider',name);
  if(r){ showToast(`${t('switched')} ${name} / ${r.shortName}`,'success'); loadAll(); }
  else { showToast(`ÂàáÊç¢Â§±Ë¥•`,'error'); }
}

async function editProvider(name) {
  editingProvider=name; const s=await electronAPI.invoke('model-full-status');
  const p=s.providers.find(x=>x.name===name); if(!p) return;
  const models=allModels.filter(m=>m.provider===name);
  const n=encArg(name);
  const modelRows=models.map(m=>{
    const mid=encArg(m.modelId);
    return `<div class="model-edit-row"><div class="model-icon-sm" style="background:${m.color};width:22px;height:22px;font-size:9px;">${escHtml(m.icon)}</div>
    <div class="model-edit-name">${escHtml(m.shortName)}</div><div class="model-edit-id">${escHtml(m.modelId)}</div>
    <button class="btn btn-danger btn-sm" onclick="removeModel(decodeURIComponent('${n}'),decodeURIComponent('${mid}'))">√ó</button></div>`;
  }).join('');
  document.getElementById('editPanel').innerHTML=`
    <div class="edit-header"><button class="edit-back" onclick="showTab('main')">‚Üê</button>
    <div class="edit-provider-icon" style="background:${p.color}">${escHtml(p.icon)}</div>
    <div><div class="edit-title">${escHtml(name)}</div><div style="font-size:10px;color:#555;">${escHtml(p.apiType)}</div></div></div>
    <div class="form-group"><label class="form-label">Base URL</label><input class="form-input" id="editBaseUrl" value="${escHtml(p.baseUrl||'')}"></div>
    <div class="form-group"><label class="form-label">API Key</label><input class="form-input" id="editApiKey" type="password" placeholder="${p.hasApiKey?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢':''}">
    <div class="form-hint">${p.hasApiKey?t('keySet'):t('keyNotSet')}</div></div>
    <div style="display:flex;gap:6px;margin-top:10px;">
    <button class="btn btn-primary" onclick="saveProviderEdit()">${t('saveChanges')}</button>
    <button class="btn btn-speed" onclick="speedTest(decodeURIComponent('${n}'))">${t('test')}</button>
    <button class="btn btn-ghost" onclick="fetchProviderModels(decodeURIComponent('${n}'))">üì° Ëé∑ÂèñÊ®°Âûã</button>
    <button class="btn btn-danger" onclick="deleteProvider(decodeURIComponent('${n}'))">${t('delete')}</button></div>
    <div class="divider"></div>
    <div style="font-size:12px;font-weight:600;color:#888;margin-bottom:6px;">${t('models')} (${models.length})</div>
    ${modelRows}
    <div style="margin-top:8px;"><div class="form-row" style="margin-bottom:6px;">
    <input class="form-input" id="newModelId" placeholder="Model ID" style="font-size:11px;">
    <input class="form-input" id="newModelName" placeholder="${t('displayName')}" style="font-size:11px;">
    <button class="btn btn-ghost btn-sm" onclick="addModelToProvider(decodeURIComponent('${n}'))">+</button></div></div>`;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.header-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-edit').classList.add('active');
}

async function saveProviderEdit() { if(!editingProvider||!electronAPI) return; const b=document.getElementById('editBaseUrl').value.trim(),k=document.getElementById('editApiKey').value.trim(),u={}; if(b) u.baseUrl=b; if(k) u.apiKey=k; if(!Object.keys(u).length){showToast(t('noChanges'),'info');return;} const r=await electronAPI.invoke('model-update-provider',editingProvider,u); if(r.success){showToast(`${t('updated')} ${editingProvider}`,'success');showTab('main');}else showToast(r.error,'error'); }
async function deleteProvider(name) { if(!confirm(`${t('confirmDelete')} "${name}"${t('confirmDeleteHint')}`)) return; const r=await electronAPI.invoke('model-remove-provider',name); if(r.success){showToast(`${t('deleted')} ${name}`,'success');showTab('main');}else showToast(r.error,'error'); }
async function removeModel(prov,id) { if(!confirm(`${t('confirmRemove')} "${id}"?`)) return; const r=await electronAPI.invoke('model-remove-model',prov,id); if(r.success){showToast(t('removed'),'success');editProvider(prov);await loadAll();}else showToast(r.error,'error'); }
async function addModelToProvider(prov) { const id=document.getElementById('newModelId').value.trim(),name=document.getElementById('newModelName').value.trim(); if(!id) return showToast(t('enterModelId'),'error'); const r=await electronAPI.invoke('model-add-model',prov,{id,name:name||id}); if(r.success){showToast(`${t('added')} ${id}`,'success');editProvider(prov);await loadAll();}else showToast(r.error,'error'); }

async function fetchProviderModels(prov) {
  if(!electronAPI) return;
  showToast('Ê≠£Âú®Ëé∑ÂèñÊ®°ÂûãÂàóË°®...','info');
  const r=await electronAPI.invoke('model-fetch-models',prov);
  if(!r.success){ showToast(`Ëé∑ÂèñÂ§±Ë¥•: ${r.error}`,'error'); return; }
  if(!r.models.length){ showToast('Êú™Ëé∑ÂèñÂà∞Ê®°Âûã','info'); return; }
  let added=0;
  for(const m of r.models){
    try{ await electronAPI.invoke('model-add-model',prov,{id:m.id,name:m.name||m.id}); added++; }catch(e){}
  }
  showToast(`Ëé∑ÂèñÂà∞ ${r.models.length} ‰∏™Ê®°ÂûãÔºåÊñ∞Â¢û ${added} ‰∏™`,'success');
  editProvider(prov);
  await loadAll();
}

async function loadPresets() { if(!electronAPI) return; const presets=await electronAPI.invoke('model-presets'); document.getElementById('presetGrid').innerHTML=presets.map(p=>`
  <div class="preset-card ${selectedPreset===p.key?'selected':''}" onclick="selectPreset('${p.key}', event)">
  <div class="preset-card-count">${p.modelCount}</div><div class="preset-card-icon" style="background:${p.color}">${escHtml(p.icon)}</div>
  <div class="preset-card-name">${escHtml(p.name)}</div><div class="preset-card-desc">${escHtml(p.description||'')}</div></div>`).join(''); }

function selectPreset(key, evt) { if(!electronAPI) return; electronAPI.invoke('model-presets').then(presets=>{ const p=presets.find(x=>x.key===key); if(!p) return; selectedPreset=key; document.getElementById('addName').value=p.name; document.getElementById('addBaseUrl').value=p.baseUrl; document.getElementById('addApiType').value=p.api; document.querySelectorAll('.preset-card').forEach(el=>el.classList.remove('selected')); evt?.target?.closest?.('.preset-card')?.classList.add('selected'); }); }

function addModelRow() { const c=document.getElementById('addModelRows'),r=document.createElement('div'); r.className='form-row'; r.style.marginBottom='6px'; r.innerHTML=`<input class="form-input" placeholder="Model ID" data-field="id"><input class="form-input" placeholder="${t('displayName')}" data-field="name">`; c.appendChild(r); }

async function submitProvider() {
  const name=document.getElementById('addName').value.trim(),baseUrl=document.getElementById('addBaseUrl').value.trim(),apiKey=document.getElementById('addApiKey').value.trim(),api=document.getElementById('addApiType').value;
  if(!name) return showToast(t('enterName'),'error'); if(!apiKey) return showToast(t('enterKey'),'error');
  let result; const fi=document.querySelector('#addModelRows .form-row input[data-field="id"]'),hm=fi&&fi.value.trim();
  if(selectedPreset&&!hm){ result=await electronAPI.invoke('model-add-from-preset',selectedPreset,apiKey,name,baseUrl||undefined); }
  else { const rows=document.querySelectorAll('#addModelRows .form-row'),models=[]; rows.forEach(r=>{const id=r.querySelector('[data-field="id"]').value.trim(),n=r.querySelector('[data-field="name"]').value.trim();if(id) models.push({id,name:n||id});}); result=await electronAPI.invoke('model-add-provider',name,{baseUrl,apiKey,api,models}); }
  if(result.success){showToast(`${t('added')} "${name}"`,'success');document.getElementById('addName').value='';document.getElementById('addBaseUrl').value='https://api.kk666.online/v1';document.getElementById('addApiKey').value='';selectedPreset=null;showTab('main');}else showToast(result.error,'error');
}

function refreshAll() { loadAll(); showToast(t('refreshed'),'info'); }
function showToast(msg,type='success') { const toast=document.getElementById('toast'); toast.textContent=msg; toast.className=`toast toast-${type} show`; setTimeout(()=>toast.classList.remove('show'),2500); }

// ===== ÁõëÊéßÊó•Âøó =====
let currentLogFilter = null;
let logEntries = [];

async function loadLogs() {
  if(!electronAPI) return;
  logEntries = await electronAPI.invoke('switch-log-list', 200, currentLogFilter);
  renderLogs();
}

function renderLogs() {
  const el = document.getElementById('logContainer');
  const filtered = currentLogFilter ? logEntries.filter(e => e.level === currentLogFilter) : logEntries;
  if(filtered.length === 0) {
    el.innerHTML = `<div class="log-empty">${t('logEmpty')}</div>`;
    return;
  }
  el.innerHTML = filtered.map(e => {
    const timeStr = e.time ? e.time.replace('T',' ').substring(5,19) : '';
    return `<div class="log-entry">
      <span class="log-time">${escHtml(timeStr)}</span>
      <span class="log-level log-level-${e.level}">${escHtml(e.level)}</span>
      <span class="log-action">${escHtml(e.action)}</span>
      <span class="log-detail">${escHtml(e.detail || '')}</span>
    </div>`;
  }).join('');
  // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
  el.scrollTop = el.scrollHeight;
}

function filterLogs(level, btn) {
  currentLogFilter = level === 'all' ? null : level;
  document.querySelectorAll('.log-filter').forEach(f => f.classList.remove('active'));
  if(btn) btn.classList.add('active');
  if(logEntries.length > 0) {
    renderLogs();
  } else {
    loadLogs();
  }
}

function refreshLogs() { loadLogs(); }

async function clearLogs() {
  if(!electronAPI) return;
  await electronAPI.invoke('switch-log-clear');
  logEntries = [];
  renderLogs();
  showToast(t('logCleared'), 'info');
}

// ÂÆûÊó∂Êé•Êî∂Êñ∞Êó•Âøó
if(electronAPI) {
  electronAPI.on('switch-log-entry', (entry) => {
    logEntries.push(entry);
    if(logEntries.length > 500) logEntries.splice(0, logEntries.length - 500);
    // Â¶ÇÊûúÊó•ÂøóÈù¢ÊùøÂèØËßÅÔºåÂÆûÊó∂Êõ¥Êñ∞
    if(document.getElementById('panel-logs').classList.contains('active')) {
      renderLogs();
    }
  });
}

loadAll();
if(electronAPI) { electronAPI.on('model-changed',()=>{loadAll();loadModels();}); }
</script>
</body>
</html>
