<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>KKClaw æ–°æ‰‹å¼•å¯¼</title>
<style>
  :root {
    --wood-dark: #5a3a1a;
    --wood-medium: #8b6238;
    --wood-light: #b8905a;
    --parchment: #faebd7;
    --parchment-dark: #e8d5b0;
    --grass: #5c8a2f;
    --grass-light: #7cb342;
    --text-dark: #3d2610;
    --text-medium: #6d5030;
    --gold: #ffc107;
    --gold-dark: #f9a825;
    --red: #c0392b;
    --green: #27ae60;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  *::-webkit-scrollbar { width: 10px; }
  *::-webkit-scrollbar-track { background: var(--parchment-dark); border-left: 2px solid var(--wood-light); }
  *::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, var(--wood-light), var(--wood-medium));
    border: 2px solid var(--wood-dark);
  }
  *::-webkit-scrollbar-thumb:hover { background: var(--wood-medium); }

  body {
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    color: var(--text-dark);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background: #3a7d2a;
    image-rendering: pixelated;
  }

  /* Grass texture background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(circle at 20% 80%, #4a8d32 0%, transparent 40%),
      radial-gradient(circle at 80% 20%, #2d6b1a 0%, transparent 40%),
      radial-gradient(circle at 50% 50%, #3a7d2a 0%, transparent 60%),
      linear-gradient(180deg, #5a9d3a 0%, #3a7d2a 30%, #2d6b1a 100%);
    pointer-events: none;
    z-index: 0;
  }

  /* Main wood-framed container */
  body > * { position: relative; z-index: 1; }

  /* ===== Header ===== */
  .wizard-header {
    padding: 10px 16px 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: relative;
    background: linear-gradient(180deg, var(--wood-dark) 0%, var(--wood-medium) 60%, var(--wood-light) 100%);
    border-bottom: 3px solid var(--wood-dark);
    box-shadow: 0 3px 0 0 rgba(0,0,0,0.2);
  }
  .wizard-header h1 {
    font-size: 16px;
    color: var(--gold);
    font-weight: 700;
    letter-spacing: 2px;
    text-shadow: 1px 1px 0 var(--wood-dark), 2px 2px 0 rgba(0,0,0,0.3);
    font-family: 'Courier New', 'Consolas', monospace;
  }
  .skip-btn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    padding: 3px 10px;
    border: 2px solid var(--wood-light);
    border-radius: 2px;
    background: rgba(0,0,0,0.2);
    color: var(--parchment-dark);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Courier New', monospace;
  }
  .skip-btn:hover { color: var(--gold); border-color: var(--gold); background: rgba(0,0,0,0.4); }

  /* ===== Progress Bar ===== */
  .progress-bar {
    display: flex;
    justify-content: center;
    gap: 6px;
    padding: 10px 12px 8px;
    flex-shrink: 0;
    background: linear-gradient(180deg, var(--wood-medium), var(--wood-light) 40%, var(--parchment-dark));
    border-bottom: 2px solid var(--wood-medium);
  }
  .progress-dot {
    width: 18px; height: 18px;
    background: var(--parchment-dark);
    border: 2px solid var(--wood-medium);
    transition: all 0.3s ease;
    cursor: default;
    position: relative;
    clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
  }
  .progress-dot.done { cursor: pointer; }
  .progress-dot.active {
    background: var(--gold);
    border-color: var(--gold-dark);
    transform: scale(1.3);
    filter: drop-shadow(0 0 4px rgba(255,193,7,0.6));
  }
  .progress-dot.done {
    background: var(--grass-light);
    border-color: var(--grass);
  }
  .progress-dot::after {
    content: attr(data-label);
    position: absolute;
    top: 22px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 9px;
    color: var(--text-medium);
    white-space: nowrap;
    font-family: 'Courier New', monospace;
    font-weight: 600;
  }

  /* ===== Chat Area ===== */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: var(--parchment);
    border-left: 4px solid var(--wood-medium);
    border-right: 4px solid var(--wood-medium);
    box-shadow: inset 0 0 20px rgba(90,58,26,0.08);
  }

  /* ===== Bubble (RPG Dialogue) ===== */
  .bubble-row {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .avatar {
    width: 34px; height: 34px;
    border-radius: 2px;
    background: linear-gradient(135deg, #e8b068, #d49040);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
    border: 2px solid var(--wood-dark);
    box-shadow: 1px 1px 0 var(--wood-dark);
  }

  .bubble {
    background: #fffdf5;
    border: 2px solid var(--wood-medium);
    border-radius: 2px;
    padding: 8px 12px;
    max-width: 85%;
    box-shadow: 2px 2px 0 rgba(90,58,26,0.15);
    line-height: 1.6;
    font-size: 13px;
    position: relative;
    color: var(--text-dark);
  }
  .bubble::before {
    content: '';
    position: absolute;
    left: -7px;
    top: 8px;
    width: 0; height: 0;
    border-top: 5px solid transparent;
    border-bottom: 5px solid transparent;
    border-right: 5px solid var(--wood-medium);
  }
  .bubble::after {
    content: '';
    position: absolute;
    left: -4px;
    top: 9px;
    width: 0; height: 0;
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
    border-right: 4px solid #fffdf5;
  }
  .bubble .typing-cursor {
    display: inline-block;
    width: 2px;
    height: 13px;
    background: var(--wood-dark);
    animation: blink 0.5s step-end infinite;
    vertical-align: middle;
    margin-left: 1px;
  }
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  /* ===== Step Content Card (Game Panel) ===== */
  .step-card {
    background: linear-gradient(180deg, #fffef8, var(--parchment));
    border: 3px solid var(--wood-medium);
    border-radius: 2px;
    padding: 14px 16px;
    box-shadow: 3px 3px 0 rgba(90,58,26,0.15), inset 0 0 0 1px rgba(255,255,255,0.5);
    animation: fadeIn 0.3s ease;
    position: relative;
  }
  .step-card::before {
    content: '';
    position: absolute;
    top: -1px; left: -1px; right: -1px; bottom: -1px;
    border: 1px solid var(--wood-light);
    border-radius: 2px;
    pointer-events: none;
  }
  .step-card h3 {
    font-size: 13px;
    color: var(--wood-dark);
    margin-bottom: 10px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
    border-bottom: 2px solid var(--parchment-dark);
    padding-bottom: 6px;
  }

  /* ===== Status indicators ===== */
  .status-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    font-size: 13px;
  }
  .status-icon {
    width: 18px; height: 18px;
    border: 2px solid var(--wood-medium);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    flex-shrink: 0;
    border-radius: 1px;
  }
  .status-icon.loading {
    border-color: var(--wood-light);
    animation: spin 0.8s linear infinite;
  }
  .status-icon.success {
    background: #c8e6c9;
    color: var(--grass);
    border-color: var(--grass);
  }
  .status-icon.fail {
    background: #ffcdd2;
    color: var(--red);
    border-color: var(--red);
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== Form elements ===== */
  .form-group { margin-bottom: 10px; }
  .form-group label {
    display: block;
    font-size: 11px;
    color: var(--text-medium);
    margin-bottom: 3px;
    font-family: 'Courier New', monospace;
    font-weight: 600;
  }
  .form-input {
    width: 100%;
    padding: 6px 10px;
    border: 2px solid var(--wood-light);
    border-radius: 2px;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    background: #fffef8;
    color: var(--text-dark);
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
  }
  .form-input:focus {
    border-color: var(--gold-dark);
    box-shadow: 0 0 0 1px var(--gold), inset 0 0 4px rgba(255,193,7,0.1);
  }
  select.form-input {
    cursor: pointer;
    appearance: auto;
  }

  /* ===== Toggle switch ===== */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px dashed var(--parchment-dark);
  }
  .toggle-row:last-child { border-bottom: none; }
  .toggle-label {
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .toggle-sublabel {
    font-size: 11px;
    color: var(--text-medium);
    opacity: 0.8;
  }
  .toggle-controls {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .toggle-tag {
    font-size: 10px;
    color: var(--text-medium);
    width: 30px;
    text-align: center;
    font-family: 'Courier New', monospace;
  }

  .switch {
    position: relative;
    width: 36px; height: 20px;
    cursor: pointer;
  }
  .switch input { display: none; }
  .switch .slider {
    position: absolute;
    inset: 0;
    background: var(--parchment-dark);
    border: 2px solid var(--wood-light);
    border-radius: 2px;
    transition: 0.2s;
  }
  .switch .slider::before {
    content: '';
    position: absolute;
    width: 14px; height: 14px;
    left: 1px; bottom: 1px;
    background: var(--wood-light);
    border-radius: 1px;
    transition: 0.2s;
    box-shadow: 1px 1px 0 rgba(0,0,0,0.15);
  }
  .switch input:checked + .slider {
    background: #a5d6a7;
    border-color: var(--grass);
  }
  .switch input:checked + .slider::before {
    transform: translateX(16px);
    background: var(--grass);
  }

  /* ===== Engine / Provider Cards (Inventory Slot Style) ===== */
  .engine-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .engine-card {
    border: 2px solid var(--wood-light);
    border-radius: 2px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.15s;
    background: #fffef8;
    position: relative;
  }
  /* ===== Note box ===== */
  .note-box {
    background: #fff8e1;
    border: 2px solid #ffe082;
    border-radius: 2px;
    padding: 8px 12px;
    font-size: 12px;
    color: var(--text-medium);
    margin-bottom: 10px;
    line-height: 1.5;
  }

  /* ===== Upload area ===== */
  .upload-area {
    border: 2px dashed var(--wood-light);
    border-radius: 2px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #fffef8;
  }
  .upload-area:hover, .upload-area.dragover {
    border-color: var(--gold-dark);
    background: #fffdf0;
  }
  .upload-icon { font-size: 28px; margin-bottom: 6px; }
  .upload-text { font-size: 13px; color: var(--text-dark); margin-bottom: 4px; }
  .upload-hint { font-size: 11px; color: var(--text-medium); }
  .upload-area.has-file { border-color: var(--grass); border-style: solid; }

  .engine-card:hover {
    border-color: var(--gold-dark);
    background: #fffde0;
  }
  .engine-card.selected {
    border-color: var(--grass);
    background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
    box-shadow: inset 0 0 0 1px rgba(92,138,47,0.2), 2px 2px 0 rgba(90,58,26,0.1);
  }
  .engine-card .engine-name {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-dark);
  }
  .engine-card .engine-desc {
    font-size: 11px;
    color: var(--text-medium);
    margin-top: 1px;
  }
  .engine-card .engine-badge {
    position: absolute;
    top: 6px; right: 8px;
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 1px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    border: 1px solid;
  }
  .engine-badge.best {
    background: #fff3cd;
    color: #e65100;
    border-color: #ffb300;
  }
  .engine-badge.recommend {
    background: #e8f5e9;
    color: var(--grass);
    border-color: var(--grass-light);
  }
  .engine-badge.free {
    background: #e3f2fd;
    color: #1565c0;
    border-color: #64b5f6;
  }

  /* ===== Buttons (Game Style) ===== */
  .btn-row {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    justify-content: flex-end;
  }
  .btn {
    padding: 6px 16px;
    border: 2px solid;
    border-radius: 2px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.1s;
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: 'Courier New', monospace;
    position: relative;
    text-shadow: 0 1px 0 rgba(0,0,0,0.1);
  }
  .btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    filter: grayscale(0.5);
  }
  .btn-primary {
    background: linear-gradient(180deg, var(--grass-light), var(--grass));
    color: white;
    border-color: #3d6b1a;
    box-shadow: 0 3px 0 0 #2d5510, 1px 1px 0 0 #3d6b1a;
    text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
  }
  .btn-primary:hover:not(:disabled) {
    background: linear-gradient(180deg, #8cc34a, var(--grass-light));
    transform: translateY(-1px);
    box-shadow: 0 4px 0 0 #2d5510, 1px 1px 0 0 #3d6b1a;
  }
  .btn-primary:active:not(:disabled) {
    transform: translateY(2px);
    box-shadow: 0 1px 0 0 #2d5510;
  }
  .btn-secondary {
    background: linear-gradient(180deg, var(--parchment), var(--parchment-dark));
    color: var(--wood-dark);
    border-color: var(--wood-medium);
    box-shadow: 0 3px 0 0 var(--wood-dark), 1px 1px 0 0 var(--wood-medium);
  }
  .btn-secondary:hover:not(:disabled) {
    background: linear-gradient(180deg, #fff, var(--parchment));
    transform: translateY(-1px);
    box-shadow: 0 4px 0 0 var(--wood-dark), 1px 1px 0 0 var(--wood-medium);
  }
  .btn-secondary:active:not(:disabled) {
    transform: translateY(2px);
    box-shadow: 0 1px 0 0 var(--wood-dark);
  }
  .btn-small {
    padding: 4px 12px;
    font-size: 11px;
  }
  .btn-test {
    background: linear-gradient(180deg, var(--gold), var(--gold-dark));
    color: var(--wood-dark);
    border-color: #c68400;
    box-shadow: 0 2px 0 0 #8d5e00;
    padding: 4px 10px;
    font-size: 11px;
    text-shadow: none;
  }
  .btn-test:hover:not(:disabled) {
    background: linear-gradient(180deg, #ffe033, var(--gold));
    transform: translateY(-1px);
    box-shadow: 0 3px 0 0 #8d5e00;
  }
  .btn-test:active:not(:disabled) {
    transform: translateY(1px);
    box-shadow: 0 1px 0 0 #8d5e00;
  }

  /* ===== Footer (Game HUD) ===== */
  .wizard-footer {
    padding: 10px 16px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    background: linear-gradient(180deg, var(--wood-light), var(--wood-medium) 40%, var(--wood-dark));
    border-top: 3px solid var(--wood-dark);
    box-shadow: 0 -2px 0 0 rgba(0,0,0,0.15);
  }
  .step-label {
    font-size: 11px;
    color: var(--parchment-dark);
    font-family: 'Courier New', monospace;
    text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
  }

  /* ===== Celebration ===== */
  .celebration {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 100;
  }
  .confetti {
    position: absolute;
    width: 6px; height: 6px;
    animation: confettiFall 3s ease-out forwards;
  }
  @keyframes confettiFall {
    0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
    100% { transform: translateY(600px) rotate(720deg); opacity: 0; }
  }

  /* ===== Test result list (Quest Log) ===== */
  .test-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .test-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border: 2px solid var(--parchment-dark);
    border-radius: 2px;
    background: #fffef8;
    transition: all 0.2s;
  }
  .test-item.pass {
    background: #e8f5e9;
    border-color: var(--grass-light);
  }
  .test-item.fail {
    background: #fce4ec;
    border-color: #ef9a9a;
  }
  .test-item.skip {
    background: #fff8e1;
    border-color: #ffe082;
  }
  .test-item .test-icon {
    font-size: 16px;
    flex-shrink: 0;
  }
  .test-item .test-name {
    font-size: 12px;
    font-weight: 700;
    flex: 1;
    font-family: 'Courier New', monospace;
  }
  .test-item .test-msg {
    font-size: 11px;
    color: var(--text-medium);
  }

  /* ===== Password toggle ===== */
  .input-wrap { position: relative; }
  .input-wrap .form-input { padding-right: 34px; }
  .eye-btn {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 15px;
    cursor: pointer;
    opacity: 0.4;
    transition: opacity 0.2s;
    padding: 2px;
  }
  .eye-btn:hover { opacity: 0.8; }

  /* ===== Retry button ===== */
  .retry-btn {
    padding: 2px 8px;
    border: 2px solid var(--wood-light);
    border-radius: 2px;
    background: var(--parchment);
    color: var(--wood-dark);
    font-size: 10px;
    cursor: pointer;
    transition: all 0.15s;
    flex-shrink: 0;
    font-family: 'Courier New', monospace;
    font-weight: 700;
    box-shadow: 0 1px 0 0 var(--wood-medium);
  }
  .retry-btn:hover {
    background: var(--gold);
    border-color: var(--gold-dark);
  }
  .retry-btn:active {
    transform: translateY(1px);
    box-shadow: none;
  }

  /* ===== Env check ===== */
  .env-check {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 8px;
    border: 1px solid var(--parchment-dark);
    border-radius: 2px;
    background: #fffef8;
    font-size: 11px;
    margin-bottom: 8px;
    font-family: 'Courier New', monospace;
  }
  .env-check.ok {
    background: #e8f5e9;
    border-color: var(--grass-light);
    color: var(--grass);
  }
  .env-check.err {
    background: #fce4ec;
    border-color: #ef9a9a;
    color: var(--red);
  }

  /* ===== Misc ===== */
  .hidden { display: none !important; }
  .text-muted { color: var(--text-medium); font-size: 12px; }
  .text-success { color: var(--green); }
  .text-danger { color: var(--red); }
  .mt-8 { margin-top: 8px; }
  .mb-8 { margin-bottom: 8px; }

  /* Manual token input */
  .manual-input-area {
    margin-top: 8px;
    padding: 8px;
    border: 2px dashed var(--wood-light);
    border-radius: 2px;
    background: rgba(255,253,240,0.6);
  }

  /* Provider grid for model step */
  .provider-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }
  .provider-grid .engine-card {
    padding: 6px 10px;
  }
  .provider-grid .engine-card .engine-name {
    font-size: 12px;
  }
  .provider-grid .engine-card .engine-desc {
    font-size: 10px;
  }
  .provider-grid .engine-card .engine-badge {
    top: 4px; right: 6px;
    font-size: 8px;
    padding: 1px 5px;
  }
  /* Full-width custom row */
  .provider-grid .engine-card.full-width {
    grid-column: 1 / -1;
  }
</style>
</head>
<body>

<div class="wizard-header">
  <h1>KKClaw æ–°æ‰‹å¼•å¯¼</h1>
  <button class="skip-btn" onclick="skipWizard()">SKIP</button>
</div>

<div class="progress-bar">
  <div class="progress-dot active" data-step="0" data-label="Gateway" onclick="jumpToStep(0)"></div>
  <div class="progress-dot" data-step="1" data-label="Model" onclick="jumpToStep(1)"></div>
  <div class="progress-dot" data-step="2" data-label="Channels" onclick="jumpToStep(2)"></div>
  <div class="progress-dot" data-step="3" data-label="TTS" onclick="jumpToStep(3)"></div>
  <div class="progress-dot" data-step="4" data-label="Voice" onclick="jumpToStep(4)"></div>
  <div class="progress-dot" data-step="5" data-label="Display" onclick="jumpToStep(5)"></div>
  <div class="progress-dot" data-step="6" data-label="Done" onclick="jumpToStep(6)"></div>
</div>

<div class="chat-area" id="chatArea">
  <!-- Dynamic content rendered by JS -->
</div>

<div class="wizard-footer">
  <button class="btn btn-secondary" id="btnPrev" onclick="prevStep()" style="visibility:hidden">ä¸Šä¸€æ­¥</button>
  <span class="step-label" id="stepLabel">Step 1/7</span>
  <button class="btn btn-primary" id="btnNext" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
</div>

<div class="celebration hidden" id="celebration"></div>

<script>
// ===== State =====
let currentStep = 0;
const totalSteps = 7;
let maxVisitedStep = 0;
let stepData = {
  gatewayConnected: false,
  gatewayToken: '',
  modelProvider: '',
  modelId: '',
  channels: {
    feishu:   { voice: true,  lyrics: true },
    telegram: { voice: true,  lyrics: true },
    discord:  { voice: false, lyrics: true },
    web:      { voice: false, lyrics: false },
    wecom:    { voice: true,  lyrics: true }
  },
  ttsEngine: 'minimax',
  ttsApiKey: '',
  lyricsEnabled: true,
  alwaysOnTop: true,
  autoLaunch: false,
  testResults: null
};

const channelNames = {
  feishu: 'é£ä¹¦ Feishu',
  telegram: 'Telegram',
  discord: 'Discord',
  web: 'Web',
  wecom: 'ä¼ä¸šå¾®ä¿¡ WeCom'
};

const channelIcons = {
  feishu: 'ğŸ¦',
  telegram: 'âœˆï¸',
  discord: 'ğŸ’¬',
  web: 'ğŸŒ',
  wecom: 'ğŸ’¼'
};

const modelPresets = {
  anthropic: [
    { id: 'claude-opus-4-20250514', name: 'Claude Opus 4' },
    { id: 'claude-sonnet-4-20250514', name: 'Claude Sonnet 4' },
    { id: 'claude-haiku-3-5-20241022', name: 'Claude Haiku 3.5' },
  ],
  openai: [
    { id: 'gpt-4o', name: 'GPT-4o' },
    { id: 'gpt-4o-mini', name: 'GPT-4o Mini' },
    { id: 'o3', name: 'o3' },
    { id: 'o3-mini', name: 'o3-mini' },
    { id: 'o4-mini', name: 'o4-mini' },
  ],
  google: [
    { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro' },
    { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash' },
  ],
  deepseek: [
    { id: 'deepseek-chat', name: 'DeepSeek V3' },
    { id: 'deepseek-reasoner', name: 'DeepSeek R1' },
  ],
  openrouter: [
    { id: 'anthropic/claude-opus-4', name: 'Claude Opus 4' },
    { id: 'openai/gpt-4o', name: 'GPT-4o' },
    { id: 'google/gemini-2.5-pro', name: 'Gemini 2.5 Pro' },
  ],
  'zhipu-glm': [
    { id: 'glm-4-plus', name: 'GLM-4 Plus' },
  ],
  'qwen-coder': [
    { id: 'qwen-max', name: 'Qwen Max' },
    { id: 'qwen-turbo', name: 'Qwen Turbo' },
  ],
  kimi: [
    { id: 'kimi-k2-0711-preview', name: 'Kimi K2' },
  ],
  minimax: [
    { id: 'MiniMax-M1-80k', name: 'MiniMax M1' },
  ],
};

// ===== Helpers =====
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ===== Typewriter =====
function typewrite(element, text, speed = 30) {
  return new Promise(resolve => {
    element.innerHTML = '';
    const cursor = document.createElement('span');
    cursor.className = 'typing-cursor';
    element.appendChild(cursor);

    let i = 0;
    const interval = setInterval(() => {
      if (i < text.length) {
        element.insertBefore(document.createTextNode(text[i]), cursor);
        i++;
        // Scroll chat to bottom
        const chat = document.getElementById('chatArea');
        chat.scrollTop = chat.scrollHeight;
      } else {
        clearInterval(interval);
        cursor.remove();
        resolve();
      }
    }, speed);
  });
}

function addBubble(text, withTypewriter = true) {
  const chat = document.getElementById('chatArea');
  const row = document.createElement('div');
  row.className = 'bubble-row';
  row.innerHTML = `
    <div class="avatar">ğŸ¦</div>
    <div class="bubble" id="bubble-${Date.now()}"></div>
  `;
  chat.appendChild(row);
  const bubbleEl = row.querySelector('.bubble');

  if (withTypewriter) {
    return typewrite(bubbleEl, text, 25);
  } else {
    bubbleEl.textContent = text;
    chat.scrollTop = chat.scrollHeight;
    return Promise.resolve();
  }
}

function addCard(html) {
  const chat = document.getElementById('chatArea');
  const card = document.createElement('div');
  card.className = 'step-card';
  card.innerHTML = html;
  chat.appendChild(card);
  chat.scrollTop = chat.scrollHeight;
  return card;
}

function clearChat() {
  document.getElementById('chatArea').innerHTML = '';
}

// ===== Progress =====
function updateProgress() {
  if (currentStep > maxVisitedStep) maxVisitedStep = currentStep;
  document.querySelectorAll('.progress-dot').forEach((dot, i) => {
    dot.classList.remove('active', 'done');
    if (i < currentStep) dot.classList.add('done');
    else if (i === currentStep) dot.classList.add('active');
  });
  document.getElementById('stepLabel').textContent = `Step ${currentStep + 1}/${totalSteps}`;
  document.getElementById('btnPrev').style.visibility = currentStep > 0 ? 'visible' : 'hidden';

  if (currentStep === totalSteps - 1) {
    document.getElementById('btnNext').textContent = 'å®Œæˆ';
  } else {
    document.getElementById('btnNext').textContent = 'ä¸‹ä¸€æ­¥';
  }
}

function jumpToStep(step) {
  // Only allow jumping to already-visited steps
  if (step > maxVisitedStep || step === currentStep) return;
  currentStep = step;
  updateProgress();
  clearChat();
  renderStep(currentStep);
}

// ===== Navigation =====
async function nextStep() {
  // Step validation
  if (!validateCurrentStep()) return;

  if (currentStep < totalSteps - 1) {
    // Save current step data
    await saveCurrentStep();
    currentStep++;
    // Save wizard progress
    wizardAPI.invoke('wizard-save-progress', currentStep).catch(() => {});
    updateProgress();
    clearChat();
    await renderStep(currentStep);
  } else {
    // Complete
    await completeWizard();
  }
}

function validateCurrentStep() {
  switch (currentStep) {
    case 0: // Gateway
      if (!stepData.gatewayConnected) {
        addBubble('Gateway è¿˜æ²¡æœ‰è¿æ¥æˆåŠŸå‘¢~ ç¡®å®šè¦è·³è¿‡å—ï¼Ÿ', false);
        // Allow skip but warn â€” set a flag so next click goes through
        if (stepData._gatewaySkipWarned) return true;
        stepData._gatewaySkipWarned = true;
        return false;
      }
      return true;
    case 1: // Model
      if (!stepData.modelProvider) {
        addBubble('è¿˜æ²¡æœ‰é€‰æ‹© AI æ¨¡å‹æä¾›å•†å“¦~ ç¡®å®šè¦è·³è¿‡å—ï¼Ÿ', false);
        if (stepData._modelSkipWarned) return true;
        stepData._modelSkipWarned = true;
        return false;
      }
      return true;
    case 3: // TTS
      if (stepData.ttsEngine !== 'edge' && !stepData.ttsApiKey) {
        const apiKeyEl = document.getElementById('tts-apikey');
        if (apiKeyEl) stepData.ttsApiKey = apiKeyEl.value.trim();
        if (!stepData.ttsApiKey) {
          addBubble('è¿˜æ²¡æœ‰è¾“å…¥ API Key å“¦~ ä¸è¾“å…¥çš„è¯ä¼šä½¿ç”¨å…è´¹çš„ Edge TTS (^_^)', false);
          if (stepData._ttsSkipWarned) {
            stepData.ttsEngine = 'edge';
            return true;
          }
          stepData._ttsSkipWarned = true;
          return false;
        }
      }
      return true;
    default:
      return true;
  }
}

function prevStep() {
  if (currentStep > 0) {
    currentStep--;
    updateProgress();
    clearChat();
    renderStep(currentStep);
  }
}

async function saveCurrentStep() {
  switch (currentStep) {
    case 1: // Model
      await saveModelConfig();
      break;
    case 2: // Channels
      collectChannelData();
      await wizardAPI.invoke('wizard-save-channels', stepData.channels);
      break;
    case 3: // TTS
      const apiKeyEl = document.getElementById('tts-apikey');
      if (apiKeyEl) stepData.ttsApiKey = apiKeyEl.value.trim();
      await wizardAPI.invoke('wizard-save-tts-engine', {
        engine: stepData.ttsEngine,
        apiKey: stepData.ttsApiKey
      });
      break;
    case 4: // Agent Voice â€” workspace dir is handled by the "é…ç½®æ’­æŠ¥" button
      break;
    case 5: // Display
      collectDisplaySettings();
      await wizardAPI.invoke('wizard-save-display-settings', {
        lyricsEnabled: stepData.lyricsEnabled,
        alwaysOnTop: stepData.alwaysOnTop,
        autoLaunch: stepData.autoLaunch
      });
      break;
  }
}

function collectChannelData() {
  for (const ch of Object.keys(stepData.channels)) {
    const voiceEl = document.getElementById(`voice-${ch}`);
    const lyricsEl = document.getElementById(`lyrics-${ch}`);
    if (voiceEl) stepData.channels[ch].voice = voiceEl.checked;
    if (lyricsEl) stepData.channels[ch].lyrics = lyricsEl.checked;
  }
}

function collectDisplaySettings() {
  const lyrics = document.getElementById('toggle-lyrics');
  const ontop = document.getElementById('toggle-ontop');
  const autolaunch = document.getElementById('toggle-autolaunch');
  if (lyrics) stepData.lyricsEnabled = lyrics.checked;
  if (ontop) stepData.alwaysOnTop = ontop.checked;
  if (autolaunch) stepData.autoLaunch = autolaunch.checked;
}

// ===== Render Steps =====
async function renderStep(step) {
  switch (step) {
    case 0: await renderStep1(); break;
    case 1: await renderStepModel(); break;
    case 2: await renderStep2(); break;
    case 3: await renderStep3(); break;
    case 4: await renderStep4(); break;
    case 5: await renderStep5(); break;
    case 6: await renderStep6(); break;
  }
}

// â”€â”€â”€ Step 1: Gateway â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderStep1() {
  await addBubble('ä½ å¥½å‘€~ æˆ‘æ˜¯å°Kï¼(^_^) æ¬¢è¿ä½¿ç”¨ KKClaw æ¡Œé¢å® ç‰©~');
  await addBubble('è®©æˆ‘å…ˆå¸®ä½ æ£€æŸ¥ä¸€ä¸‹ OpenClaw Gateway çš„è¿æ¥çŠ¶æ€å§ï¼');
  await addBubble('è®©æˆ‘æ‰¾æ‰¾ä½ çš„ Gateway... (o_O)');

  const card = addCard(`
    <h3>OpenClaw Gateway æ£€æµ‹</h3>
    <div class="status-item">
      <div class="status-icon loading" id="gw-status-icon"></div>
      <span id="gw-status-text">æ­£åœ¨æ£€æµ‹ Gateway...</span>
    </div>
    <div id="gw-manual" class="hidden">
      <div class="manual-input-area">
        <div class="form-group">
          <label>Gateway Token (æ‰‹åŠ¨è¾“å…¥)</label>
          <input type="text" class="form-input" id="gw-token-input" placeholder="è¯·è¾“å…¥ä½ çš„ Gateway Token">
        </div>
        <div class="btn-row">
          <button class="btn btn-primary btn-small" onclick="testGatewayManual()">æµ‹è¯•è¿æ¥</button>
        </div>
      </div>
    </div>
  `);

  // Auto detect
  try {
    const result = await wizardAPI.invoke('wizard-detect-gateway');
    const icon = document.getElementById('gw-status-icon');
    const text = document.getElementById('gw-status-text');

    if (result.connected) {
      icon.className = 'status-icon success';
      icon.textContent = 'âœ“';
      text.textContent = `Gateway è¿æ¥æˆåŠŸ (ç«¯å£ ${result.port})`;
      stepData.gatewayConnected = true;
      stepData.gatewayToken = result.token;
      await addBubble('æ‰¾åˆ°å•¦ï¼è¿æ¥æˆåŠŸï¼âœ§*ã€‚(o^_^o)âœ§*ã€‚');
    } else {
      icon.className = 'status-icon fail';
      icon.textContent = 'âœ—';
      if (result.token) {
        text.textContent = `æ‰¾åˆ°äº† Token ä½†è¿æ¥å¤±è´¥ (ç«¯å£ ${result.port})`;
        document.getElementById('gw-token-input').value = result.token;
      } else {
        text.textContent = 'Gateway æœªæ£€æµ‹åˆ°';
      }
      document.getElementById('gw-manual').classList.remove('hidden');
      await addBubble('è¯¶ï¼Ÿå¥½åƒæ²¡æ‰¾åˆ°å‘¢ (T_T) è¯·æ‰‹åŠ¨è¾“å…¥ Token è¯•è¯•~');
    }
  } catch (err) {
    const icon = document.getElementById('gw-status-icon');
    const text = document.getElementById('gw-status-text');
    icon.className = 'status-icon fail';
    icon.textContent = 'âœ—';
    text.textContent = 'æ£€æµ‹å‡ºé”™: ' + err.message;
    document.getElementById('gw-manual').classList.remove('hidden');
    await addBubble('å‘œ...æ£€æµ‹å‡ºé”™äº† (>_<) è¯·æ‰‹åŠ¨è¾“å…¥ Token è¯•è¯•~');
  }
}

async function testGatewayManual() {
  const token = document.getElementById('gw-token-input').value.trim();
  if (!token) return;

  const icon = document.getElementById('gw-status-icon');
  const text = document.getElementById('gw-status-text');
  icon.className = 'status-icon loading';
  icon.textContent = '';
  text.textContent = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';

  try {
    const result = await wizardAPI.invoke('wizard-test-gateway', token);
    if (result.success) {
      icon.className = 'status-icon success';
      icon.textContent = 'âœ“';
      text.textContent = 'Gateway è¿æ¥æˆåŠŸï¼';
      stepData.gatewayConnected = true;
      stepData.gatewayToken = token;
      document.getElementById('gw-manual').classList.add('hidden');
      await addBubble('è¿æ¥æˆåŠŸå•¦ï¼çœŸå‰å®³~ âœ§*ã€‚(o^_^o)âœ§*ã€‚');
    } else {
      icon.className = 'status-icon fail';
      icon.textContent = 'âœ—';
      text.textContent = 'è¿æ¥å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯');
      await addBubble('è¿˜æ˜¯ä¸è¡Œå‘¢... (T_T) è¯·ç¡®è®¤ Gateway å·²å¯åŠ¨~');
    }
  } catch (err) {
    icon.className = 'status-icon fail';
    icon.textContent = 'âœ—';
    text.textContent = 'æµ‹è¯•å‡ºé”™: ' + err.message;
  }
}

// â”€â”€â”€ Step 2: AI Model Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderStepModel() {
  await addBubble('æ¥ä¸‹æ¥é…ç½®ä½ çš„ AI æ¨¡å‹å§~ (^_^)');
  await addBubble('é€‰æ‹©æ¨¡å‹æä¾›å•†å¹¶è¾“å…¥ API Keyï¼Œå°Kå°±èƒ½å¸®ä½ è¿ä¸Š AI å•¦ï¼');

  // Load existing config
  let currentConfig = { providers: {}, primary: '' };
  try {
    currentConfig = await wizardAPI.invoke('wizard-get-model-config');
  } catch {}

  // Detect current provider and model from primary
  let currentProvider = '';
  let currentModelId = '';
  if (currentConfig.primary) {
    const parts = currentConfig.primary.split('/');
    currentProvider = parts[0] || '';
    currentModelId = parts.slice(1).join('/') || '';
  }
  stepData.modelProvider = currentProvider;
  stepData.modelId = currentModelId;

  if (currentProvider && currentConfig.providers[currentProvider]?.hasKey) {
    await addBubble('æ£€æµ‹åˆ°å·²é…ç½®: ' + currentConfig.primary + ' (^_^)');
  }

  const providerList = [
    { key: 'anthropic', name: 'Anthropic', desc: 'Claude Opus 4 / Sonnet 4 / Haiku', badge: 'recommend', badgeText: 'æ¨è' },
    { key: 'openai', name: 'OpenAI', desc: 'GPT-4o / o3 / o4-mini', badge: '', badgeText: '' },
    { key: 'google', name: 'Google AI', desc: 'Gemini 2.5 Pro / 2.0 Flash', badge: '', badgeText: '' },
    { key: 'deepseek', name: 'DeepSeek', desc: 'DeepSeek V3 / R1', badge: '', badgeText: '' },
    { key: 'openrouter', name: 'OpenRouter', desc: 'å¤šæ¨¡å‹ä¸­è½¬ (Claude/GPT/Gemini)', badge: '', badgeText: '' },
    { key: 'zhipu-glm', name: 'æ™ºè°± GLM', desc: 'GLM-4 Plus', badge: '', badgeText: '' },
    { key: 'qwen-coder', name: 'é€šä¹‰åƒé—® Qwen', desc: 'Qwen Max / Turbo', badge: '', badgeText: '' },
    { key: 'kimi', name: 'Kimi', desc: 'Kimi K2', badge: '', badgeText: '' },
    { key: 'minimax', name: 'MiniMax', desc: 'MiniMax M1', badge: '', badgeText: '' },
  ];

  let providerCards = '';
  for (const p of providerList) {
    const selected = currentProvider === p.key ? 'selected' : '';
    const badgeHtml = p.badge ? `<span class="engine-badge ${p.badge}">${p.badgeText}</span>` : '';
    providerCards += `
      <div class="engine-card ${selected}" onclick="selectModelProvider('${p.key}', this)">
        <div class="engine-name">${escapeHtml(p.name)}</div>
        <div class="engine-desc">${escapeHtml(p.desc)}</div>
        ${badgeHtml}
      </div>
    `;
  }

  // Custom provider card (full width)
  const customSelected = currentProvider === 'custom-proxy' ? 'selected' : '';
  providerCards += `
    <div class="engine-card full-width ${customSelected}" onclick="selectCustomProvider(this)">
      <div class="engine-name">è‡ªå®šä¹‰ä¸­è½¬ç«™</div>
      <div class="engine-desc">è‡ªå®šä¹‰ Base URLï¼Œæ”¯æŒä»»æ„å…¼å®¹ OpenAI / Anthropic åè®®çš„æœåŠ¡</div>
    </div>
  `;

  const isCustom = currentProvider === 'custom-proxy';
  const isKnown = !isCustom && currentProvider;
  const modelOptions = isKnown ? getModelOptions(currentProvider, currentModelId) : '';
  const maskedKey = currentConfig.providers[currentProvider]?.maskedKey || '';

  addCard(`
    <h3>AI æ¨¡å‹é…ç½®</h3>
    <div class="provider-grid">
      ${providerCards}
    </div>

    <div id="model-config-area" class="${isKnown ? '' : 'hidden'}" style="margin-top: 12px;">
      <div class="form-group">
        <label>æ¨¡å‹é€‰æ‹©</label>
        <select class="form-input" id="model-select" onchange="onModelSelect(this.value)">
          ${modelOptions}
        </select>
      </div>
      <div class="form-group">
        <label>API Key ${maskedKey ? '(å·²é…ç½®: ' + escapeHtml(maskedKey) + ')' : ''}</label>
        <div class="input-wrap">
          <input type="password" class="form-input" id="model-apikey" placeholder="è¾“å…¥æ–°çš„ API Keyï¼ˆç•™ç©ºä¿æŒåŸæœ‰ï¼‰">
          <button class="eye-btn" onclick="toggleModelApiKeyVisibility()" id="model-eye-btn" type="button">ğŸ‘</button>
        </div>
      </div>
    </div>

    <div id="custom-config-area" class="${isCustom ? '' : 'hidden'}" style="margin-top: 12px;">
      <div class="form-group">
        <label>Base URL</label>
        <input type="text" class="form-input" id="custom-baseurl" placeholder="https://api.example.com/v1" value="${isCustom && currentConfig.providers['custom-proxy']?.baseUrl ? escapeHtml(currentConfig.providers['custom-proxy'].baseUrl) : ''}">
      </div>
      <div class="form-group">
        <label>API åè®®</label>
        <select class="form-input" id="custom-api-type">
          <option value="openai-completions" ${isCustom && currentConfig.providers['custom-proxy']?.api === 'openai-completions' ? 'selected' : ''}>OpenAI Chat Completions</option>
          <option value="anthropic-messages" ${isCustom && currentConfig.providers['custom-proxy']?.api === 'anthropic-messages' ? 'selected' : ''}>Anthropic Messages API</option>
        </select>
      </div>
      <div class="form-group">
        <label>æ¨¡å‹ ID</label>
        <input type="text" class="form-input" id="custom-model-id" placeholder="å¦‚ claude-sonnet-4-20250514" value="${isCustom ? escapeHtml(currentModelId) : ''}">
      </div>
      <div class="form-group">
        <label>API Key ${isCustom && maskedKey ? '(å·²é…ç½®: ' + escapeHtml(maskedKey) + ')' : ''}</label>
        <div class="input-wrap">
          <input type="password" class="form-input" id="custom-apikey" placeholder="è¾“å…¥ API Key">
          <button class="eye-btn" onclick="toggleCustomApiKeyVisibility()" id="custom-eye-btn" type="button">ğŸ‘</button>
        </div>
      </div>
    </div>

    <div style="margin-top: 8px; padding: 8px 12px; border-radius: 2px; border: 2px solid var(--wood-light); background: linear-gradient(135deg, #f0e6ff, #e8f0ff); font-size: 11px; color: var(--text-medium); line-height: 1.6;">
      å¦‚æœæ²¡æœ‰åˆé€‚çš„å¯ç”¨å¥—é¤ï¼Œä¹Ÿå¯ä»¥è”ç³» KK æä¾› Gemini / Claude / Codex æ»¡è¡€åŒISPç¨³å®šä¸é™æ™ºçš„ Coding Plan æ‹¼è½¦æœåŠ¡~<br>
      <a href="#" onclick="wizardAPI.openExternal('https://discord.com/users/reribth_75722'); return false;" style="color: #7c6bf0; font-weight: 600; text-decoration: underline; cursor: pointer;">Discord: reribth_75722</a>
    </div>

    <div class="btn-row">
      <button class="btn btn-test" onclick="testModelConfig()">æµ‹è¯•é…ç½®</button>
    </div>
  `);
}

function getModelOptions(provider, selectedModelId) {
  const models = modelPresets[provider] || [];
  if (models.length === 0) return '<option value="">è¯·å…ˆé€‰æ‹©æä¾›å•†</option>';
  return models.map(m =>
    `<option value="${m.id}" ${m.id === selectedModelId ? 'selected' : ''}>${m.name}</option>`
  ).join('');
}

function selectModelProvider(provider, cardEl) {
  stepData.modelProvider = provider;
  document.querySelectorAll('.provider-grid .engine-card').forEach(c => c.classList.remove('selected'));
  cardEl.classList.add('selected');

  // Update model dropdown
  const select = document.getElementById('model-select');
  select.innerHTML = getModelOptions(provider, '');
  if (select.options.length > 0) {
    stepData.modelId = select.options[0].value;
  }

  // Show preset config, hide custom
  document.getElementById('model-config-area').classList.remove('hidden');
  document.getElementById('custom-config-area').classList.add('hidden');
}

function selectCustomProvider(cardEl) {
  stepData.modelProvider = 'custom-proxy';
  document.querySelectorAll('.provider-grid .engine-card').forEach(c => c.classList.remove('selected'));
  cardEl.classList.add('selected');

  // Show custom config, hide preset
  document.getElementById('model-config-area').classList.add('hidden');
  document.getElementById('custom-config-area').classList.remove('hidden');
}

function onModelSelect(modelId) {
  stepData.modelId = modelId;
}

function toggleModelApiKeyVisibility() {
  const input = document.getElementById('model-apikey');
  const btn = document.getElementById('model-eye-btn');
  if (input.type === 'password') {
    input.type = 'text';
    btn.textContent = 'ğŸ™ˆ';
  } else {
    input.type = 'password';
    btn.textContent = 'ğŸ‘';
  }
}

function toggleCustomApiKeyVisibility() {
  const input = document.getElementById('custom-apikey');
  const btn = document.getElementById('custom-eye-btn');
  if (input.type === 'password') {
    input.type = 'text';
    btn.textContent = 'ğŸ™ˆ';
  } else {
    input.type = 'password';
    btn.textContent = 'ğŸ‘';
  }
}

async function saveModelConfig() {
  if (stepData.modelProvider === 'custom-proxy') {
    // Custom provider
    const baseUrl = document.getElementById('custom-baseurl')?.value.trim() || '';
    const apiType = document.getElementById('custom-api-type')?.value || 'openai-completions';
    const modelId = document.getElementById('custom-model-id')?.value.trim() || '';
    const apiKey = document.getElementById('custom-apikey')?.value.trim() || '';
    // BaseURL æ ¼å¼æ ¡éªŒ
    if (baseUrl && !/^https?:\/\/.+/i.test(baseUrl)) {
      await addBubble('Base URL æ ¼å¼ä¸å¯¹å“¦~ éœ€è¦ä»¥ http:// æˆ– https:// å¼€å¤´ (>_<)');
      return;
    }
    if (modelId) {
      stepData.modelId = modelId;
      await wizardAPI.invoke('wizard-save-model-config', {
        provider: 'custom-proxy',
        apiKey: apiKey,
        model: modelId,
        baseUrl: baseUrl,
        apiType: apiType,
      });
    }
  } else if (stepData.modelProvider && stepData.modelId) {
    const apiKey = document.getElementById('model-apikey')?.value.trim() || '';
    await wizardAPI.invoke('wizard-save-model-config', {
      provider: stepData.modelProvider,
      apiKey: apiKey,
      model: stepData.modelId,
    });
  }
}

async function testModelConfig() {
  if (!stepData.modelProvider) {
    await addBubble('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹æä¾›å•†å“¦~ (>_<)');
    return;
  }

  // Save first, then check
  await addBubble('æ­£åœ¨ä¿å­˜å¹¶æ£€æµ‹æ¨¡å‹é…ç½®... (o_O)');

  try {
    await saveModelConfig();

    const checkResult = await wizardAPI.invoke('wizard-check-model-config');
    if (checkResult.status === 'pass') {
      await addBubble('æ¨¡å‹é…ç½®å·²ä¿å­˜ï¼' + checkResult.message + ' âœ§*ã€‚(o^_^o)âœ§*ã€‚');
    } else {
      await addBubble('é…ç½®æœ‰é—®é¢˜: ' + checkResult.message + ' (T_T)');
    }
  } catch (err) {
    await addBubble('æµ‹è¯•å‡ºé”™: ' + err.message + ' (>_<)');
  }
}

// â”€â”€â”€ Step 3: Channel Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderStep2() {
  await addBubble('æ¥ä¸‹æ¥é…ç½®ä½ çš„æ¶ˆæ¯æ¸ é“å§~ (^_^)');
  await addBubble('æ¯ä¸ªæ¸ é“éƒ½å¯ä»¥ç‹¬ç«‹è®¾ç½®è¯­éŸ³æ’­æŠ¥å’Œæ¡Œé¢æ­Œè¯å“¦ï¼');

  let channelRows = '';
  for (const [ch, cfg] of Object.entries(stepData.channels)) {
    channelRows += `
      <div class="toggle-row">
        <div class="toggle-label">
          <span>${channelIcons[ch]}</span>
          <span>${channelNames[ch]}</span>
        </div>
        <div class="toggle-controls">
          <span class="toggle-tag">Voice</span>
          <label class="switch">
            <input type="checkbox" id="voice-${ch}" ${cfg.voice ? 'checked' : ''}>
            <span class="slider"></span>
          </label>
          <span class="toggle-tag">Lyrics</span>
          <label class="switch">
            <input type="checkbox" id="lyrics-${ch}" ${cfg.lyrics ? 'checked' : ''}>
            <span class="slider"></span>
          </label>
        </div>
      </div>
    `;
  }

  addCard(`
    <h3>æ¶ˆæ¯æ¸ é“é…ç½®</h3>
    ${channelRows}
  `);
}

// â”€â”€â”€ Step 3: TTS Engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderStep3() {
  await addBubble('ç°åœ¨æ¥é€‰æ‹©ä½ çš„è¯­éŸ³å¼•æ“å§~ (*^_^*)');
  await addBubble('æ¨èä½¿ç”¨ MiniMax Speech 2.5 Turboï¼Œæ€§ä»·æ¯”è¶…é«˜çš„ï¼');

  // Load existing config
  try {
    const config = await wizardAPI.invoke('wizard-get-config');
    if (config.ttsEngine === 'minimax' && config.minimax?.apiKey) {
      stepData.ttsEngine = config.minimax?.model === 'speech-2.8-hd' ? 'minimax-hd' : 'minimax';
      stepData.ttsApiKey = config.minimax.apiKey;
    } else if (config.ttsEngine === 'dashscope' && config.dashscope?.apiKey) {
      stepData.ttsEngine = 'cosyvoice';
      stepData.ttsApiKey = config.dashscope.apiKey;
    } else {
      stepData.ttsEngine = 'edge';
      stepData.ttsApiKey = '';
    }
  } catch (e) { /* use defaults */ }

  addCard(`
    <h3>TTS è¯­éŸ³å¼•æ“é€‰æ‹©</h3>
    <div class="engine-list">
      <div class="engine-card ${stepData.ttsEngine === 'minimax-hd' ? 'selected' : ''}" onclick="selectEngine('minimax-hd', this)">
        <div class="engine-name">MiniMax Speech 2.8 HD</div>
        <div class="engine-desc">æœ€ä½³éŸ³è´¨ï¼Œæƒ…æ„Ÿä¸°å¯Œï¼Œéœ€è¦ API Key</div>
        <span class="engine-badge best">æœ€ä½³éŸ³è´¨</span>
      </div>
      <div class="engine-card ${stepData.ttsEngine === 'minimax' ? 'selected' : ''}" onclick="selectEngine('minimax', this)">
        <div class="engine-name">MiniMax Speech 2.5 Turbo</div>
        <div class="engine-desc">æ€§ä»·æ¯”é«˜ï¼Œé€Ÿåº¦å¿«ï¼Œéœ€è¦ API Key</div>
        <span class="engine-badge recommend">æ¨è</span>
      </div>
      <div class="engine-card ${stepData.ttsEngine === 'cosyvoice' ? 'selected' : ''}" onclick="selectEngine('cosyvoice', this)">
        <div class="engine-name">CosyVoice (é˜¿é‡Œäº‘ DashScope)</div>
        <div class="engine-desc">é˜¿é‡Œäº‘è¯­éŸ³åˆæˆï¼Œéœ€è¦ API Key</div>
      </div>
      <div class="engine-card ${stepData.ttsEngine === 'edge' ? 'selected' : ''}" onclick="selectEngine('edge', this)">
        <div class="engine-name">Edge TTS</div>
        <div class="engine-desc">å…è´¹ã€æ— éœ€é…ç½®ï¼Œä½œä¸ºå…œï¿½ï¿½æ–¹æ¡ˆ</div>
        <span class="engine-badge free">å…è´¹</span>
      </div>
    </div>

    <div id="env-python" class="env-check">æ£€æµ‹ Python ç¯å¢ƒä¸­...</div>

    <div id="apikey-area" class="${stepData.ttsEngine === 'edge' ? 'hidden' : ''}" style="margin-top: 12px;">
      <div class="form-group">
        <label>API Key</label>
        <div class="input-wrap">
          <input type="password" class="form-input" id="tts-apikey" placeholder="è¯·è¾“å…¥ API Key" value="${stepData.ttsApiKey || ''}">
          <button class="eye-btn" onclick="toggleApiKeyVisibility()" id="eye-btn" type="button">ğŸ‘</button>
        </div>
      </div>
    </div>

    <div id="voice-clone-area" class="${stepData.ttsEngine === 'edge' ? 'hidden' : ''}" style="margin-top: 14px; border-top: 2px dashed var(--parchment-dark); padding-top: 12px;">
      <h3 style="font-size: 12px; margin-bottom: 8px;">ğŸ¤ éŸ³è‰²é€‰æ‹©</h3>
      
      <!-- å½“å‰éŸ³è‰²æ˜¾ç¤º -->
      <div id="current-voice-display" class="note-box" style="background: #e8f5e9; border-color: var(--grass-light);">
        <strong>å½“å‰éŸ³è‰²:</strong> <span id="current-voice-name">female-tianmei (ç”œç¾å¥³æ€§)</span>
      </div>

      <!-- é¢„è®¾éŸ³è‰²é€‰æ‹© -->
      <div class="form-group">
        <label>é€‰æ‹©é¢„è®¾éŸ³è‰²ï¼ˆå…è´¹ï¼Œæ— éœ€å…‹éš†ï¼‰</label>
        <select class="form-input" id="preset-voice-select" onchange="onPresetVoiceChange(this.value)">
          <option value="female-tianmei">ç”œç¾å¥³æ€§éŸ³è‰²</option>
          <option value="female-shaonv">å°‘å¥³éŸ³è‰²</option>
          <option value="diadia_xuemei">å—²å—²å­¦å¦¹</option>
          <option value="qiaopi_mengmei">ä¿çš®èŒå¦¹</option>
          <option value="tianxin_xiaoling">ç”œå¿ƒå°ç²</option>
          <option value="lovely_girl">èŒèŒå¥³ç«¥</option>
          <option value="Sweet_Girl">Sweet Girl</option>
          <option value="Cute_Elf">Cute Elf</option>
          <option value="custom">è‡ªå®šä¹‰ Voice ID...</option>
        </select>
      </div>

      <!-- è‡ªå®šä¹‰ Voice ID è¾“å…¥æ¡† -->
      <div class="form-group hidden" id="custom-voice-input-area">
        <label>è‡ªå®šä¹‰ Voice ID</label>
        <input type="text" class="form-input" id="custom-voice-id" placeholder="è¾“å…¥ä½ çš„ voice_id (ä¾‹å¦‚: my_voice_123)" oninput="onCustomVoiceIdInput()">
        <div style="font-size: 11px; color: var(--text-medium); margin-top: 4px;">
          ğŸ’¡ å¦‚æœä½ åœ¨ MiniMax æ§åˆ¶å°å·²ç»å…‹éš†äº†éŸ³è‰²ï¼Œå¯ä»¥åœ¨è¿™é‡Œå¡«å…¥ voice_id
        </div>
      </div>

      <!-- è‡ªå®šä¹‰å…‹éš†ï¼ˆå¯é€‰ï¼‰ -->
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--parchment-dark);">
        <h3 style="font-size: 11px; margin-bottom: 6px; color: var(--text-medium);">ğŸ™ï¸ é«˜çº§ï¼šå…‹éš†ä½ çš„ä¸“å±éŸ³è‰²ï¼ˆå¯é€‰ï¼‰</h3>
        <div class="note-box">ğŸ’¡ ä¸Šä¼ 30ç§’ä»¥ä¸Šçš„æ¸…æ™°å½•éŸ³ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å…‹éš†ä½ çš„ä¸“å±éŸ³è‰²ã€‚</div>
        <div class="form-group">
          <label>ä¸Šä¼ å½•éŸ³æ–‡ä»¶</label>
          <div class="upload-area" id="voice-upload-area"
            onclick="document.getElementById('voice-file-input').click()"
            ondragover="event.preventDefault(); this.classList.add('dragover')"
            ondragleave="this.classList.remove('dragover')"
            ondrop="handleVoiceDrop(event)">
            <div class="upload-icon">ğŸ™ï¸</div>
            <div class="upload-text" id="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½éŸ³é¢‘æ–‡ä»¶</div>
            <div class="upload-hint">æ”¯æŒ MP3ã€WAVã€M4Aï¼Œå»ºè®®30ç§’ä»¥ä¸Š</div>
          </div>
          <input type="file" id="voice-file-input" accept="audio/*" style="display:none" onchange="handleVoiceFile(this)">
        </div>
        <div class="form-group">
          <label>éŸ³è‰²åç§°</label>
          <input type="text" class="form-input" id="voice-clone-name" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„å£°éŸ³">
        </div>
        <div class="btn-row">
          <button class="btn btn-primary btn-small" onclick="startVoiceClone()" id="btn-clone">å¼€å§‹å…‹éš†</button>
        </div>
        <div id="clone-status"></div>
      </div>
    </div>

    <div class="btn-row" style="margin-top: 12px;">
      <button class="btn btn-test" onclick="testTTS()">è¯•å¬ä¸€ä¸‹</button>
    </div>
  `);

  // Check Python environment
  checkPythonEnv();

  // å›æ˜¾å·²ä¿å­˜çš„éŸ³è‰²
  try {
    const config = await wizardAPI.invoke('wizard-get-config');
    let savedVoiceId = '';
    if (stepData.ttsEngine === 'minimax' || stepData.ttsEngine === 'minimax-hd') {
      savedVoiceId = config.minimax?.voiceId || 'female-tianmei';
    } else if (stepData.ttsEngine === 'cosyvoice') {
      savedVoiceId = config.dashscope?.voice || 'longxiaochun';
    }
    if (savedVoiceId) {
      currentVoiceId = savedVoiceId;
      const select = document.getElementById('preset-voice-select');
      if (select) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯é¢„è®¾éŸ³è‰²
        const isPreset = Array.from(select.options).some(opt => opt.value === savedVoiceId);
        if (isPreset) {
          select.value = savedVoiceId;
          onPresetVoiceChange(savedVoiceId);
        } else {
          // è‡ªå®šä¹‰éŸ³è‰² - é€‰ä¸­"è‡ªå®šä¹‰"é€‰é¡¹å¹¶å¡«å…¥ voice_id
          select.value = 'custom';
          const customInput = document.getElementById('custom-voice-id');
          const customInputArea = document.getElementById('custom-voice-input-area');
          if (customInput && customInputArea) {
            customInput.value = savedVoiceId;
            customInputArea.classList.remove('hidden');
            document.getElementById('current-voice-name').textContent = `${savedVoiceId} (è‡ªå®šä¹‰)`;
          }
          // å¦‚æœæ˜¯åˆ«äººçš„å…‹éš†éŸ³è‰²ï¼Œæç¤ºåˆ‡æ¢
          if (savedVoiceId.includes('xiaotuantuan') || savedVoiceId.includes('tuantuan')) {
            await addBubble('æ£€æµ‹åˆ°ä½ ä½¿ç”¨çš„æ˜¯åˆ«äººçš„å…‹éš†éŸ³è‰²ï¼Œå¯èƒ½æ²¡æœ‰æƒé™è®¿é—®ã€‚å»ºè®®åˆ‡æ¢åˆ°é¢„è®¾éŸ³è‰²æˆ–ä¸Šä¼ è‡ªå·±çš„å½•éŸ³å…‹éš†~ (^_^)');
          }
        }
      }
    }
  } catch {}
}

function selectEngine(engine, cardEl) {
  stepData.ttsEngine = engine;
  stepData._ttsSkipWarned = false;
  document.querySelectorAll('.engine-card').forEach(c => c.classList.remove('selected'));
  cardEl.classList.add('selected');

  const apikeyArea = document.getElementById('apikey-area');
  if (engine === 'edge') {
    apikeyArea.classList.add('hidden');
    stepData.ttsApiKey = '';
  } else {
    apikeyArea.classList.remove('hidden');
  }

  // Toggle voice clone area
  const cloneArea = document.getElementById('voice-clone-area');
  if (cloneArea) {
    if (engine === 'edge') {
      cloneArea.classList.add('hidden');
    } else {
      cloneArea.classList.remove('hidden');
    }
  }
}

function toggleApiKeyVisibility() {
  const input = document.getElementById('tts-apikey');
  const btn = document.getElementById('eye-btn');
  if (input.type === 'password') {
    input.type = 'text';
    btn.textContent = 'ğŸ™ˆ';
  } else {
    input.type = 'password';
    btn.textContent = 'ğŸ‘';
  }
}

async function checkPythonEnv() {
  const el = document.getElementById('env-python');
  try {
    const result = await wizardAPI.invoke('wizard-check-python');
    if (result.available) {
      if (result.edgeTTS) {
        el.className = 'env-check ok';
        el.textContent = `âœ“ Python ${result.version} + edge-tts (Edge TTS / CosyVoice å¯ç”¨)`;
      } else {
        el.className = 'env-check ok';
        el.textContent = `âœ“ Python ${result.version} (CosyVoice å¯ç”¨ | Edge TTS éœ€å®‰è£…: pip install edge-tts)`;
      }
    } else {
      el.className = 'env-check err';
      el.textContent = 'âœ— æœªæ£€æµ‹åˆ° Python â€” Edge TTS å’Œ CosyVoice ä¸å¯ç”¨';
    }
  } catch {
    el.className = 'env-check err';
    el.textContent = 'âœ— Python ç¯å¢ƒæ£€æµ‹å¤±è´¥';
  }
}

// â”€â”€â”€ Voice Clone Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedVoiceFile = null;
let currentVoiceId = 'female-tianmei'; // é»˜è®¤éŸ³è‰²

function onPresetVoiceChange(voiceId) {
  const customInputArea = document.getElementById('custom-voice-input-area');
  const customInput = document.getElementById('custom-voice-id');
  
  if (voiceId === 'custom') {
    // æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥æ¡†
    customInputArea.classList.remove('hidden');
    currentVoiceId = customInput.value.trim() || 'female-tianmei';
    document.getElementById('current-voice-name').textContent = `${currentVoiceId} (è‡ªå®šä¹‰)`;
  } else {
    // éšè—è‡ªå®šä¹‰è¾“å…¥æ¡†
    customInputArea.classList.add('hidden');
    currentVoiceId = voiceId;
    const voiceNames = {
      'female-tianmei': 'ç”œç¾å¥³æ€§éŸ³è‰²',
      'female-shaonv': 'å°‘å¥³éŸ³è‰²',
      'diadia_xuemei': 'å—²å—²å­¦å¦¹',
      'qiaopi_mengmei': 'ä¿çš®èŒå¦¹',
      'tianxin_xiaoling': 'ç”œå¿ƒå°ç²',
      'lovely_girl': 'èŒèŒå¥³ç«¥',
      'Sweet_Girl': 'Sweet Girl',
      'Cute_Elf': 'Cute Elf'
    };
    const displayName = voiceNames[voiceId] || voiceId;
    document.getElementById('current-voice-name').textContent = `${voiceId} (${displayName})`;
  }
  
  // ä¿å­˜åˆ°é…ç½®
  wizardAPI.invoke('wizard-save-voice-id', { voiceId: currentVoiceId }).catch(() => {});
}

// ç›‘å¬è‡ªå®šä¹‰ voice_id è¾“å…¥
function onCustomVoiceIdInput() {
  const customInput = document.getElementById('custom-voice-id');
  const voiceId = customInput.value.trim();
  if (voiceId) {
    currentVoiceId = voiceId;
    document.getElementById('current-voice-name').textContent = `${voiceId} (è‡ªå®šä¹‰)`;
    wizardAPI.invoke('wizard-save-voice-id', { voiceId }).catch(() => {});
  }
}

function handleVoiceFile(input) {
  if (input.files && input.files[0]) {
    selectedVoiceFile = input.files[0];
    const area = document.getElementById('voice-upload-area');
    const text = document.getElementById('upload-text');
    area.classList.add('has-file');
    text.textContent = selectedVoiceFile.name + ' (' + (selectedVoiceFile.size / 1024 / 1024).toFixed(1) + 'MB)';
  }
}

function handleVoiceDrop(event) {
  event.preventDefault();
  const area = document.getElementById('voice-upload-area');
  area.classList.remove('dragover');
  if (event.dataTransfer.files && event.dataTransfer.files[0]) {
    handleVoiceFile({ files: event.dataTransfer.files });
  }
}

async function startVoiceClone() {
  if (!selectedVoiceFile) {
    await addBubble('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶å“¦~ (>_<)');
    return;
  }
  const maxSizeMB = 50;
  if (selectedVoiceFile.size > maxSizeMB * 1024 * 1024) {
    await addBubble(`æ–‡ä»¶å¤ªå¤§å•¦ï¼æœ€å¤§æ”¯æŒ ${maxSizeMB}MBï¼Œä½ çš„æ–‡ä»¶æ˜¯ ${(selectedVoiceFile.size / 1024 / 1024).toFixed(1)}MB (>_<)`);
    return;
  }
  const apiKeyEl = document.getElementById('tts-apikey');
  const apiKey = apiKeyEl ? apiKeyEl.value.trim() : '';
  if (!apiKey) {
    await addBubble('å…‹éš†éŸ³è‰²éœ€è¦ API Key å“¦~ è¯·å…ˆå¡«å…¥ API Key (>_<)');
    return;
  }
  const cloneName = document.getElementById('voice-clone-name').value.trim() || 'æˆ‘çš„å£°éŸ³';
  const statusEl = document.getElementById('clone-status');
  statusEl.innerHTML = '<div class="status-item"><div class="status-icon loading"></div><span>æ­£åœ¨ä¸Šä¼ å¹¶å…‹éš†éŸ³è‰²... è¯·è€å¿ƒç­‰å¾…ï¼ˆçº¦30ç§’ï¼‰</span></div>';
  document.getElementById('btn-clone').disabled = true;

  await addBubble('å¼€å§‹å…‹éš†éŸ³è‰²å•¦ï¼ä¸Šä¼ ä¸­... è¯·è€å¿ƒç­‰å¾…~ (o_O)');

  try {
    const arrayBuffer = await selectedVoiceFile.arrayBuffer();
    const base64 = btoa(new Uint8Array(arrayBuffer).reduce((data, byte) => data + String.fromCharCode(byte), ''));

    const result = await wizardAPI.invoke('wizard-clone-voice', {
      engine: stepData.ttsEngine,
      apiKey: apiKey,
      audioBase64: base64,
      fileName: selectedVoiceFile.name,
      voiceName: cloneName
    });

    if (result.success) {
      statusEl.innerHTML = '<div class="status-item"><div class="status-icon success">âœ“</div><span>éŸ³è‰²å…‹éš†æˆåŠŸï¼ID: ' + escapeHtml(result.voiceId) + '</span></div>';
      stepData.clonedVoiceId = result.voiceId;
      currentVoiceId = result.voiceId;
      // æ›´æ–°å½“å‰éŸ³è‰²æ˜¾ç¤º
      document.getElementById('current-voice-name').textContent = `${result.voiceId} (è‡ªå®šä¹‰å…‹éš†)`;
      await addBubble('éŸ³è‰²å…‹éš†æˆåŠŸå•¦ï¼(^_^) è¯•å¬ä¸€ä¸‹æ–°éŸ³è‰²...');
      // Auto-test with new voice
      try { await testTTS(); } catch {}
    } else {
      statusEl.innerHTML = '<div class="status-item"><div class="status-icon fail">âœ—</div><span>' + escapeHtml(result.error) + '</span></div>';
      await addBubble('å…‹éš†å¤±è´¥äº† (T_T): ' + result.error);
    }
  } catch (err) {
    statusEl.innerHTML = '<div class="status-item"><div class="status-icon fail">âœ—</div><span>' + escapeHtml(err.message) + '</span></div>';
    await addBubble('å‡ºé”™äº† (>_<): ' + err.message);
  }
  document.getElementById('btn-clone').disabled = false;
}

async function skipWizard() {
  if (confirm('è·³è¿‡å‘å¯¼å°†ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œç¡®å®šå—ï¼Ÿ')) {
    await wizardAPI.invoke('wizard-complete');
    window.close();
  }
}

async function testTTS() {
  const apiKeyEl = document.getElementById('tts-apikey');
  if (apiKeyEl) stepData.ttsApiKey = apiKeyEl.value.trim();

  if (stepData.ttsEngine !== 'edge' && !stepData.ttsApiKey) {
    await addBubble('è¯·å…ˆè¾“å…¥ API Key æ‰èƒ½è¯•å¬å“¦~ (>_<)');
    return;
  }

  await addBubble('æ­£åœ¨ç”Ÿæˆè¯•å¬è¯­éŸ³... è¯·ç¨ç­‰~ â™ª(^_^)â™ª');

  try {
    const result = await wizardAPI.invoke('wizard-test-tts', {
      engine: stepData.ttsEngine,
      apiKey: stepData.ttsApiKey,
      voiceId: currentVoiceId  // ä¼ å…¥å½“å‰é€‰ä¸­çš„ voice_id
    });
    if (result.success) {
      await addBubble('å¬åˆ°äº†å—ï¼Ÿæ•ˆæœæ€ä¹ˆæ ·~ (o^_^o)');
    } else {
      await addBubble('å‘œ...è¯•å¬å¤±è´¥äº† (T_T) é”™è¯¯: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
    }
  } catch (err) {
    await addBubble('å‘œ...å‡ºé”™äº†: ' + err.message + ' (>_<)');
  }
}

// â”€â”€â”€ Step 4: Agent Voice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderStep4() {
  await addBubble('ç°åœ¨æ¥é…ç½® Agent è¯­éŸ³æ’­æŠ¥å§ï¼(^_^)');

  // Auto-detect OpenClaw dir
  let detectedDir = '';
  try {
    const result = await wizardAPI.invoke('wizard-detect-openclaw-dir');
    detectedDir = result.dir || '';
  } catch {}

  if (detectedDir) {
    await addBubble('æ‰¾åˆ°äº†ä½ çš„ OpenClaw ç›®å½•ï¼Œå·²è‡ªåŠ¨å¡«å…¥~ (o^_^o)');
  } else {
    await addBubble('æ²¡æ‰¾åˆ°é»˜è®¤çš„ OpenClaw ç›®å½•ï¼Œè¯·æ‰‹åŠ¨æŒ‡å®šè·¯å¾„ (o_O)');
  }

  addCard(`
    <h3>Agent è¯­éŸ³æ’­æŠ¥é…ç½®</h3>
    <div class="form-group">
      <label>OpenClaw å·¥ä½œç›®å½•</label>
      <input type="text" class="form-input" id="workspace-dir" placeholder="~/.openclaw/" value="${escapeHtml(detectedDir)}">
    </div>

    <div style="border-top: 2px dashed var(--parchment-dark); padding-top: 12px; margin-top: 12px;">
      <h3 style="font-size: 12px; margin-bottom: 8px;">ğŸ­ Agent äººè®¾å®šåˆ¶</h3>
      <div class="note-box">ğŸ’¡ å®šä¹‰ä½ çš„ Agent è¯´è¯é£æ ¼ã€‚è¿™ä¼šå½±å“è¯­éŸ³æ’­æŠ¥çš„å£å»å’Œç”¨è¯ã€‚äººè®¾å¯ä»¥å’Œåˆ«äººä¸ä¸€æ ·ï¼Œåšä½ è‡ªå·±çš„ AI ä¼™ä¼´ï¼</div>

      <div class="form-group">
        <label>å® ç‰©æ˜µç§°ï¼ˆAgent çš„åå­—ï¼‰</label>
        <input type="text" class="form-input" id="pet-name" placeholder="ä¾‹å¦‚ï¼šå°Kã€å°åŠ©æ‰‹ã€Claw">
      </div>

      <div class="form-group">
        <label>ä½ çš„ç§°å‘¼ï¼ˆå® ç‰©æ€ä¹ˆå«ä½ ï¼‰</label>
        <input type="text" class="form-input" id="user-name" placeholder="ä¾‹å¦‚ï¼šä¸»äººã€Bossã€KK">
      </div>

      <div class="form-group">
        <label>è¯´è¯é£æ ¼</label>
        <select class="form-input" id="personality-preset" onchange="onPersonalityPresetChange(this.value)">
          <option value="sweet">ç”œå¦¹é£æ ¼ â€” æ¸©æŸ”å¯çˆ±ï¿½ï¿½ï¿½å¶å°”æ’’å¨‡</option>
          <option value="professional">ä¸“ä¸šåŠ©æ‰‹ â€” é«˜æ•ˆä¸¥è°¨ï¼Œæ¡ç†æ¸…æ™°</option>
          <option value="funny">å¹½é»˜ææ€ª â€” çˆ±å¼€ç©ç¬‘ï¼Œè½»æ¾æ´»æ³¼</option>
          <option value="cool">é…·å¸…é£æ ¼ â€” ç®€æ´åˆ©è½ï¼Œä¸åºŸè¯</option>
          <option value="custom">è‡ªå®šä¹‰...</option>
        </select>
      </div>

      <div class="form-group hidden" id="custom-personality-area">
        <label>è‡ªå®šä¹‰äººè®¾æè¿°</label>
        <textarea class="form-input" id="custom-personality" rows="3" style="resize: vertical;" placeholder="æè¿°ä½ æƒ³è¦çš„ Agent æ€§æ ¼å’Œè¯´è¯æ–¹å¼..."></textarea>
      </div>
    </div>

    <div class="note-box" style="margin-top: 12px;">
      ğŸ’¡ <strong>å…³äºæ¨¡å‹å…¼å®¹æ€§ï¼š</strong>ä¸åŒ AI æ¨¡å‹çš„æŒ‡ä»¤éµå¾ªåº¦ä¸åŒã€‚Claude Opus/Sonnet ç­‰æ——èˆ°æ¨¡å‹å‡ ä¹ä¸ä¼šå¿˜è®°æ’­æŠ¥ï¼Œä½† Haikuã€DeepSeekã€Kimi ç­‰è½»é‡æ¨¡å‹å¯èƒ½æ—¶çµæ—¶ä¸çµã€‚è¿™æ˜¯æ¨¡å‹èƒ½åŠ›å·®å¼‚ï¼Œä¸æ˜¯é…ç½®é—®é¢˜ã€‚<strong>æ¨èä½¿ç”¨ Claude Sonnet 4 åŠä»¥ä¸Šæ——èˆ°æ¨¡å‹ã€‚</strong>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary btn-small" onclick="setupAgentVoice()">é…ç½®æ’­æŠ¥</button>
      <button class="btn btn-test" onclick="testAgentVoice()">æµ‹è¯•æ’­æŠ¥</button>
    </div>
    <div id="agent-voice-status" class="mt-8"></div>
  `);

  // å›æ˜¾å·²ä¿å­˜çš„äººè®¾é…ç½®
  try {
    const cfg = await wizardAPI.invoke('wizard-get-config');
    const av = cfg.agentVoice || {};
    if (av.workspaceDir) document.getElementById('workspace-dir').value = av.workspaceDir;
    if (av.petName) document.getElementById('pet-name').value = av.petName;
    if (av.userName) document.getElementById('user-name').value = av.userName;
    if (av.personalityPreset) {
      document.getElementById('personality-preset').value = av.personalityPreset;
      onPersonalityPresetChange(av.personalityPreset);
    }
    if (av.customPersonality) document.getElementById('custom-personality').value = av.customPersonality;
  } catch {}
}

function onPersonalityPresetChange(value) {
  const customArea = document.getElementById('custom-personality-area');
  if (value === 'custom') {
    customArea.classList.remove('hidden');
  } else {
    customArea.classList.add('hidden');
  }
}

async function setupAgentVoice() {
  const workspaceDir = document.getElementById('workspace-dir').value.trim() || '';
  const petName = document.getElementById('pet-name').value.trim() || 'å°åŠ©æ‰‹';
  const userName = document.getElementById('user-name').value.trim() || 'ä¸»äºº';
  const personalityPreset = document.getElementById('personality-preset').value;
  const customPersonality = document.getElementById('custom-personality')?.value?.trim() || '';

  const statusEl = document.getElementById('agent-voice-status');
  statusEl.innerHTML = '<div class="status-item"><div class="status-icon loading"></div><span>æ­£åœ¨é…ç½®ä¸­...</span></div>';

  await addBubble('è®©æˆ‘æ¥é…ç½®... (o_O)');

  try {
    const result = await wizardAPI.invoke('wizard-setup-agent-voice', {
      workspaceDir: workspaceDir || null,
      petName,
      userName,
      personalityPreset,
      customPersonality
    });
    if (result.success) {
      statusEl.innerHTML = `
        <div class="status-item"><div class="status-icon success">âœ“</div><span>desktop-bridge.js å·²åˆ›å»º</span></div>
        <div class="status-item"><div class="status-icon success">âœ“</div><span>AGENTS.md å®Œæ•´æ¨¡æ¿å·²ç”Ÿæˆ</span></div>
        <div class="status-item"><div class="status-icon success">âœ“</div><span>SOUL.md äººè®¾æ–‡ä»¶å·²ç”Ÿæˆ</span></div>
        <div class="status-item"><div class="status-icon success">âœ“</div><span>USER.md ç”¨æˆ·ä¿¡æ¯å·²ç”Ÿæˆ</span></div>
        <div class="status-item"><div class="status-icon success">âœ“</div><span>HEARTBEAT.md å¿ƒè·³é…ç½®å·²ç”Ÿæˆ</span></div>
      `;
      await addBubble('æå®šå•¦~ (o^_^o) å…¨å¥—é…ç½®æ–‡ä»¶éƒ½ç”Ÿæˆå¥½äº†ï¼');
    } else {
      statusEl.innerHTML = `<div class="status-item"><div class="status-icon fail">âœ—</div><span>${escapeHtml(result.error)}</span></div>`;
      await addBubble('å‘œ...é…ç½®å¤±è´¥äº† (T_T): ' + result.error);
    }
  } catch (err) {
    statusEl.innerHTML = `<div class="status-item"><div class="status-icon fail">âœ—</div><span>${escapeHtml(err.message)}</span></div>`;
    await addBubble('å‡ºé”™äº† (>_<): ' + err.message);
  }
}

async function testAgentVoice() {
  await addBubble('å‘é€ä¸€æ¡æµ‹è¯•æ’­æŠ¥... (^_^)');

  try {
    const result = await wizardAPI.invoke('wizard-test-agent-voice');
    if (result.success) {
      await addBubble('æ’­æŠ¥æµ‹è¯•æˆåŠŸï¼ä½ åº”è¯¥å¬åˆ°å£°éŸ³äº†~ â™ª(^_^)â™ª');
    } else {
      await addBubble('æ’­æŠ¥æµ‹è¯•å¤±è´¥äº†... (T_T) è¯·ç¡®ä¿æ¡Œé¢å® ç‰©ä¸»ç¨‹åºæ­£åœ¨è¿è¡Œ~');
    }
  } catch (err) {
    await addBubble('æµ‹è¯•å‡ºé”™: ' + err.message + ' (>_<)');
  }
}

// â”€â”€â”€ Step 5: Display Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderStep5() {
  await addBubble('å¿«è¦å®Œæˆå•¦ï¼æ¥è®¾ç½®ä¸€ä¸‹æ˜¾ç¤ºé€‰é¡¹å§~ (^_^)');

  addCard(`
    <h3>æ¡Œé¢æ˜¾ç¤ºè®¾ç½®</h3>
    <div class="toggle-row">
      <div>
        <div class="toggle-label">æ¡Œé¢æ­Œè¯</div>
        <div class="toggle-sublabel">åœ¨å® ç‰©ä¸Šæ–¹æ˜¾ç¤ºæ¶ˆæ¯å­—å¹•</div>
      </div>
      <label class="switch">
        <input type="checkbox" id="toggle-lyrics" ${stepData.lyricsEnabled ? 'checked' : ''}>
        <span class="slider"></span>
      </label>
    </div>
    <div class="toggle-row">
      <div>
        <div class="toggle-label">çƒä½“ç½®é¡¶</div>
        <div class="toggle-sublabel">å® ç‰©å§‹ç»ˆæ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚</div>
      </div>
      <label class="switch">
        <input type="checkbox" id="toggle-ontop" ${stepData.alwaysOnTop ? 'checked' : ''}>
        <span class="slider"></span>
      </label>
    </div>
    <div class="toggle-row">
      <div>
        <div class="toggle-label">å¼€æœºè‡ªå¯åŠ¨</div>
        <div class="toggle-sublabel">Windows å¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ</div>
      </div>
      <label class="switch">
        <input type="checkbox" id="toggle-autolaunch" ${stepData.autoLaunch ? 'checked' : ''}>
        <span class="slider"></span>
      </label>
    </div>
  `);
}

// â”€â”€â”€ Step 6: Full Test & Complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderStep6() {
  await addBubble('æœ€åä¸€æ­¥ï¼æ¥åšä¸€ä¸ªå…¨é“¾è·¯æµ‹è¯•å§~ (*^_^*)');
  await addBubble('æˆ‘ä¼šä¾æ¬¡æµ‹è¯• Gatewayã€æ¨¡å‹é…ç½®ã€TTSã€æ’­æŠ¥ã€æ­Œè¯... è¯·ç¨ç­‰ï¼');

  const card = addCard(`
    <h3>å…¨é“¾è·¯æµ‹è¯•</h3>
    <div class="test-list" id="test-list">
      <div class="test-item" id="test-gw">
        <div class="status-icon loading" id="test-gw-icon"></div>
        <span class="test-name">Gateway è¿æ¥</span>
        <span class="test-msg" id="test-gw-msg">æµ‹è¯•ä¸­...</span>
        <button class="retry-btn hidden" id="test-gw-retry" onclick="retrySingleTest('gateway')">é‡è¯•</button>
      </div>
      <div class="test-item" id="test-model">
        <div class="status-icon loading" id="test-model-icon"></div>
        <span class="test-name">AI æ¨¡å‹é…ç½®</span>
        <span class="test-msg" id="test-model-msg">ç­‰å¾…ä¸­...</span>
        <button class="retry-btn hidden" id="test-model-retry" onclick="retrySingleTest('model')">é‡è¯•</button>
      </div>
      <div class="test-item" id="test-tts">
        <div class="status-icon loading" id="test-tts-icon"></div>
        <span class="test-name">TTS è¯­éŸ³å¼•æ“</span>
        <span class="test-msg" id="test-tts-msg">ç­‰å¾…ä¸­...</span>
        <button class="retry-btn hidden" id="test-tts-retry" onclick="retrySingleTest('tts')">é‡è¯•</button>
      </div>
      <div class="test-item" id="test-voice">
        <div class="status-icon loading" id="test-voice-icon"></div>
        <span class="test-name">è¯­éŸ³æ’­æŠ¥é“¾è·¯</span>
        <span class="test-msg" id="test-voice-msg">ç­‰å¾…ä¸­...</span>
        <button class="retry-btn hidden" id="test-voice-retry" onclick="retrySingleTest('voice')">é‡è¯•</button>
      </div>
      <div class="test-item" id="test-lyrics">
        <div class="status-icon loading" id="test-lyrics-icon"></div>
        <span class="test-name">æ¡Œé¢æ­Œè¯</span>
        <span class="test-msg" id="test-lyrics-msg">ç­‰å¾…ä¸­...</span>
      </div>
      <div class="test-item" id="test-files">
        <div class="status-icon loading" id="test-files-icon"></div>
        <span class="test-name">Agent é…ç½®æ–‡ä»¶</span>
        <span class="test-msg" id="test-files-msg">ç­‰å¾…ä¸­...</span>
      </div>
      <div class="test-item" id="test-clone">
        <div class="status-icon loading" id="test-clone-icon"></div>
        <span class="test-name">è‡ªå®šä¹‰éŸ³è‰²</span>
        <span class="test-msg" id="test-clone-msg">ç­‰å¾…ä¸­...</span>
      </div>
    </div>
  `);

  // Disable next button during testing
  document.getElementById('btnNext').disabled = true;

  try {
    const results = await wizardAPI.invoke('wizard-run-full-test');
    stepData.testResults = results;

    // Update UI
    updateTestItem('gw', results.gateway);
    updateTestItem('model', results.model);
    updateTestItem('tts', results.tts);
    updateTestItem('voice', results.voice);
    updateTestItem('lyrics', results.lyrics);
    updateTestItem('files', results.files);
    updateTestItem('clone', results.clone);

    const allPass = Object.values(results).every(r => r.status === 'pass' || r.status === 'skip');
    if (allPass) {
      await addBubble('å…¨éƒ¨é…ç½®å¥½å•¦ï¼ï¼ï¼ âœ§*ã€‚(>_<)âœ§*ã€‚');
      showCelebration();
    } else {
      const failCount = Object.values(results).filter(r => r.status === 'fail').length;
      await addBubble(`æœ‰ ${failCount} é¡¹æµ‹è¯•æ²¡é€šè¿‡å‘¢... (T_T) ä¸è¿‡æ²¡å…³ç³»ï¼Œå¯ä»¥ä¹‹åå†è°ƒæ•´ï¼`);
    }
  } catch (err) {
    await addBubble('æµ‹è¯•è¿‡ç¨‹å‡ºé”™äº†: ' + err.message + ' (>_<)');
  }

  document.getElementById('btnNext').disabled = false;
}

function updateTestItem(key, result) {
  const item = document.getElementById(`test-${key}`);
  const icon = document.getElementById(`test-${key}-icon`);
  const msg = document.getElementById(`test-${key}-msg`);
  const retryBtn = document.getElementById(`test-${key}-retry`);

  icon.className = 'status-icon';
  if (result.status === 'pass') {
    icon.classList.add('success');
    icon.textContent = 'âœ“';
    item.className = 'test-item pass';
    if (retryBtn) retryBtn.classList.add('hidden');
  } else if (result.status === 'fail') {
    icon.classList.add('fail');
    icon.textContent = 'âœ—';
    item.className = 'test-item fail';
    if (retryBtn) retryBtn.classList.remove('hidden');
  } else {
    icon.textContent = 'â€”';
    item.className = 'test-item skip';
    if (retryBtn) retryBtn.classList.add('hidden');
  }
  msg.textContent = result.message;
}

async function retrySingleTest(testKey) {
  const keyMap = { gateway: 'gw', model: 'model', tts: 'tts', voice: 'voice' };
  const uiKey = keyMap[testKey] || testKey;
  const icon = document.getElementById(`test-${uiKey}-icon`);
  const msg = document.getElementById(`test-${uiKey}-msg`);
  const retryBtn = document.getElementById(`test-${uiKey}-retry`);

  icon.className = 'status-icon loading';
  icon.textContent = '';
  msg.textContent = 'é‡è¯•ä¸­...';
  if (retryBtn) retryBtn.classList.add('hidden');

  try {
    const result = await wizardAPI.invoke('wizard-retry-single-test', testKey);
    updateTestItem(uiKey, result);
    if (stepData.testResults) stepData.testResults[testKey] = result;
  } catch (err) {
    updateTestItem(uiKey, { status: 'fail', message: err.message });
  }
}

// ===== Celebration =====
function showCelebration() {
  const container = document.getElementById('celebration');
  container.classList.remove('hidden');
  const colors = ['#ffc107', '#ff9800', '#4caf50', '#8bc34a', '#795548', '#ff5722'];

  for (let i = 0; i < 60; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 2 + 's';
    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
    confetti.style.width = (4 + Math.random() * 6) + 'px';
    confetti.style.height = (4 + Math.random() * 6) + 'px';
    container.appendChild(confetti);
  }

  setTimeout(() => {
    container.classList.add('hidden');
    container.innerHTML = '';
  }, 4000);
}

// ===== Complete Wizard =====
async function completeWizard() {
  try {
    // Save any remaining settings from step 5
    if (currentStep === 6) {
      await wizardAPI.invoke('wizard-complete');
      await addBubble('æ‰€æœ‰è®¾ç½®å·²ä¿å­˜ï¼å°Kä¼šä¸€ç›´é™ªç€ä½ çš„~ (^_^) çª—å£å³å°†å…³é—­...');
      setTimeout(() => {
        window.close();
      }, 2000);
    }
  } catch (err) {
    await addBubble('ä¿å­˜å‡ºé”™äº†: ' + err.message + ' (T_T)');
  }
}

// ===== Init =====
async function init() {
  // Load existing config
  try {
    const config = await wizardAPI.invoke('wizard-get-config');
    if (config.channels && Object.keys(config.channels).length > 0) {
      stepData.channels = { ...stepData.channels, ...config.channels };
    }
    stepData.lyricsEnabled = config.lyricsEnabled !== false;
    stepData.alwaysOnTop = config.alwaysOnTop !== false;

    // Resume from saved wizard step
    const savedStep = config.wizardStep || 0;
    if (savedStep > 0 && savedStep < totalSteps) {
      currentStep = savedStep;
      maxVisitedStep = savedStep;
    }
  } catch (e) { /* use defaults */ }

  updateProgress();
  await renderStep(currentStep);
}

init();
</script>
</body>
</html>
